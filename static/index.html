<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Market Brain v6</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Barlow+Condensed:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#03030a;color:#dde0ff;font-family:'DM Mono','Courier New',monospace;height:100vh;overflow:hidden;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:#0a0a14;}::-webkit-scrollbar-thumb{background:#1a1a2e;border-radius:2px;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px #00b0ff22}50%{box-shadow:0 0 40px #00b0ff44}}
.fade{animation:fadeIn 0.25s ease;}
input{outline:none;font-family:inherit;}
button{font-family:inherit;cursor:pointer;}
.hero-btn{transition:all 0.2s;}
.hero-btn:hover{transform:translateY(-2px);}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef,useMemo}=React;

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API="";
const api=async(path,opts={})=>{
  const token=localStorage.getItem("mb_token");
  const headers={"Content-Type":"application/json",...(token?{Authorization:`Bearer ${token}`}:{})};
  const res=await fetch(API+path,{headers,...opts});
  const j=await res.json();
  if(!res.ok) throw new Error(j.detail||"Request failed");
  return j;
};
async function fetchLivePrices(tickers){
  try{
    const chunks=[];for(let i=0;i<tickers.length;i+=40)chunks.push(tickers.slice(i,i+40));
    const results={};
    for(const chunk of chunks){const j=await api(`/api/prices?symbols=${chunk.join(",")}`);Object.assign(results,j.data||{});}
    return Object.keys(results).length>0?results:null;
  }catch(e){return null;}
}
async function fetchFxRates(){
  try{
    const pairs="GBPUSD=X,GBPEUR=X,GBPJPY=X,GBPCAD=X,GBPAUD=X,GBPCHF=X,GBPINR=X,GBPSGD=X,GBPHKD=X";
    const j=await api(`/api/prices?symbols=${pairs}`);
    if(!j.data) return null;
    const rates={GBP:1.0};
    const map={"GBPUSD=X":"USD","GBPEUR=X":"EUR","GBPJPY=X":"JPY","GBPCAD=X":"CAD","GBPAUD=X":"AUD","GBPCHF=X":"CHF","GBPINR=X":"INR","GBPSGD=X":"SGD","GBPHKD=X":"HKD"};
    Object.entries(map).forEach(([sym,code])=>{const d=j.data[sym];if(d?.price)rates[code]=parseFloat(d.price);});
    return rates;
  }catch(e){return null;}
}
async function fetchTechnicals(tickers){
  try{
    const chunks=[];for(let i=0;i<tickers.length;i+=40)chunks.push(tickers.slice(i,i+40));
    const results={};
    for(const chunk of chunks){
      const j=await api(`/api/technicals?symbols=${chunk.join(",")}`);
      Object.assign(results,j.data||{});
    }
    return Object.keys(results).length>0?results:null;
  }catch(e){return null;}
}
async function fetchResearch(ticker, name){
  try{
    const url=`/api/research?symbol=${encodeURIComponent(ticker)}&name=${encodeURIComponent(name||ticker)}`;
    const r=await fetch(url);
    if(!r.ok) return null;
    const d=await r.json();
    // If pending (background sweep triggered), poll once after 8s
    if(d._served_from==="pending"){
      await new Promise(res=>setTimeout(res,8000));
      const r2=await fetch(url);
      if(r2.ok) return await r2.json();
    }
    return d;
  }catch(e){
    console.warn("Research unavailable",e);
    return null;
  }
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CURRENCIES=[
  {code:"GBP",symbol:"¬£",flag:"üá¨üáß",name:"British Pound",fb:1.00},
  {code:"USD",symbol:"$",flag:"üá∫üá∏",name:"US Dollar",fb:1.27},
  {code:"EUR",symbol:"‚Ç¨",flag:"üá™üá∫",name:"Euro",fb:1.17},
  {code:"JPY",symbol:"¬•",flag:"üáØüáµ",name:"Japanese Yen",fb:192.5},
  {code:"CAD",symbol:"C$",flag:"üá®üá¶",name:"Canadian Dollar",fb:1.72},
  {code:"AUD",symbol:"A$",flag:"üá¶üá∫",name:"Australian Dollar",fb:1.95},
  {code:"CHF",symbol:"Fr",flag:"üá®üá≠",name:"Swiss Franc",fb:1.13},
  {code:"INR",symbol:"‚Çπ",flag:"üáÆüá≥",name:"Indian Rupee",fb:105.8},
  {code:"SGD",symbol:"S$",flag:"üá∏üá¨",name:"Singapore Dollar",fb:1.71},
  {code:"HKD",symbol:"HK$",flag:"üá≠üá∞",name:"Hong Kong Dollar",fb:9.93},
];

// Derive priceRange and vol from cap/sector for assets loaded from universe
function deriveAssetMeta(a){
  const sector=a.sector||"";
  const cap=a.cap||"Mid";
  // vol by cap tier
  const volMap={Nano:"Extreme",Micro:"VHigh",Small:"High",Mid:"Med",Large:"Low"};
  // override vol for inherently volatile sectors
  let vol=volMap[cap]||"Med";
  if(sector==="Crypto") vol="Extreme";
  else if(sector==="Forex") vol="Low";
  // priceRange: wide defaults ‚Äî live price overrides this anyway
  const priceRangeMap={Nano:[0.1,5],Micro:[1,20],Small:[2,50],Mid:[20,200],Large:[50,600]};
  if(sector==="Crypto") return{...a,vol,priceRange:[0.01,100000]};
  if(sector==="Forex") return{...a,vol,priceRange:[0.5,200]};
  return{...a,vol,priceRange:priceRangeMap[cap]||[10,200]};
}

async function fetchUniverse(){
  try{
    const j=await api("/api/universe");
    if(j.assets&&j.assets.length>0) return j.assets.map(deriveAssetMeta);
  }catch(e){}
  return null;
}

// Fallback static list (used only if /api/universe fails)
const ASSETS_FALLBACK=[
  {ticker:"NVDA",name:"NVIDIA",sector:"Technology",sub:"Semiconductors",cap:"Large",priceRange:[100,200],vol:"Low"},
  {ticker:"AMD",name:"AMD",sector:"Technology",sub:"Semiconductors",cap:"Large",priceRange:[80,180],vol:"Med"},
  {ticker:"INTC",name:"Intel",sector:"Technology",sub:"Semiconductors",cap:"Large",priceRange:[18,45],vol:"Med"},
  {ticker:"MSFT",name:"Microsoft",sector:"Technology",sub:"Software",cap:"Large",priceRange:[300,500],vol:"Low"},
  {ticker:"GOOGL",name:"Alphabet",sector:"Technology",sub:"Software",cap:"Large",priceRange:[140,200],vol:"Low"},
  {ticker:"META",name:"Meta Platforms",sector:"Technology",sub:"Social Media",cap:"Large",priceRange:[300,600],vol:"Med"},
  {ticker:"AAPL",name:"Apple",sector:"Technology",sub:"Hardware",cap:"Large",priceRange:[150,230],vol:"Low"},
  {ticker:"SOUN",name:"SoundHound AI",sector:"Technology",sub:"AI / ML",cap:"Micro",priceRange:[3,18],vol:"VHigh"},
  {ticker:"BBAI",name:"BigBear.ai",sector:"Technology",sub:"AI / ML",cap:"Micro",priceRange:[1,8],vol:"VHigh"},
  {ticker:"CRWD",name:"CrowdStrike",sector:"Technology",sub:"Cybersecurity",cap:"Large",priceRange:[200,380],vol:"Med"},
  {ticker:"PANW",name:"Palo Alto Networks",sector:"Technology",sub:"Cybersecurity",cap:"Large",priceRange:[150,400],vol:"Med"},
  {ticker:"IONQ",name:"IonQ",sector:"Technology",sub:"Quantum",cap:"Small",priceRange:[6,40],vol:"High"},
  {ticker:"QUBT",name:"Quantum Computing",sector:"Technology",sub:"Quantum",cap:"Nano",priceRange:[0.5,8],vol:"Extreme"},
  {ticker:"MRNA",name:"Moderna",sector:"Healthcare",sub:"Pharma",cap:"Mid",priceRange:[35,130],vol:"High"},
  {ticker:"PFE",name:"Pfizer",sector:"Healthcare",sub:"Pharma",cap:"Large",priceRange:[20,50],vol:"Low"},
  {ticker:"JNJ",name:"Johnson & Johnson",sector:"Healthcare",sub:"Pharma",cap:"Large",priceRange:[140,175],vol:"Low"},
  {ticker:"RXRX",name:"Recursion Pharma",sector:"Healthcare",sub:"Biotech",cap:"Small",priceRange:[3,20],vol:"High"},
  {ticker:"NTLA",name:"Intellia",sector:"Healthcare",sub:"CRISPR",cap:"Small",priceRange:[10,55],vol:"High"},
  {ticker:"ISRG",name:"Intuitive Surgical",sector:"Healthcare",sub:"MedTech",cap:"Large",priceRange:[300,450],vol:"Low"},
  {ticker:"XOM",name:"ExxonMobil",sector:"Energy",sub:"Oil & Gas",cap:"Large",priceRange:[95,130],vol:"Low"},
  {ticker:"BP",name:"BP plc",sector:"Energy",sub:"Oil & Gas",cap:"Large",priceRange:[25,45],vol:"Low"},
  {ticker:"CVX",name:"Chevron",sector:"Energy",sub:"Oil & Gas",cap:"Large",priceRange:[130,175],vol:"Low"},
  {ticker:"PLUG",name:"Plug Power",sector:"Energy",sub:"Hydrogen",cap:"Small",priceRange:[1,15],vol:"VHigh"},
  {ticker:"FSLR",name:"First Solar",sector:"Energy",sub:"Solar",cap:"Mid",priceRange:[100,250],vol:"Med"},
  {ticker:"NEE",name:"NextEra Energy",sector:"Energy",sub:"Renewables",cap:"Large",priceRange:[50,85],vol:"Low"},
  {ticker:"GLD",name:"SPDR Gold ETF",sector:"Metals",sub:"Gold",cap:"Large",priceRange:[170,230],vol:"Low"},
  {ticker:"SLV",name:"iShares Silver ETF",sector:"Metals",sub:"Silver",cap:"Mid",priceRange:[20,35],vol:"Med"},
  {ticker:"GFI",name:"Gold Fields",sector:"Metals",sub:"Gold Miners",cap:"Mid",priceRange:[10,20],vol:"Med"},
  {ticker:"FCX",name:"Freeport-McMoRan",sector:"Metals",sub:"Copper",cap:"Large",priceRange:[35,60],vol:"Med"},
  {ticker:"NUE",name:"Nucor Steel",sector:"Metals",sub:"Steel",cap:"Large",priceRange:[120,180],vol:"Med"},
  {ticker:"LAC",name:"Lithium Americas",sector:"Minerals",sub:"Lithium",cap:"Small",priceRange:[2,20],vol:"VHigh"},
  {ticker:"ALB",name:"Albemarle",sector:"Minerals",sub:"Lithium",cap:"Mid",priceRange:[40,150],vol:"High"},
  {ticker:"UEC",name:"Uranium Energy",sector:"Minerals",sub:"Uranium",cap:"Small",priceRange:[4,12],vol:"High"},
  {ticker:"NNE",name:"Nano Nuclear Energy",sector:"Minerals",sub:"Nuclear",cap:"Micro",priceRange:[5,45],vol:"Extreme"},
  {ticker:"BHP",name:"BHP Group",sector:"Minerals",sub:"Diversified Mining",cap:"Large",priceRange:[40,70],vol:"Low"},
  {ticker:"RIO",name:"Rio Tinto",sector:"Minerals",sub:"Diversified Mining",cap:"Large",priceRange:[55,80],vol:"Low"},
  {ticker:"VALE",name:"Vale SA",sector:"Minerals",sub:"Iron Ore",cap:"Large",priceRange:[10,20],vol:"Med"},
  {ticker:"BTC-USD",name:"Bitcoin",sector:"Crypto",sub:"Layer 1",cap:"Large",priceRange:[25000,100000],vol:"Extreme"},
  {ticker:"ETH-USD",name:"Ethereum",sector:"Crypto",sub:"Layer 1",cap:"Large",priceRange:[1500,5000],vol:"Extreme"},
  {ticker:"SOL-USD",name:"Solana",sector:"Crypto",sub:"Layer 1",cap:"Mid",priceRange:[20,250],vol:"Extreme"},
  {ticker:"XRP-USD",name:"XRP",sector:"Crypto",sub:"Payments",cap:"Large",priceRange:[0.3,3],vol:"Extreme"},
  {ticker:"DOGE-USD",name:"Dogecoin",sector:"Crypto",sub:"Meme",cap:"Mid",priceRange:[0.05,0.5],vol:"Extreme"},
  {ticker:"COIN",name:"Coinbase",sector:"Crypto",sub:"Exchange",cap:"Mid",priceRange:[100,330],vol:"VHigh"},
  {ticker:"MSTR",name:"MicroStrategy",sector:"Crypto",sub:"BTC Treasury",cap:"Mid",priceRange:[100,600],vol:"Extreme"},
  {ticker:"EURUSD=X",name:"EUR/USD",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[1.05,1.15],vol:"Low"},
  {ticker:"GBPUSD=X",name:"GBP/USD",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[1.22,1.32],vol:"Low"},
  {ticker:"USDJPY=X",name:"USD/JPY",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[130,155],vol:"Low"},
  {ticker:"USDCAD=X",name:"USD/CAD",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[1.30,1.40],vol:"Low"},
  {ticker:"RKLB",name:"Rocket Lab USA",sector:"Space",sub:"Launch",cap:"Small",priceRange:[4,26],vol:"High"},
  {ticker:"ASTS",name:"AST SpaceMobile",sector:"Space",sub:"Satellite",cap:"Small",priceRange:[5,40],vol:"VHigh"},
  {ticker:"LMT",name:"Lockheed Martin",sector:"Space",sub:"Defence",cap:"Large",priceRange:[400,550],vol:"Low"},
  {ticker:"AMZN",name:"Amazon",sector:"Consumer",sub:"E-Commerce",cap:"Large",priceRange:[120,220],vol:"Med"},
  {ticker:"TSLA",name:"Tesla",sector:"Consumer",sub:"EV",cap:"Large",priceRange:[150,400],vol:"High"},
  {ticker:"NFLX",name:"Netflix",sector:"Consumer",sub:"Streaming",cap:"Large",priceRange:[400,800],vol:"Med"},
  {ticker:"GME",name:"GameStop",sector:"Consumer",sub:"Gaming",cap:"Small",priceRange:[8,30],vol:"Extreme"},
  {ticker:"NKE",name:"Nike",sector:"Consumer",sub:"Apparel",cap:"Large",priceRange:[70,120],vol:"Low"},
  {ticker:"JPM",name:"JPMorgan Chase",sector:"Finance",sub:"Banking",cap:"Large",priceRange:[150,230],vol:"Low"},
  {ticker:"GS",name:"Goldman Sachs",sector:"Finance",sub:"Banking",cap:"Large",priceRange:[350,550],vol:"Med"},
  {ticker:"V",name:"Visa",sector:"Finance",sub:"Payments",cap:"Large",priceRange:[220,310],vol:"Low"},
  {ticker:"SOFI",name:"SoFi Technologies",sector:"Finance",sub:"Fintech",cap:"Small",priceRange:[5,22],vol:"High"},
  {ticker:"UPST",name:"Upstart Holdings",sector:"Finance",sub:"Fintech",cap:"Small",priceRange:[10,80],vol:"VHigh"},
  {ticker:"ADM",name:"Archer-Daniels",sector:"Agriculture",sub:"Grain",cap:"Large",priceRange:[45,80],vol:"Low"},
  {ticker:"DE",name:"John Deere",sector:"Agriculture",sub:"Machinery",cap:"Large",priceRange:[350,500],vol:"Low"},
];
const CAP_TIERS={Nano:0,Micro:1,Small:2,Mid:3,Large:4};
const CAP_COLORS={Nano:"#ea80fc",Micro:"#ff6d00",Small:"#ffd600",Mid:"#00e676",Large:"#00b0ff"};
const RISK_CFG={CRITICAL:{label:"CRITICAL",color:"#ff1744",bg:"#160004"},HIGH:{label:"HIGH",color:"#ff6d00",bg:"#160900"},MODERATE:{label:"MODERATE",color:"#ffd600",bg:"#141000"},POSITIVE:{label:"OPPORTUNITY",color:"#00e676",bg:"#00160a"},STRONG:{label:"STRONG",color:"#00b0ff",bg:"#00091a"}};
const TF_PROFILES={"‚ö° Intraday":{short:"0-24h",color:"#ff6d00",icon:"‚ö°",simDays:0.5},"üìà Short Swing":{short:"2-5d",color:"#ffd600",icon:"üìà",simDays:3.5},"üåä Medium Swing":{short:"1-4wk",color:"#00d4ff",icon:"üåä",simDays:17.5},"üèîÔ∏è Position":{short:"1-6mo",color:"#00e676",icon:"üèîÔ∏è",simDays:105},"üå≥ Long Term":{short:"6mo+",color:"#aed581",icon:"üå≥",simDays:548}};
const TF_KEYS=Object.keys(TF_PROFILES);
const WATCH_DURATIONS=[{label:"24 hours",ms:86400000,tf:"‚ö° Intraday"},{label:"3 days",ms:259200000,tf:"üìà Short Swing"},{label:"5 days",ms:432000000,tf:"üìà Short Swing"},{label:"1 week",ms:604800000,tf:"üåä Medium Swing"},{label:"2 weeks",ms:1209600000,tf:"üåä Medium Swing"},{label:"1 month",ms:2592000000,tf:"üèîÔ∏è Position"},{label:"3 months",ms:7776000000,tf:"üèîÔ∏è Position"},{label:"6 months",ms:15552000000,tf:"üå≥ Long Term"}];
const CAPS=["All","Nano","Micro","Small","Mid","Large"];
// SECTORS computed dynamically from loaded assets

// ‚îÄ‚îÄ SIGNALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sr(seed,min,max){const x=Math.sin(seed+1)*10000;return min+(x-Math.floor(x))*(max-min);}

function generateSignals(asset,key,techData){
  const s=asset.ticker.split("").reduce((a,c)=>a+c.charCodeAt(0),0)+key;
  const r=(min,max,o=0)=>sr(s+o,min,max);
  const capTier=CAP_TIERS[asset.cap]??2;
  const volMod={Low:0.6,Med:0.8,High:1.0,VHigh:1.2,Extreme:1.5}[asset.vol]||1;

  // Use real technicals if available, fall back to simulated
  const tech=techData?.[asset.ticker];
  const rsi         = tech?.rsi           ?? r(18,82,1);
  const macd        = tech?.macd          ?? r(-1,1,2);
  const volume      = tech?.volume_ratio  ?? r(0.4,4.0,3);
  const priceVsMA50 = tech?.price_vs_ma50 ?? r(-30,40,7);
  const priceVsMA200= tech?.price_vs_ma200?? r(-40,50,8);
  const realTech    = !!tech;

  // Still simulated (no data source yet)
  const sentiment=r(-1,1,4);
  const shortInt=r(0,35,5),earningsBeat=r(-25,40,6);
  const insiderBuy=r(0,1,9),catalystNews=r(-1,1,10),sectorFlow=r(-1,1,11);
  const daysToEarnings=r(0,90,13),debtRatio=r(0,3,14),revGrowth=r(-20,120,15);

  let score=0;
  score+=rsi<30?22:rsi>72?-18:(50-rsi)*0.3;
  score+=macd*18;score+=(volume-1)*10;score+=sentiment*22;
  score+=shortInt>25?-18:shortInt<5?12:0;
  score+=earningsBeat*0.5;score+=priceVsMA50<-20?14:priceVsMA50>30?-10:0;
  score+=insiderBuy>0.7?18:0;score+=catalystNews*18;score+=sectorFlow*12;
  score+=revGrowth>50?18:revGrowth<-10?-12:0;score+=debtRatio>2?-14:0;
  if(asset.sector==="Technology")score+=sectorFlow>0.3?15:0;
  if(asset.sub==="Uranium"||asset.sub==="Nuclear")score+=18;
  if(asset.sector==="Space")score+=12;
  if(asset.sector==="Crypto")score+=r(0,1,34)>0.5?18:-14;
  if(asset.sector==="Metals")score+=r(0,1,35)>0.4?10:0;
  if(asset.sector==="Forex")score=score*0.4;
  score=Math.max(-100,Math.min(100,score));
  const risk=score<-55?"CRITICAL":score<-15?"HIGH":score<18?"MODERATE":score<55?"POSITIVE":"STRONG";
  const price=sr(s+42,asset.priceRange[0],asset.priceRange[1]);
  const stopPct=capTier<=1?0.15:capTier===2?0.10:asset.sector==="Forex"?0.02:0.07;
  const maxUpside=capTier===0?400:capTier===1?200:capTier===2?100:capTier===3?50:asset.sector==="Crypto"?200:30;
  const upsidePct=score>0?(score/100)*maxUpside:0;
  const rrRatio=stopPct>0?((upsidePct/100)/stopPct).toFixed(1):"0";
  const entryQ=rsi<35&&priceVsMA50<-10?"IDEAL":rsi<50&&volume>1.2?"GOOD":rsi>68?"POOR":"FAIR";
  const tfScores={};
  tfScores["‚ö° Intraday"]=Math.max(5,Math.min(95,(Math.max(0,(volume-1.5)*35)+(shortInt>20&&volume>2?25:0)+(rsi>28&&rsi<52?12:0)+(catalystNews>0.5?20:0)+(macd>0.3?8:0)-(rsi>70?15:0))*volMod));
  tfScores["üìà Short Swing"]=Math.max(5,Math.min(95,(macd>0?22:0)+(rsi<45&&rsi>25?20:0)+(volume>1.3?15:0)+(earningsBeat>10?18:0)+(priceVsMA50<-10?12:0)+(catalystNews>0?10:0)-(debtRatio>2?10:0)));
  tfScores["üåä Medium Swing"]=Math.max(5,Math.min(95,(sectorFlow>0.2?22:0)+(revGrowth>20?20:0)+(macd>0?14:0)+(volume>1.1?10:0)+(priceVsMA200<-15?15:0)+(insiderBuy>0.5?12:0)+(daysToEarnings<30?14:0)-(debtRatio>2?12:0)));
  tfScores["üèîÔ∏è Position"]=Math.max(5,Math.min(95,(revGrowth>30?28:revGrowth>10?16:0)+(insiderBuy>0.65?22:0)+(debtRatio<1?18:debtRatio<2?8:0)+(sectorFlow>0.3?15:0)+(capTier>=2?10:0)));
  tfScores["üå≥ Long Term"]=Math.max(5,Math.min(95,(revGrowth>20?25:0)+(debtRatio<1.5?20:0)+(capTier>=3?22:capTier===2?12:0)+(insiderBuy>0.5?15:0)+(sectorFlow>0?10:0)));
  const bestTF=Object.entries(tfScores).sort((a,b)=>b[1]-a[1])[0][0];
  return{score:Math.round(score),risk,price:parseFloat(price.toFixed(4)),upsidePct:parseFloat(upsidePct.toFixed(1)),stopPct:parseFloat((stopPct*100).toFixed(1)),rrRatio,entryQ,tfScores,bestTF,livePrice:false,changePct:0,realTech,metrics:{rsi,macd,volume,sentiment,shortInt,revGrowth,debtRatio,daysToEarnings,priceVsMA50,priceVsMA200}};
}

function mergeLiveData(sig,liveData,asset){
  const live=liveData?.[asset.ticker];
  if(!live?.price) return sig;
  const realPrice=live.currency==="GBX"?live.price/100:live.price;
  const changeSign=live.change_pct>0?1:live.change_pct<0?-1:0;
  // Only nudge RSI if we don't have real technicals
  const rsiAdjusted=sig.realTech?sig.metrics.rsi:Math.max(10,Math.min(90,sig.metrics.rsi+(changeSign*8)));
  return{...sig,price:parseFloat(realPrice.toFixed(4)),livePrice:true,marketState:live.market_state||"CLOSED",currency:live.currency||"USD",changePct:live.change_pct||0,metrics:{...sig.metrics,rsi:rsiAdjusted}};
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmtPct=(n,d=1)=>n===undefined?"‚Äî":`${n>0?"+":""}${parseFloat(n).toFixed(d)}%`;
const pnlColor=v=>v>0?"#00e676":v<0?"#ff1744":"#888";
const uid=()=>Math.random().toString(36).slice(2,9);
const fmtMs=ms=>{if(ms<=0)return"expired";const h=Math.floor(ms/3600000),d=Math.floor(ms/86400000),w=Math.floor(d/7),mo=Math.floor(d/30);if(mo>=1)return`${mo}mo`;if(w>=1)return`${w}wk`;if(d>=1)return`${d}d`;return`${h}h`;};
const Tag=({children,color="#888",small})=>(<span style={{fontSize:small?6:8,color,border:`1px solid ${color}44`,borderRadius:3,padding:small?"0 3px":"1px 5px",letterSpacing:1,whiteSpace:"nowrap"}}>{children}</span>);
const Pill=({label,active,color="#00b0ff",onClick})=>(<button onClick={onClick} style={{background:active?"#12121e":"transparent",border:`1px solid ${active?color:"#1a1a2e"}`,borderRadius:20,padding:"3px 10px",color:active?color:"#2a2a45",fontSize:9,whiteSpace:"nowrap"}}>{label}</button>);
const Stat=({label,value,color="#c0c0e0",sub})=>(<div style={{background:"#0a0a16",borderRadius:6,padding:"8px 10px",textAlign:"center"}}><div style={{fontSize:7,color:"#2a2a40",letterSpacing:2,marginBottom:2}}>{label}</div><div style={{fontSize:13,fontWeight:700,color,fontFamily:"monospace"}}>{value}</div>{sub&&<div style={{fontSize:7,color:"#3a3a50",marginTop:1}}>{sub}</div>}</div>);
const Modal=({onClose,children,maxWidth=460})=>(<div style={{position:"fixed",inset:0,background:"#000000dd",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:12}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{background:"#06060f",borderRadius:12,maxWidth,width:"100%",maxHeight:"92vh",overflowY:"auto"}}>{children}</div></div>);

// ‚îÄ‚îÄ WELCOME / AUTH PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function WelcomePage({onAuth}){
  const[mode,setMode]=useState("home");
  const[form,setForm]=useState({name:"",email:"",password:""});
  const[error,setError]=useState("");
  const[loading,setLoading]=useState(false);
  const set=k=>e=>setForm(p=>({...p,[k]:e.target.value}));

  const submit=async()=>{
    setError("");setLoading(true);
    try{
      if(mode==="signup"){
        if(!form.name.trim())throw new Error("Name is required");
        if(!form.email.includes("@"))throw new Error("Valid email required");
        if(form.password.length<6)throw new Error("Password must be 6+ characters");
        const j=await api("/api/auth/register",{method:"POST",body:JSON.stringify({name:form.name,email:form.email,password:form.password})});
        localStorage.setItem("mb_token",j.token);onAuth(j.user);
      }else{
        const j=await api("/api/auth/login",{method:"POST",body:JSON.stringify({email:form.email,password:form.password})});
        localStorage.setItem("mb_token",j.token);onAuth(j.user);
      }
    }catch(e){setError(e.message);}
    setLoading(false);
  };

  if(mode==="home") return(
    <div style={{minHeight:"100vh",background:"#03030a",display:"flex",flexDirection:"column",overflow:"auto"}}>
      <div style={{padding:"16px 24px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #0c0c18"}}>
        <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:900,letterSpacing:4,color:"#dde0ff"}}>MARKET <span style={{color:"#00b0ff"}}>BRAIN</span></div>
        <div style={{display:"flex",gap:8}}>
          <button onClick={()=>setMode("login")} style={{background:"transparent",border:"1px solid #1a1a2e",borderRadius:6,padding:"7px 16px",color:"#8a8aaa",fontSize:10,letterSpacing:1}}>LOG IN</button>
          <button onClick={()=>setMode("signup")} className="hero-btn" style={{background:"#00b0ff22",border:"1px solid #00b0ff",borderRadius:6,padding:"7px 16px",color:"#00b0ff",fontSize:10,letterSpacing:1}}>SIGN UP FREE</button>
        </div>
      </div>
      <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 24px",textAlign:"center"}}>
        <div style={{fontSize:11,color:"#00b0ff",letterSpacing:4,marginBottom:16,fontFamily:"monospace"}}>‚óè LIVE YAHOO FINANCE ¬∑ REAL TECHNICAL INDICATORS</div>
        <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:64,fontWeight:900,lineHeight:1,marginBottom:16,letterSpacing:2}}>
          <span style={{color:"#dde0ff"}}>TRADE SMARTER.</span><br/>
          <span style={{background:"linear-gradient(90deg,#00b0ff,#00e676)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>WITHOUT THE RISK.</span>
        </div>
        <div style={{fontSize:13,color:"#5a5a7a",maxWidth:480,lineHeight:1.8,marginBottom:40}}>
          Market Brain gives you real-time signal analysis across 60+ assets ‚Äî stocks, crypto, forex, metals and more. Practice virtual trading, time your watchlist predictions, and track your accuracy over time.
        </div>
        <div style={{display:"flex",gap:12,flexWrap:"wrap",justifyContent:"center",marginBottom:60}}>
          <button onClick={()=>setMode("signup")} className="hero-btn" style={{background:"linear-gradient(135deg,#00b0ff,#0080cc)",border:"none",borderRadius:8,padding:"14px 32px",color:"#fff",fontSize:12,letterSpacing:2,fontWeight:700,boxShadow:"0 0 40px #00b0ff44"}}>GET STARTED FREE ‚Üí</button>
          <button onClick={()=>setMode("login")} className="hero-btn" style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:8,padding:"14px 32px",color:"#8a8aaa",fontSize:12,letterSpacing:2}}>I HAVE AN ACCOUNT</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:12,maxWidth:860,width:"100%"}}>
          {[{icon:"üìä",title:"60+ Assets",desc:"Stocks, crypto, forex, metals, minerals and more with live Yahoo Finance prices"},{icon:"üéØ",title:"Real Technicals",desc:"RSI, MACD, volume ratio and MA distance calculated from real 6-month price data"},{icon:"üíº",title:"Virtual Portfolio",desc:"Practice with a virtual budget. Place trades, track P&L, and close positions"},{icon:"‚òÖ",title:"Timed Watchlist",desc:"Watch assets for set periods and score the engine's prediction accuracy"},{icon:"üìà",title:"Accuracy Tracker",desc:"Overall win rate broken down by cap size, sector, and timeframe"},{icon:"üî¥",title:"Live Prices",desc:"Real-time prices with live FX conversion to your preferred currency"}].map(f=>(<div key={f.title} style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:"16px",textAlign:"left"}}><div style={{fontSize:24,marginBottom:8}}>{f.icon}</div><div style={{fontSize:12,fontWeight:700,color:"#dde0ff",marginBottom:4}}>{f.title}</div><div style={{fontSize:10,color:"#4a4a6a",lineHeight:1.7}}>{f.desc}</div></div>))}
        </div>
      </div>
      <div style={{padding:"16px",textAlign:"center",fontSize:8,color:"#1a1a28",borderTop:"1px solid #0c0c18"}}>Market Brain ¬∑ Virtual simulation only ¬∑ Not financial advice</div>
    </div>
  );

  const isSignup=mode==="signup";
  return(
    <div style={{minHeight:"100vh",background:"#03030a",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:20}}>
      <div style={{width:"100%",maxWidth:400,animation:"fadeIn 0.3s ease"}}>
        <div style={{textAlign:"center",marginBottom:32}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:28,fontWeight:900,letterSpacing:4,color:"#dde0ff",marginBottom:4}}>MARKET <span style={{color:"#00b0ff"}}>BRAIN</span></div>
          <div style={{fontSize:11,color:"#4a4a6a"}}>{isSignup?"Create your free account":"Welcome back"}</div>
        </div>
        <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:12,padding:28,animation:"glow 3s infinite"}}>
          {isSignup&&(<div style={{marginBottom:14}}><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:5}}>YOUR NAME</div><input value={form.name} onChange={set("name")} placeholder="John Smith" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:6,padding:"10px 12px",color:"#c0c0e0",fontSize:13}}/></div>)}
          <div style={{marginBottom:14}}><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:5}}>EMAIL</div><input value={form.email} onChange={set("email")} placeholder="you@example.com" type="email" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:6,padding:"10px 12px",color:"#c0c0e0",fontSize:13}}/></div>
          <div style={{marginBottom:20}}><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:5}}>PASSWORD</div><input value={form.password} onChange={set("password")} placeholder={isSignup?"At least 6 characters":"Your password"} type="password" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:6,padding:"10px 12px",color:"#c0c0e0",fontSize:13}} onKeyDown={e=>e.key==="Enter"&&submit()}/></div>
          {error&&<div style={{background:"#ff174420",border:"1px solid #ff174444",borderRadius:6,padding:"8px 12px",fontSize:10,color:"#ff6a6a",marginBottom:14}}>{error}</div>}
          <button onClick={submit} disabled={loading} style={{width:"100%",background:loading?"#1a1a2e":"linear-gradient(135deg,#00b0ff,#0080cc)",border:"none",borderRadius:8,padding:"12px",color:loading?"#3a3a50":"#fff",fontSize:11,letterSpacing:2,fontWeight:700}}>{loading?"LOADING...":(isSignup?"CREATE ACCOUNT":"LOG IN")}</button>
          <div style={{textAlign:"center",marginTop:16,fontSize:9,color:"#4a4a6a"}}>{isSignup?"Already have an account? ":"Don't have an account? "}<span onClick={()=>{setMode(isSignup?"login":"signup");setError("");}} style={{color:"#00b0ff",cursor:"pointer"}}>{isSignup?"Log in":"Sign up free"}</span></div>
        </div>
        <button onClick={()=>setMode("home")} style={{display:"block",margin:"16px auto 0",background:"none",border:"none",color:"#3a3a55",fontSize:9}}>‚Üê Back to home</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ TRADE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TradeModal({asset,sig,balance,fmtMoney,toLocal,onPlace,onClose}){
  const R=RISK_CFG[sig.risk];
  const[shares,setShares]=useState("");
  const[tf,setTf]=useState(sig.bestTF);
  const[stopPct,setStopPct]=useState(sig.stopPct);
  const[targetPct,setTargetPct]=useState(sig.upsidePct);
  const priceLocal=toLocal(sig.price);
  const sym=fmtMoney(sig.price).replace(/[\d.,]/g,"").trim()||"$";
  const sharesN=parseFloat(shares)||0;
  const totalCost=sharesN*priceLocal;
  const rr=parseFloat(stopPct)>0?(parseFloat(targetPct)/parseFloat(stopPct)).toFixed(1):"‚Äî";
  const rrOk=parseFloat(rr)>=2;
  const pctBal=balance>0?(totalCost/balance)*100:0;
  const risk2=balance*0.02;
  const suggested=parseFloat(stopPct)>0&&priceLocal>0?Math.floor(risk2/(priceLocal*parseFloat(stopPct)/100)):0;
  const canPlace=sharesN>0&&totalCost<=balance;
  return(
    <Modal onClose={onClose} maxWidth={480}>
      <div style={{background:"#0a0a16",borderBottom:`1px solid ${R.color}44`,padding:"14px 16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2}}>VIRTUAL TRADE</div><div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:700,color:"#dde0ff"}}>{asset.ticker}</div></div>
        <div style={{textAlign:"right"}}><div style={{fontSize:16,fontWeight:700,fontFamily:"monospace",color:"#dde0ff"}}>{fmtMoney(sig.price)}</div><Tag color={R.color}>{R.label}</Tag></div>
      </div>
      <div style={{padding:"14px 16px"}}>
        <div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:6}}>TIMEFRAME</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5,marginBottom:14}}>
          {TF_KEYS.map(k=>{const p=TF_PROFILES[k],sc=sig.tfScores[k];const pc=sc>=72?"#00e676":sc>=52?"#00d4ff":sc>=35?"#ffd600":"#ff6d00";const isA=tf===k;return(<div key={k} onClick={()=>setTf(k)} style={{background:isA?p.color+"22":"#0a0a16",border:`1px solid ${isA?p.color:"#1a1a2e"}`,borderRadius:6,padding:"8px",cursor:"pointer",display:"flex",justifyContent:"space-between"}}><span style={{fontSize:9,color:isA?p.color:"#5a5a7a",fontWeight:700}}>{p.icon} {p.short}</span><span style={{fontSize:9,color:pc,fontWeight:700}}>{sc.toFixed(0)}%</span></div>);})}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
          {[["STOP LOSS %",stopPct,setStopPct],["TARGET %",targetPct,setTargetPct]].map(([l,v,set])=>(<div key={l}><div style={{fontSize:8,color:"#2a2a40",marginBottom:4}}>{l}</div><input value={v} onChange={e=>set(e.target.value)} style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:5,padding:"6px 8px",color:"#c0c0e0",fontSize:12}}/></div>))}
        </div>
        <div style={{marginBottom:10}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:8,color:"#2a2a40"}}>QUANTITY</span><button onClick={()=>setShares(suggested.toString())} style={{fontSize:8,color:"#00b0ff",background:"none",border:"none"}}>Use 2% rule ({suggested})</button></div>
          <input value={shares} onChange={e=>setShares(e.target.value)} placeholder="Enter quantity" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:5,padding:"7px 10px",color:"#c0c0e0",fontSize:13}}/>
        </div>
        <div style={{background:"#0a0a16",borderRadius:7,padding:10,marginBottom:12}}>
          {[["Balance",`${sym}${balance.toFixed(2)}`,"#c0c0e0"],["Total Cost",sharesN>0?`${sym}${totalCost.toFixed(2)}`:"‚Äî",pctBal>30?"#ff6d00":"#c0c0e0"],["% of Account",sharesN>0?`${pctBal.toFixed(1)}%`:"‚Äî",pctBal>30?"#ff6d00":"#c0c0e0"],["R/R",`${rr}:1`,rrOk?"#00e676":"#ffd600"],["Max Loss",sharesN>0?`-${sym}${(totalCost*parseFloat(stopPct)/100).toFixed(2)}`:"‚Äî","#ff1744"],["Max Gain",sharesN>0?`+${sym}${(totalCost*parseFloat(targetPct)/100).toFixed(2)}`:"‚Äî","#00e676"]].map(([l,v,c])=>(<div key={l} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid #0e0e18",fontSize:10}}><span style={{color:"#4a4a6a"}}>{l}</span><span style={{color:c,fontWeight:700,fontFamily:"monospace"}}>{v}</span></div>))}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <button onClick={onClose} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:6,padding:"10px",color:"#4a4a6a",fontSize:9}}>CANCEL</button>
          <button onClick={()=>{if(!canPlace)return;onPlace({id:uid(),ticker:asset.ticker,name:asset.name,sector:asset.sector,cap:asset.cap,timeframe:tf,tfScore:sig.tfScores[tf],entryPrice:priceLocal,shares:sharesN,totalCost:parseFloat(totalCost.toFixed(2)),stopPct:parseFloat(stopPct),targetPct:parseFloat(targetPct),signalScore:sig.score,signalRisk:sig.risk,rr:parseFloat(rr),entryQ:sig.entryQ,openedAt:Date.now(),status:"open"});onClose();}} disabled={!canPlace}
            style={{background:canPlace?R.color+"22":"#1a1a2e",border:`1px solid ${canPlace?R.color:"#2a2a40"}`,borderRadius:6,padding:"10px",color:canPlace?R.color:"#3a3a50",fontSize:9,letterSpacing:1}}>PLACE TRADE</button>
        </div>
        <div style={{fontSize:7,color:"#1a1a28",textAlign:"center",marginTop:8}}>Virtual simulation only. Not financial advice.</div>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ WATCH MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function WatchModal({asset,sig,fmtMoney,onAdd,onClose}){
  const[dur,setDur]=useState(WATCH_DURATIONS[0]);
  const tfP=TF_PROFILES[dur.tf],tfScore=sig.tfScores[dur.tf];
  const s=asset.ticker.split("").reduce((a,c)=>a+c.charCodeAt(0),0);
  const bullBias=(sig.score/100)*0.6+(tfScore/100-0.5)*0.4;
  const volF={Low:0.003,Med:0.006,High:0.012,VHigh:0.018,Extreme:0.025}[asset.vol]||0.01;
  let predPrice=sig.price;
  for(let i=0;i<Math.max(1,Math.round(TF_PROFILES[dur.tf].simDays));i++){const rand=sr(s+i*17+99,-1,1);predPrice=predPrice*(1+bullBias*volF*0.5+rand*volF);}
  const predChg=((predPrice-sig.price)/sig.price)*100;
  const predColor=predChg>0?"#00e676":"#ff1744";
  return(
    <Modal onClose={onClose} maxWidth={420}>
      <div style={{background:"#0a0a16",borderBottom:"1px solid #ffd60033",padding:"14px 16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2}}>ADD TO WATCHLIST</div><div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:700,color:"#dde0ff"}}>{asset.ticker}</div></div>
        <div style={{fontFamily:"monospace",fontSize:15,fontWeight:700,color:"#dde0ff"}}>{fmtMoney(sig.price)}</div>
      </div>
      <div style={{padding:"14px 16px"}}>
        <div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:8}}>WATCH DURATION</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5,marginBottom:14}}>
          {WATCH_DURATIONS.map(d=>{const isA=dur.label===d.label;const p=TF_PROFILES[d.tf];return(<div key={d.label} onClick={()=>setDur(d)} style={{background:isA?p.color+"22":"#0a0a16",border:`1px solid ${isA?p.color:"#1a1a2e"}`,borderRadius:6,padding:"8px",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:10,color:isA?p.color:"#6a6a8a",fontWeight:700}}>{d.label}</span><Tag color={p.color} small>{p.icon}</Tag></div>);})}
        </div>
        <div style={{background:predColor+"10",border:`1px solid ${predColor}33`,borderRadius:8,padding:14,marginBottom:14}}>
          <div style={{fontSize:8,color:predColor,letterSpacing:2,marginBottom:8}}>ENGINE PROJECTION</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,textAlign:"center"}}>
            <div><div style={{fontSize:7,color:"#2a2a40",marginBottom:2}}>NOW</div><div style={{fontSize:12,fontWeight:700,fontFamily:"monospace",color:"#c0c0e0"}}>{fmtMoney(sig.price)}</div></div>
            <div><div style={{fontSize:7,color:"#2a2a40",marginBottom:2}}>PROJECTED</div><div style={{fontSize:12,fontWeight:700,fontFamily:"monospace",color:predColor}}>{fmtMoney(predPrice)}</div></div>
            <div><div style={{fontSize:7,color:"#2a2a40",marginBottom:2}}>MOVE</div><div style={{fontSize:12,fontWeight:700,fontFamily:"monospace",color:predColor}}>{fmtPct(predChg)}</div></div>
          </div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <button onClick={onClose} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:6,padding:"10px",color:"#4a4a6a",fontSize:9}}>CANCEL</button>
          <button onClick={()=>{onAdd({id:uid(),ticker:asset.ticker,name:asset.name,sector:asset.sector,cap:asset.cap,duration:dur.label,timeframe:dur.tf,tfScore,addedAt:Date.now(),expiresAt:Date.now()+dur.ms,entryPrice:sig.price,predictedPrice:parseFloat(predPrice.toFixed(4)),predictedChg:parseFloat(predChg.toFixed(2)),signalScore:sig.score,signalRisk:sig.risk,status:"watching"});onClose();}}
            style={{background:"#ffd60022",border:"1px solid #ffd600",borderRadius:6,padding:"10px",color:"#ffd600",fontSize:9,letterSpacing:1}}>START WATCHING</button>
        </div>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ ACCURACY ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcAccuracy(trades,watchItems){
  const closed=[...trades.filter(t=>t.status!=="open"),...watchItems.filter(w=>w.status==="expired")];
  if(!closed.length) return null;
  const score=item=>item.finalPnLPct!==undefined?item.finalPnLPct:(item.actualChg||0);
  const wins=closed.filter(t=>score(t)>0).length;
  const byCap={};CAPS.filter(c=>c!=="All").forEach(cap=>{const items=closed.filter(t=>t.cap===cap);if(items.length){const w=items.filter(t=>score(t)>0).length;byCap[cap]={wins:w,total:items.length,rate:(w/items.length)*100};}});
  const bySector={};[...new Set(closed.map(t=>t.sector))].forEach(sec=>{const items=closed.filter(t=>t.sector===sec);if(items.length){const w=items.filter(t=>score(t)>0).length;bySector[sec]={wins:w,total:items.length,rate:(w/items.length)*100};}});
  return{overall:(wins/closed.length)*100,wins,total:closed.length,losses:closed.length-wins,avgReturn:closed.reduce((a,t)=>a+score(t),0)/closed.length,byCap,bySector};
}

// ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function MainApp({user,onLogout}){
  const[view,setView]=useState("market");
  const[assets,setAssets]=useState(ASSETS_FALLBACK);
  const[allSigs,setAllSigs]=useState({});
  const[loading,setLoading]=useState(true);
  const[liveCount,setLiveCount]=useState(0);
  const[techCount,setTechCount]=useState(0);
  const[research,setResearch]=useState(null);
  const[researchTicker,setResearchTicker]=useState(null);
  const[researchLoading,setResearchLoading]=useState(false);
  const[fxRates,setFxRates]=useState(null);
  const[lastUpdated,setLastUpdated]=useState(null);
  const[selected,setSelected]=useState(null);
  const[activeSector,setActiveSector]=useState("All");
  const[activeCap,setActiveCap]=useState("All");
  const[sortMode,setSortMode]=useState("bestTF");
  const[searchQ,setSearchQ]=useState("");
  const[activeCurrency,setActiveCurrency]=useState(CURRENCIES[0]);
  const[showCurrModal,setShowCurrModal]=useState(false);
  const[showTradeModal,setShowTradeModal]=useState(false);
  const[showWatchModal,setShowWatchModal]=useState(false);
  const[trades,setTrades]=useState([]);
  const[balance,setBalance]=useState(1000);
  const[startBalance,setStartBalance]=useState(1000);
  const[budgetInput,setBudgetInput]=useState("1000");
  const[showBudget,setShowBudget]=useState(false);
  const[watchItems,setWatchItems]=useState([]);
  const[tick,setTick]=useState(0);
  const[saving,setSaving]=useState(false);
  useEffect(()=>{const t=setInterval(()=>setTick(s=>s+1),10000);return()=>clearInterval(t);},[]);


  // Load portfolio
  useEffect(()=>{
    api("/api/portfolio").then(p=>{
      if(p.trades) setTrades(p.trades);
      if(p.watchItems) setWatchItems(p.watchItems);
      if(p.balance!==undefined) setBalance(p.balance);
      if(p.startBalance!==undefined) setStartBalance(p.startBalance);
    }).catch(()=>{});
  },[]);

  // Auto-save portfolio
  const savePortfolio=useCallback(async(t,w,b,sb)=>{
    setSaving(true);
    try{await api("/api/portfolio",{method:"POST",body:JSON.stringify({trades:t,watchItems:w,balance:b,startBalance:sb})});}
    catch(e){}
    setSaving(false);
  },[]);
  useEffect(()=>{
    const timer=setTimeout(()=>savePortfolio(trades,watchItems,balance,startBalance),2000);
    return()=>clearTimeout(timer);
  },[trades,watchItems,balance]);

  // FX
  const toLocal=useCallback((usd)=>{
    let rate;
    if(fxRates?.USD&&fxRates[activeCurrency.code]!==undefined){rate=fxRates[activeCurrency.code]/fxRates.USD;}
    else{rate=activeCurrency.fb/1.27;}
    return parseFloat((usd*rate).toFixed(4));
  },[fxRates,activeCurrency]);
  const fmtMoney=useCallback((usd)=>{const v=toLocal(usd);return`${activeCurrency.symbol}${v.toFixed(v>1000?2:v>1?2:4)}`;},[toLocal,activeCurrency]);

  // Refresh ‚Äî now fetches technicals in parallel
  const assetsRef=useRef(assets);
  useEffect(()=>{assetsRef.current=assets;},[assets]);

  const doRefresh=useCallback(async()=>{
    const key=Date.now();
    const currentAssets=assetsRef.current;
    const tickers=currentAssets.map(a=>a.ticker);
    try{
      const[liveData,liveFx,techData]=await Promise.all([
        fetchLivePrices(tickers),
        fetchFxRates(),
        fetchTechnicals(tickers),
      ]);
      if(liveFx) setFxRates(liveFx);
      const sigs={};
      currentAssets.forEach(a=>{sigs[a.ticker]=generateSignals(a,key,techData);});
      if(liveData){
        let cnt=0;
        currentAssets.forEach(a=>{
          if(sigs[a.ticker]){
            const m=mergeLiveData(sigs[a.ticker],liveData,a);
            sigs[a.ticker]=m;
            if(m.livePrice)cnt++;
          }
        });
        setLiveCount(cnt);
      }
      if(techData){
        const tc=Object.values(techData).filter(v=>v!==null).length;
        setTechCount(tc);
      }
      setAllSigs(sigs);
    }catch(e){
      const sigs={};
      currentAssets.forEach(a=>{sigs[a.ticker]=generateSignals(a,key,null);});
      setAllSigs(sigs);
    }
    setLastUpdated(new Date().toLocaleTimeString("en-GB"));
    setLoading(false);
  },[]);
  // Load universe from backend (1000+ assets) ‚Äî MUST be after doRefresh is defined (closure dependency)
  useEffect(()=>{
    fetchUniverse().then(loaded=>{
      if(loaded&&loaded.length>0){
        setAssets(loaded);
        assetsRef.current=loaded;
        setTimeout(doRefresh,200);
      }
    });
  },[doRefresh]);
  useEffect(()=>{doRefresh();},[]);
  useEffect(()=>{const t=setInterval(doRefresh,30000);return()=>clearInterval(t);},[]);

  // Watch expiry
  useEffect(()=>{
    setWatchItems(prev=>prev.map(w=>{
      if(w.status==="watching"&&Date.now()>=w.expiresAt){
        const actualPrice=allSigs[w.ticker]?.price||w.entryPrice;
        const actualChg=((actualPrice-w.entryPrice)/w.entryPrice)*100;
        return{...w,status:"expired",actualPrice,actualChg:parseFloat(actualChg.toFixed(2)),dirCorrect:(w.predictedChg>0&&actualChg>0)||(w.predictedChg<0&&actualChg<0),accuracy:Math.max(0,100-Math.abs(actualChg-w.predictedChg)*3)};
      }
      return w;
    }));
  },[tick,allSigs]);

  // Portfolio stats
  const portfolioStats=useMemo(()=>{
    let invested=0,currentVal=0;
    trades.filter(t=>t.status==="open").forEach(t=>{const cp=allSigs[t.ticker]?toLocal(allSigs[t.ticker].price):t.entryPrice;invested+=t.totalCost;currentVal+=cp*t.shares;});
    return{invested,currentVal,unrealised:currentVal-invested,openCount:trades.filter(t=>t.status==="open").length};
  },[trades,allSigs,toLocal]);

  const accuracy=useMemo(()=>calcAccuracy(trades,watchItems),[trades,watchItems]);
  const placeTrade=useCallback((td)=>{setTrades(p=>[...p,td]);setBalance(p=>parseFloat((p-td.totalCost).toFixed(2)));},[]);
  const closeTrade=useCallback((id)=>{
    setTrades(p=>p.map(t=>{
      if(t.id!==id) return t;
      const cp=allSigs[t.ticker]?toLocal(allSigs[t.ticker].price):t.entryPrice;
      const proceeds=cp*t.shares,pnl=proceeds-t.totalCost,pnlPct=(pnl/t.totalCost)*100;
      setBalance(prev=>parseFloat((prev+proceeds).toFixed(2)));
      return{...t,status:"closed",finalPrice:cp,finalPnL:parseFloat(pnl.toFixed(2)),finalPnLPct:parseFloat(pnlPct.toFixed(2)),closedAt:Date.now()};
    }));
  },[allSigs,toLocal]);

  const sectors=useMemo(()=>["All",...new Set(assets.map(a=>a.sector))],[assets]);
  const filtered=useMemo(()=>assets.filter(a=>{
    if(!allSigs[a.ticker]) return false;
    if(activeSector!=="All"&&a.sector!==activeSector) return false;
    if(activeCap!=="All"&&a.cap!==activeCap) return false;
    if(searchQ&&!a.ticker.toLowerCase().includes(searchQ.toLowerCase())&&!a.name.toLowerCase().includes(searchQ.toLowerCase())) return false;
    return true;
  }).sort((a,b)=>{
    const sa=allSigs[a.ticker],sb=allSigs[b.ticker];
    if(sortMode==="bestTF") return sb.tfScores[sb.bestTF]-sa.tfScores[sa.bestTF];
    if(sortMode==="score") return sb.score-sa.score;
    if(sortMode==="rr") return parseFloat(sb.rrRatio)-parseFloat(sa.rrRatio);
    if(sortMode==="price_asc") return sa.price-sb.price;
    if(sortMode==="change") return(sb.changePct||0)-(sa.changePct||0);
    return 0;
  }),[assets,allSigs,activeSector,activeCap,searchQ,sortMode]);

  if(loading) return(<div style={{height:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}}><div style={{width:40,height:40,border:"3px solid #1a1a2e",borderTop:"3px solid #00b0ff",borderRadius:"50%",animation:"spin 1s linear infinite"}}/><div style={{fontSize:11,color:"#3a3a55",letterSpacing:2}}>LOADING MARKET DATA...</div></div>);

  const sym=activeCurrency.symbol;
  const totalPnL=balance-startBalance+portfolioStats.unrealised;
  const openTrades=trades.filter(t=>t.status==="open");
  const closedTrades=trades.filter(t=>t.status!=="open");
  const watchingCount=watchItems.filter(w=>w.status==="watching").length;

  return(
    <div style={{height:"100vh",display:"flex",flexDirection:"column",overflow:"hidden"}}>
      {/* MODALS */}
      {showCurrModal&&(<Modal onClose={()=>setShowCurrModal(false)} maxWidth={340}>
        <div style={{background:"#0a0a16",borderBottom:"1px solid #00b0ff33",padding:"14px 16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:17,fontWeight:700,color:"#dde0ff"}}>Select Currency</div>
          <button onClick={()=>setShowCurrModal(false)} style={{background:"none",border:"none",color:"#444",fontSize:16}}>x</button>
        </div>
        <div style={{padding:8,maxHeight:380,overflowY:"auto"}}>
          {CURRENCIES.map(c=>{const isA=c.code===activeCurrency.code;return(<div key={c.code} onClick={()=>{setActiveCurrency(c);setShowCurrModal(false);}} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 12px",borderRadius:7,cursor:"pointer",background:isA?"#00b0ff18":"transparent",border:`1px solid ${isA?"#00b0ff44":"transparent"}`,marginBottom:3}}><span style={{fontSize:20}}>{c.flag}</span><div style={{flex:1}}><div style={{fontSize:12,fontWeight:700,color:isA?"#00b0ff":"#dde0ff",fontFamily:"monospace"}}>{c.code} <span style={{color:"#4a4a6a",fontSize:10,fontFamily:"inherit"}}>{c.name}</span></div></div><span style={{fontSize:14,fontWeight:700,color:isA?"#00b0ff":"#6a6a8a",fontFamily:"monospace"}}>{c.symbol}</span>{isA&&<span style={{color:"#00b0ff"}}>‚úì</span>}</div>);})}
        </div>
      </Modal>)}
      {showBudget&&(<Modal onClose={()=>setShowBudget(false)} maxWidth={320}>
        <div style={{padding:20}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:17,fontWeight:700,color:"#dde0ff",marginBottom:6}}>SET VIRTUAL BUDGET</div>
          <div style={{fontSize:9,color:"#3a3a55",marginBottom:12}}>Resets all trades and watchlist.</div>
          <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:10}}>{["500","1000","5000","10000","25000","50000"].map(v=>(<button key={v} onClick={()=>setBudgetInput(v)} style={{background:budgetInput===v?"#00b0ff22":"#0a0a16",border:`1px solid ${budgetInput===v?"#00b0ff":"#1a1a2e"}`,borderRadius:5,padding:"4px 10px",color:budgetInput===v?"#00b0ff":"#5a5a7a",fontSize:9}}>{sym}{v}</button>))}</div>
          <input value={budgetInput} onChange={e=>setBudgetInput(e.target.value)} style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:5,padding:"7px",color:"#c0c0e0",fontSize:13,marginBottom:12}}/>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <button onClick={()=>setShowBudget(false)} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:6,padding:"8px",color:"#4a4a6a",fontSize:9}}>CANCEL</button>
            <button onClick={()=>{const v=parseFloat(budgetInput)||1000;setBalance(v);setStartBalance(v);setTrades([]);setWatchItems([]);setShowBudget(false);}} style={{background:"#00b0ff22",border:"1px solid #00b0ff",borderRadius:6,padding:"8px",color:"#00b0ff",fontSize:9}}>CONFIRM</button>
          </div>
        </div>
      </Modal>)}
      {showTradeModal&&selected&&allSigs[selected.ticker]&&(<TradeModal asset={selected} sig={allSigs[selected.ticker]} balance={balance} fmtMoney={fmtMoney} toLocal={toLocal} onPlace={placeTrade} onClose={()=>setShowTradeModal(false)}/>)}
      {showWatchModal&&selected&&allSigs[selected.ticker]&&(<WatchModal asset={selected} sig={allSigs[selected.ticker]} fmtMoney={fmtMoney} onAdd={w=>setWatchItems(p=>[...p,w])} onClose={()=>setShowWatchModal(false)}/>)}

      {/* HEADER */}
      <div style={{borderBottom:"1px solid #0c0c18",padding:"7px 14px",display:"flex",alignItems:"center",gap:8,flexShrink:0,background:"#03030a",flexWrap:"wrap"}}>
        <div>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:18,fontWeight:900,letterSpacing:3,color:"#dde0ff"}}>MARKET <span style={{color:"#00b0ff"}}>BRAIN</span></div>
          <div style={{fontSize:7,color:"#2a2a40",letterSpacing:1}}>Hi, {user.name} {saving&&<span style={{color:"#3a3a55"}}>¬∑ saving...</span>}</div>
        </div>
        <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>
          {[{l:"CASH",v:fmtMoney(toLocal(balance)),c:"#00b0ff"},{l:"INVESTED",v:fmtMoney(toLocal(portfolioStats.invested)),c:"#ffd600"},{l:"UNREALISED",v:fmtPct(portfolioStats.invested>0?portfolioStats.unrealised/portfolioStats.invested*100:0),c:pnlColor(portfolioStats.unrealised)},{l:"TOTAL P&L",v:`${totalPnL>=0?"+":""}${fmtMoney(toLocal(totalPnL))}`,c:pnlColor(totalPnL)}].map(m=>(<div key={m.l} style={{background:"#0a0a16",border:"1px solid #12121e",borderRadius:4,padding:"3px 7px",textAlign:"center"}}><div style={{fontSize:6,color:"#2a2a40",letterSpacing:1}}>{m.l}</div><div style={{fontSize:10,color:m.c,fontWeight:700,fontFamily:"monospace"}}>{m.v}</div></div>))}
          {accuracy&&<div style={{background:"#0a0a16",border:`1px solid ${accuracy.overall>=60?"#00e676":"#ff6d00"}33`,borderRadius:4,padding:"3px 7px",textAlign:"center",cursor:"pointer"}} onClick={()=>setView("accuracy")}><div style={{fontSize:6,color:"#2a2a40",letterSpacing:1}}>ACCURACY</div><div style={{fontSize:10,color:accuracy.overall>=60?"#00e676":"#ff6d00",fontWeight:700,fontFamily:"monospace"}}>{accuracy.overall.toFixed(0)}%</div></div>}
        </div>
        <div style={{marginLeft:"auto",display:"flex",gap:5,alignItems:"center"}}>
          <div style={{fontSize:8,color:liveCount>0?"#00e676":"#3a3a50"}}>‚óè {liveCount} LIVE</div>
          {techCount>0&&<div style={{fontSize:8,color:"#00d4ff"}}>‚óà {techCount} TECH</div>}
          {research&&<div style={{fontSize:8,color:"#00d4aa"}}>‚óà LIVE DATA</div>}
          <button onClick={()=>setShowCurrModal(true)} style={{background:"#0a0a16",border:"1px solid #00b0ff44",borderRadius:5,padding:"4px 9px",display:"flex",alignItems:"center",gap:4}}><span style={{fontSize:13}}>{activeCurrency.flag}</span><span style={{fontSize:9,color:"#00b0ff",fontWeight:700}}>{activeCurrency.code}</span></button>
          <button onClick={()=>setShowBudget(true)} style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:5,padding:"4px 8px",color:"#ffd600",fontSize:8}}>üí∞ {sym}{balance.toFixed(0)}</button>
          <button onClick={doRefresh} style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:5,padding:"4px 8px",color:"#5a5a8a",fontSize:11}}>‚Üª</button>
          <button onClick={async()=>{await api("/api/auth/logout",{method:"POST"});localStorage.removeItem("mb_token");onLogout();}} style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:5,padding:"4px 8px",color:"#5a5a7a",fontSize:8}}>LOG OUT</button>
        </div>
      </div>

      {/* NAV */}
      <div style={{borderBottom:"1px solid #0c0c18",padding:"0 14px",display:"flex",flexShrink:0,background:"#04040c"}}>
        {[["market","üìä Market"],["portfolio",`üíº Portfolio${openTrades.length>0?" ("+openTrades.length+")":""}`],["watchlist",`‚òÖ Watch${watchingCount>0?" ("+watchingCount+")":""}`],["accuracy","üéØ Accuracy"]].map(([v,l])=>(<button key={v} onClick={()=>setView(v)} style={{background:"transparent",border:"none",borderBottom:`2px solid ${view===v?"#00b0ff":"transparent"}`,padding:"9px 14px",color:view===v?"#00b0ff":"#3a3a55",fontSize:9,letterSpacing:1,whiteSpace:"nowrap"}}>{l}</button>))}
      </div>

      {/* MARKET */}
      {view==="market"&&(
        <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{borderBottom:"1px solid #0c0c18",padding:"6px 12px",background:"#04040c",flexShrink:0}}>
            <div style={{display:"flex",gap:4,flexWrap:"wrap",alignItems:"center",marginBottom:4}}>
              <input value={searchQ} onChange={e=>setSearchQ(e.target.value)} placeholder="search..." style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:4,padding:"3px 7px",color:"#8a8aaa",fontSize:9,width:90}}/>
              {CAPS.map(c=>(<Pill key={c} label={c} active={activeCap===c} color={CAP_COLORS[c]||"#00b0ff"} onClick={()=>setActiveCap(c)}/>))}
            </div>
            <div style={{display:"flex",gap:4,flexWrap:"wrap",alignItems:"center"}}>
              {sectors.map(s=>(<Pill key={s} label={s==="All"?"ALL":s.slice(0,7).toUpperCase()} active={activeSector===s} onClick={()=>setActiveSector(s)}/>))}
              <div style={{marginLeft:"auto",display:"flex",gap:3}}>
                {[["bestTF","Best"],["score","Score"],["rr","R/R"],["price_asc","Cheap"],["change","Movers"]].map(([v,l])=>(<Pill key={v} label={l} active={sortMode===v} onClick={()=>setSortMode(v)}/>))}
              </div>
            </div>
          </div>
          <div style={{flex:1,display:"grid",gridTemplateColumns:selected?"1fr 360px":"1fr",overflow:"hidden",minHeight:0}}>
            <div style={{overflowY:"auto",padding:10}}>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(162px,1fr))",gap:6}}>
                {filtered.map(a=>{
                  const sig=allSigs[a.ticker];if(!sig) return null;
                  const R=RISK_CFG[sig.risk],bP=TF_PROFILES[sig.bestTF],bS=sig.tfScores[sig.bestTF];
                  const pc=bS>=72?"#00e676":bS>=52?"#00d4ff":bS>=35?"#ffd600":"#ff6d00";
                  const isSel=selected?.ticker===a.ticker;
                  return(<div key={a.ticker} className="card" onClick={()=>{
                    const next=isSel?null:a;
                    setSelected(next);
                    if(next&&next.ticker!==researchTicker){
                      setResearch(null);
                      setResearchTicker(next.ticker);
                      setResearchLoading(true);
                      fetchResearch(next.ticker, next.name).then(d=>{setResearch(d);setResearchLoading(false);});
                    } else if(!next){setResearch(null);setResearchTicker(null);}
                  }}
                    style={{background:isSel?R.bg:"#07070f",border:`1px solid ${isSel?R.color:"#12121e"}`,borderRadius:7,padding:"9px 10px",cursor:"pointer",position:"relative",overflow:"hidden"}}
                    onMouseEnter={e=>{if(!isSel)e.currentTarget.style.borderColor=R.color+"66";}}
                    onMouseLeave={e=>{if(!isSel)e.currentTarget.style.borderColor="#12121e";}}>
                    <div style={{position:"absolute",top:0,left:0,right:0,height:2,background:R.color}}/>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:2}}>
                      <span style={{fontSize:12,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{a.ticker}</span>
                      <div style={{display:"flex",gap:3,alignItems:"center"}}>
                        {sig.realTech&&<span style={{fontSize:6,color:"#00d4ff"}} title="Real technicals">‚óà</span>}
                        {sig.livePrice&&<span style={{fontSize:6,color:"#00e676"}}>‚óè</span>}
                        <Tag color={R.color} small>{R.label}</Tag>
                      </div>
                    </div>
                    <div style={{fontSize:8,color:"#2a2a3a",marginBottom:4}}>{a.name}</div>
                    <div style={{background:bP.color+"18",border:`1px solid ${bP.color}33`,borderRadius:4,padding:"3px 6px",marginBottom:4,display:"flex",justifyContent:"space-between"}}>
                      <span style={{fontSize:8,color:bP.color}}>{bP.icon} {bP.short}</span>
                      <span style={{fontSize:9,color:pc,fontWeight:700,fontFamily:"monospace"}}>{bS.toFixed(0)}%</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <span style={{fontSize:10,color:"#b0b0cc",fontFamily:"monospace"}}>{fmtMoney(sig.price)}</span>
                      {sig.changePct!==0&&<span style={{fontSize:8,color:pnlColor(sig.changePct),fontFamily:"monospace"}}>{fmtPct(sig.changePct)}</span>}
                    </div>
                  </div>);
                })}
              </div>
            </div>
            {selected&&allSigs[selected.ticker]&&(()=>{
              const sig=allSigs[selected.ticker],R=RISK_CFG[sig.risk];
              const inWatch=watchItems.some(w=>w.ticker===selected.ticker&&w.status==="watching");
              return(<div style={{borderLeft:"1px solid #0c0c18",overflowY:"auto",padding:14,background:"#04040c",display:"flex",flexDirection:"column",gap:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div>
                    <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:700,color:"#dde0ff"}}>{selected.ticker}</div>
                    <div style={{fontSize:9,color:"#3a3a55"}}>{selected.name} ¬∑ {selected.sub}</div>
                    <div style={{display:"flex",gap:4,marginTop:3,flexWrap:"wrap"}}><Tag color={CAP_COLORS[selected.cap]}>{selected.cap} Cap</Tag><Tag color="#5a5a8a">{selected.sector}</Tag></div>
                  </div>
                  <div style={{textAlign:"right"}}>
                    <div style={{fontSize:17,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{fmtMoney(sig.price)}</div>
                    {sig.changePct!==0&&<div style={{fontSize:10,color:pnlColor(sig.changePct),fontFamily:"monospace"}}>{fmtPct(sig.changePct)}</div>}
                    <div style={{marginTop:3,display:"flex",gap:3,justifyContent:"flex-end"}}>
                      {sig.realTech&&<Tag color="#00d4ff">‚óà REAL TECH</Tag>}
                      {sig.livePrice?<Tag color="#00e676">‚óè LIVE</Tag>:<Tag color="#3a3a55">SIM</Tag>}
                      <Tag color={R.color}>{R.label}</Tag>
                    </div>
                  </div>
                </div>
                <div style={{background:"#0a0a16",borderRadius:6,padding:10}}>
                  <div style={{fontSize:7,color:"#2a2a40",letterSpacing:2,marginBottom:8}}>TIMEFRAME ALIGNMENT</div>
                  {TF_KEYS.map(k=>{const p=TF_PROFILES[k],sc=sig.tfScores[k];const pc=sc>=72?"#00e676":sc>=52?"#00d4ff":sc>=35?"#ffd600":"#ff6d00";return(<div key={k} style={{marginBottom:5}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><div style={{display:"flex",gap:4,alignItems:"center"}}><span style={{fontSize:9}}>{p.icon}</span><span style={{fontSize:8,color:sig.bestTF===k?p.color:"#5a5a7a",fontWeight:sig.bestTF===k?"700":"normal"}}>{p.short}</span>{sig.bestTF===k&&<Tag color={p.color} small>BEST</Tag>}</div><span style={{fontSize:9,color:pc,fontWeight:700,fontFamily:"monospace"}}>{sc.toFixed(0)}%</span></div><div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${sc}%`,height:"100%",background:`linear-gradient(90deg,${pc}66,${pc})`,borderRadius:2}}/></div></div>);})}
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:5}}>
                  <Stat label="R/R" value={`${sig.rrRatio}:1`} color={parseFloat(sig.rrRatio)>=2?"#00e676":"#ffd600"}/>
                  <Stat label="UPSIDE" value={`+${sig.upsidePct}%`} color="#00e676"/>
                  <Stat label="STOP" value={`-${sig.stopPct}%`} color="#ff1744"/>
                  <Stat label="ENTRY Q" value={sig.entryQ} color={sig.entryQ==="IDEAL"?"#00e676":sig.entryQ==="GOOD"?"#00b0ff":sig.entryQ==="FAIR"?"#ffd600":"#ff6d00"}/>
                  <Stat label={sig.realTech?"RSI ‚óà":"RSI"} value={sig.metrics.rsi.toFixed(0)} color={sig.metrics.rsi<30?"#00e676":sig.metrics.rsi>70?"#ff1744":"#c0c0e0"}/>
                  <Stat label={sig.realTech?"VOL ‚óà":"VOL x"} value={sig.metrics.volume.toFixed(1)+"x"} color={sig.metrics.volume>1.5?"#00d4ff":"#c0c0e0"}/>
                </div>
                {sig.realTech&&(
                  <div style={{background:"#00d4ff08",border:"1px solid #00d4ff22",borderRadius:6,padding:10}}>
                    <div style={{fontSize:7,color:"#00d4ff",letterSpacing:2,marginBottom:8}}>REAL TECHNICALS ‚óà</div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5}}>
                      <Stat label="MACD" value={sig.metrics.macd.toFixed(3)} color={sig.metrics.macd>0?"#00e676":"#ff6d00"}/>
                      <Stat label="VS MA50" value={`${sig.metrics.priceVsMA50>0?"+":""}${sig.metrics.priceVsMA50?.toFixed(1)}%`} color={sig.metrics.priceVsMA50<-10?"#00e676":sig.metrics.priceVsMA50>20?"#ff1744":"#c0c0e0"}/>
                      <Stat label="VS MA200" value={`${sig.metrics.priceVsMA200>0?"+":""}${sig.metrics.priceVsMA200?.toFixed(1)}%`} color={sig.metrics.priceVsMA200<-15?"#00e676":sig.metrics.priceVsMA200>30?"#ff1744":"#c0c0e0"}/>
                      <Stat label="SIGNAL" value={sig.score>0?"BULL":"BEAR"} color={sig.score>0?"#00e676":"#ff1744"}/>
                    </div>
                  </div>
                )}
                {/* RESEARCH BOTS PANEL */}
                {researchLoading&&(
                  <div style={{background:"#0a0a16",borderRadius:6,padding:"10px",textAlign:"center",fontSize:8,color:"#3a3a55"}}>
                    <span style={{animation:"pulse 1s infinite"}}>‚óà LOADING RESEARCH DATA....</span>
                  </div>
                )}
                {research&&!researchLoading&&(()=>{
                  const bullFactors=(research.bull_factors?.length>=1)?research.bull_factors:[];
                  const bearFactors=(research.bear_factors?.length>=1)?research.bear_factors:[];
                  const hasBotData=bullFactors.length>0||bearFactors.length>0;
                  const meta=research.meta||{};
                  const freshness=meta.freshness||{};
                  const staleFields=meta.stale_fields||[];

                  // Sweep cycle ‚Üí human label
                  const CYCLE_LABELS={
                    overnight:"Overnight Sweep",uk_premarket:"UK Pre-Market Sweep",
                    uk_open:"UK Market Open Sweep",uk_midsession:"UK Mid-Session Sweep",
                    us_premarket:"US Pre-Market Sweep",us_open:"US Market Open Sweep",
                    us_midsession:"US Mid-Session Sweep",uk_close:"UK Market Close Sweep",
                    us_close:"US Market Close Sweep",post_market:"Post-Market Sweep",
                    weekend_prep:"Weekend Prep Sweep",tier3_weekly:"Weekly Sweep",
                    on_demand:"On-Demand Sweep",manual:"Manual Sweep",pending:"Sweep in progress‚Ä¶",
                  };
                  const cycleLabel=CYCLE_LABELS[meta.sweep_cycle]||"Recent Sweep";

                  // Last updated time
                  const fmtTime=(iso)=>{
                    if(!iso)return null;
                    try{return new Date(iso).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});}
                    catch{return null;}
                  };
                  const updatedAt=fmtTime(meta.last_updated);

                  // Freshness per category
                  const TTL_MS={price:14400000,volume:14400000,news:7200000,
                    fundamentals:86400000,analyst:86400000,earnings:86400000,
                    macro:2592000000,sentiment:7200000};
                  const KEY_MAP={price:"technicals",volume:"technicals",news:"news",
                    fundamentals:"fundamentals",analyst:"analyst",macro:"macro",sentiment:"news"};
                  const getFresh=(key)=>{
                    const rk=KEY_MAP[key]||key;
                    if(staleFields.includes(rk))return"stale";
                    const a=freshness[rk];
                    if(!a)return"fresh";
                    const m=String(a).match(/^(\d+)([mhd])/);
                    if(!m)return"fresh";
                    const ms=parseInt(m[1])*(m[2]==="m"?60000:m[2]==="h"?3600000:86400000);
                    const ttl=TTL_MS[rk]||TTL_MS.news;
                    return ms<ttl*0.75?"fresh":ms<ttl*1.1?"cached":"stale";
                  };

                  const CATS=[
                    {label:"Price",key:"price"},{label:"Volume",key:"volume"},
                    {label:"News",key:"news"},{label:"Fundamentals",key:"fundamentals"},
                    {label:"Macro",key:"macro"},{label:"Analyst",key:"analyst"},
                    {label:"Sentiment",key:"sentiment"},
                  ];
                  const DOT={fresh:{c:"#00e676",t:"Up to date"},cached:{c:"#ffd600",t:"Recently updated ‚Äî still valid"},stale:{c:"#ff5252",t:"May be outdated"}};

                  const states=CATS.map(c=>getFresh(c.key));
                  const nStale=states.filter(s=>s==="stale").length;
                  const nCached=states.filter(s=>s==="cached").length;
                  const statusLine=nStale>0?"Using last-known-good data for some fields ‚Äî core signals unaffected.":nCached>2?"Some data cached due to provider limits ‚Äî core signals unaffected.":nCached>0?"Most data fresh. Some fields recently cached ‚Äî still valid.":"All data fresh and up to date.";

                  return(
                    <div>
                      {/* DATA STATUS PANEL */}
                      <div style={{background:"#05050e",border:"1px solid #0d0d20",borderRadius:6,padding:"8px 10px",marginBottom:8}}>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                          <span style={{fontSize:6,color:"#2a2a48",letterSpacing:1.5,textTransform:"uppercase",fontWeight:600}}>Data Status</span>
                          {updatedAt&&(
                            <span style={{fontSize:6.5,color:"#28284a"}}>
                              {updatedAt}
                              <span style={{color:"#1e1e38",marginLeft:4}}>¬∑ {cycleLabel}</span>
                            </span>
                          )}
                        </div>
                        <div style={{display:"flex",flexWrap:"wrap",gap:"4px 9px",marginBottom:6}}>
                          {CATS.map(({label,key})=>{
                            const s=getFresh(key);
                            const d=DOT[s];
                            return(
                              <div key={key} style={{display:"flex",alignItems:"center",gap:3}} title={d.t}>
                                <div style={{width:5,height:5,borderRadius:"50%",background:d.c,flexShrink:0,
                                  boxShadow:s==="fresh"?`0 0 4px ${d.c}55`:"none",opacity:s==="stale"?0.5:1}}/>
                                <span style={{fontSize:7,color:s==="fresh"?"#2a2a46":s==="cached"?"#252535":"#3a1a1a"}}>{label}</span>
                              </div>
                            );
                          })}
                        </div>
                        <div style={{borderTop:"1px solid #09091a",paddingTop:5}}>
                          <div style={{fontSize:6.5,color:"#1e1e36",lineHeight:1.5}}>{statusLine}</div>
                          <div style={{fontSize:6,color:"#141428",marginTop:1}}>Updated throughout the day using multiple trusted providers.</div>
                        </div>
                      </div>

                      {/* SIGNALS */}
                      <div style={{background:"#040414",border:"1px solid #00d4aa1a",borderRadius:6,padding:10,marginBottom:8}}>
                        <div style={{fontSize:7,color:"#00d4aa88",letterSpacing:2,marginBottom:8}}>‚óà SIGNALS</div>
                        {hasBotData&&(<>
                          {bullFactors.length>0&&(
                            <div style={{marginBottom:6}}>
                              <div style={{fontSize:7,color:"#00e676",letterSpacing:1,marginBottom:4}}>‚ñ≤ BULL</div>
                              {bullFactors.slice(0,4).map((f,i)=>(
                                <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"2px 0",borderBottom:"1px solid #0a0a14",fontSize:8}}>
                                  <span style={{color:"#8a8aaa"}}>{f.label||f}</span>
                                  {f.value!==undefined&&<span style={{color:"#00e676",fontFamily:"monospace"}}>{f.value}</span>}
                                </div>
                              ))}
                            </div>
                          )}
                          {bearFactors.length>0&&(
                            <div>
                              <div style={{fontSize:7,color:"#ff6d00",letterSpacing:1,marginBottom:4}}>‚ñº BEAR</div>
                              {bearFactors.slice(0,4).map((f,i)=>(
                                <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"2px 0",borderBottom:"1px solid #0a0a14",fontSize:8}}>
                                  <span style={{color:"#8a8aaa"}}>{f.label||f}</span>
                                  {f.value!==undefined&&<span style={{color:"#ff6d00",fontFamily:"monospace"}}>{f.value}</span>}
                                </div>
                              ))}
                            </div>
                          )}
                        </>)}
                        {!hasBotData&&<div style={{fontSize:8,color:"#3a3a55",textAlign:"center",padding:"4px 0"}}>Signals loading ‚Äî check back shortly.</div>}
                      </div>
                    </div>
                  );
                })()}
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:7}}>
                  <button onClick={()=>setShowWatchModal(true)} disabled={inWatch} style={{background:inWatch?"#1a1a2e":"#ffd60022",border:`1px solid ${inWatch?"#2a2a40":"#ffd600"}`,borderRadius:6,padding:"9px",color:inWatch?"#3a3a50":"#ffd600",fontSize:9,letterSpacing:1}}>{inWatch?"‚òÖ WATCHING":"‚òÖ WATCH"}</button>
                  <button onClick={()=>setShowTradeModal(true)} disabled={balance<toLocal(sig.price)} style={{background:balance>=toLocal(sig.price)?R.color+"22":"#1a1a2e",border:`1px solid ${balance>=toLocal(sig.price)?R.color:"#2a2a40"}`,borderRadius:6,padding:"9px",color:balance>=toLocal(sig.price)?R.color:"#3a3a50",fontSize:9,letterSpacing:1}}>üìà TRADE</button>
                </div>
                <div style={{fontSize:7,color:"#1a1a28",textAlign:"center"}}>Virtual simulation only. Not financial advice.</div>
              </div>);
            })()}
          </div>
        </div>
      )}

      {/* PORTFOLIO */}
      {view==="portfolio"&&(
        <div style={{flex:1,overflowY:"auto",padding:12}}>
          <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:16}}>
            <Stat label="CASH" value={fmtMoney(toLocal(balance))} color="#00b0ff"/>
            <Stat label="INVESTED" value={fmtMoney(toLocal(portfolioStats.invested))} color="#ffd600"/>
            <Stat label="UNREALISED" value={fmtPct(portfolioStats.invested>0?portfolioStats.unrealised/portfolioStats.invested*100:0)} color={pnlColor(portfolioStats.unrealised)} sub={`${portfolioStats.unrealised>=0?"+":""}${fmtMoney(toLocal(portfolioStats.unrealised))}`}/>
            <Stat label="TOTAL P&L" value={`${totalPnL>=0?"+":""}${fmtMoney(toLocal(totalPnL))}`} color={pnlColor(totalPnL)}/>
          </div>
          <div style={{fontSize:9,color:"#00e676",letterSpacing:2,marginBottom:8}}>OPEN POSITIONS ({openTrades.length})</div>
          {openTrades.length===0&&<div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:7,padding:16,textAlign:"center",color:"#3a3a55",fontSize:10,marginBottom:16}}>No open positions.</div>}
          {openTrades.map(t=>{
            const cp=allSigs[t.ticker]?toLocal(allSigs[t.ticker].price):t.entryPrice;
            const pnl=(cp-t.entryPrice)*t.shares,pnlPct=((cp-t.entryPrice)/t.entryPrice)*100;
            const tfP=TF_PROFILES[t.timeframe],R=RISK_CFG[t.signalRisk];
            return(<div key={t.id} style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:12,marginBottom:7,borderLeft:`3px solid ${tfP.color}`}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                <div><div style={{display:"flex",gap:5,alignItems:"center",marginBottom:2,flexWrap:"wrap"}}><span style={{fontSize:13,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{t.ticker}</span><Tag color={tfP.color}>{tfP.icon} {tfP.short}</Tag><Tag color={R.color}>{R.label}</Tag><span style={{fontSize:8,color:"#3a3a55"}}>{t.shares} units</span></div><div style={{fontSize:8,color:"#3a3a50"}}>{t.name}</div></div>
                <button onClick={()=>closeTrade(t.id)} style={{background:"#ff174422",border:"1px solid #ff174466",borderRadius:5,padding:"5px 8px",color:"#ff1744",fontSize:8}}>CLOSE</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:5,marginBottom:6}}>
                <Stat label="ENTRY" value={`${sym}${t.entryPrice.toFixed(2)}`}/>
                <Stat label="NOW" value={`${sym}${cp.toFixed(2)}`} color={pnlColor(pnlPct)}/>
                <Stat label="P&L%" value={fmtPct(pnlPct)} color={pnlColor(pnlPct)}/>
                <Stat label="STOP" value={`-${t.stopPct}%`} color="#ff174477"/>
                <Stat label="TARGET" value={`+${t.targetPct}%`} color="#00e67677"/>
              </div>
              <div style={{display:"flex",justifyContent:"space-between"}}><div style={{fontSize:9,color:"#3a3a55"}}>Cost: {sym}{t.totalCost.toFixed(2)} ¬∑ Signal: <span style={{color:tfP.color}}>{t.tfScore}%</span></div><div style={{fontSize:12,fontWeight:700,color:pnlColor(pnl),fontFamily:"monospace"}}>{pnl>=0?"+":"-"}{sym}{Math.abs(pnl).toFixed(2)}</div></div>
            </div>);
          })}
          {closedTrades.length>0&&(<>
            <div style={{fontSize:9,color:"#5a5a7a",letterSpacing:2,marginBottom:8,marginTop:16}}>CLOSED ({closedTrades.length})</div>
            {closedTrades.map(t=>{const tfP=TF_PROFILES[t.timeframe];return(<div key={t.id} style={{background:"#06060e",border:`1px solid ${t.finalPnLPct>0?"#00e67622":"#ff174422"}`,borderRadius:6,padding:"9px 12px",marginBottom:5,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div><div style={{display:"flex",gap:5,alignItems:"center",marginBottom:2}}><span style={{fontSize:11,fontWeight:700,color:t.finalPnLPct>0?"#00e676":"#ff1744",fontFamily:"monospace"}}>{t.ticker}</span><Tag color={tfP.color}>{tfP.icon}</Tag><Tag color={CAP_COLORS[t.cap]||"#888"} small>{t.cap}</Tag></div><div style={{fontSize:8,color:"#4a4a6a"}}>{sym}{t.entryPrice.toFixed(2)} ‚Üí {sym}{t.finalPrice?.toFixed(2)}</div></div>
              <div style={{textAlign:"right"}}><div style={{fontSize:13,fontWeight:700,color:pnlColor(t.finalPnL),fontFamily:"monospace"}}>{t.finalPnL>=0?"+":"-"}{sym}{Math.abs(t.finalPnL).toFixed(2)}</div><div style={{fontSize:9,color:pnlColor(t.finalPnLPct),fontFamily:"monospace"}}>{fmtPct(t.finalPnLPct)}</div></div>
            </div>);})}
          </>)}
        </div>
      )}

      {/* WATCHLIST */}
      {view==="watchlist"&&(
        <div style={{flex:1,overflowY:"auto",padding:12}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <div style={{fontSize:9,color:"#ffd600",letterSpacing:2}}>TIMED WATCHLIST ({watchItems.length})</div>
            {watchItems.length>0&&<button onClick={()=>setWatchItems(p=>p.filter(w=>w.status==="watching"))} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:5,padding:"3px 8px",color:"#4a4a6a",fontSize:8}}>CLEAR EXPIRED</button>}
          </div>
          {watchItems.length===0&&<div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:7,padding:24,textAlign:"center",color:"#3a3a55",fontSize:10}}>No items watched. Go to Market and click Watch on any asset.</div>}
          {watchItems.map(w=>{
            const tfP=TF_PROFILES[w.timeframe],now=Date.now(),pct=Math.min(100,((now-w.addedAt)/(w.expiresAt-w.addedAt))*100),expired=w.status==="expired";
            return(<div key={w.id} style={{background:"#07070f",border:`1px solid ${expired?(w.dirCorrect?"#00e67644":"#ff174444"):"#1a1a2e"}`,borderRadius:8,padding:12,marginBottom:8,position:"relative",overflow:"hidden"}}>
              {!expired&&<div style={{position:"absolute",top:0,left:0,height:2,width:`${pct}%`,background:tfP.color}}/>}
              {expired&&<div style={{position:"absolute",top:0,left:0,right:0,height:2,background:w.dirCorrect?"#00e676":"#ff1744"}}/>}
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                <div><div style={{display:"flex",gap:5,alignItems:"center",marginBottom:2}}><span style={{fontSize:13,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{w.ticker}</span><Tag color={tfP.color}>{tfP.icon} {w.duration}</Tag>{expired&&<Tag color={w.dirCorrect?"#00e676":"#ff1744"}>{w.dirCorrect?"‚úì CORRECT":"‚úó MISS"}</Tag>}{!expired&&<Tag color={tfP.color}>WATCHING</Tag>}</div><div style={{fontSize:8,color:"#3a3a50"}}>{w.name} ¬∑ {w.sector} ¬∑ {w.cap} Cap</div></div>
                <button onClick={()=>setWatchItems(p=>p.filter(x=>x.id!==w.id))} style={{background:"none",border:"none",color:"#333",fontSize:12}}>x</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:8}}>
                <Stat label="ENTRY" value={fmtMoney(w.entryPrice)}/>
                <Stat label="PREDICTED" value={fmtMoney(w.predictedPrice)} color={w.predictedChg>0?"#00e676":"#ff1744"}/>
                <Stat label="PRED MOVE" value={fmtPct(w.predictedChg)} color={w.predictedChg>0?"#00e676":"#ff1744"}/>
                {expired?<Stat label="ACTUAL" value={fmtPct(w.actualChg)} color={pnlColor(w.actualChg)}/>:<Stat label="REMAINING" value={fmtMs(w.expiresAt-now)} color={tfP.color}/>}
              </div>
              {expired&&<div style={{background:w.dirCorrect?"#00e67610":"#ff174410",border:`1px solid ${w.dirCorrect?"#00e67644":"#ff174444"}`,borderRadius:6,padding:10}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div><div style={{fontSize:8,color:w.dirCorrect?"#00e676":"#ff1744",letterSpacing:2,marginBottom:2}}>PREDICTION RESULT</div><div style={{fontSize:10,color:"#c0c0e0"}}>{w.dirCorrect?"Direction correct ‚úì":"Direction missed ‚úó"} ¬∑ Accuracy: <strong style={{color:w.dirCorrect?"#00e676":"#ff6d00"}}>{w.accuracy?.toFixed(0)}%</strong></div></div><div style={{textAlign:"right"}}><div style={{fontSize:7,color:"#2a2a40"}}>SIGNAL</div><div style={{fontSize:14,fontWeight:700,color:tfP.color,fontFamily:"monospace"}}>{w.tfScore}%</div></div></div></div>}
              {!expired&&<div><div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}><span style={{fontSize:7,color:"#3a3a50"}}>Progress</span><span style={{fontSize:7,color:tfP.color}}>{pct.toFixed(0)}% ¬∑ {fmtMs(w.expiresAt-now)} left</span></div><div style={{height:4,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${pct}%`,height:"100%",background:tfP.color,borderRadius:2}}/></div></div>}
            </div>);
          })}
        </div>
      )}

      {/* ACCURACY */}
      {view==="accuracy"&&(
        <div style={{flex:1,overflowY:"auto",padding:12}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:16,fontWeight:700,color:"#dde0ff",letterSpacing:2,marginBottom:12}}>PREDICTION ACCURACY REPORT</div>
          {!accuracy?(<div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:24,textAlign:"center"}}><div style={{fontSize:28,marginBottom:8}}>üìä</div><div style={{fontSize:11,color:"#4a4a6a",lineHeight:1.8}}>No results yet. Place trades or set watchlist timers to build data.</div></div>):(
            <>
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:14}}>
                <Stat label="OVERALL WIN RATE" value={`${accuracy.overall.toFixed(0)}%`} color={accuracy.overall>=60?"#00e676":accuracy.overall>=45?"#ffd600":"#ff6d00"} sub={`${accuracy.wins}W / ${accuracy.losses}L`}/>
                <Stat label="TOTAL RESULTS" value={accuracy.total} color="#c0c0e0"/>
                <Stat label="AVG RETURN" value={fmtPct(accuracy.avgReturn)} color={pnlColor(accuracy.avgReturn)}/>
                <Stat label="GRADE" value={accuracy.overall>=70?"A":accuracy.overall>=60?"B":accuracy.overall>=50?"C":"D"} color={accuracy.overall>=60?"#00e676":"#ff6d00"}/>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:14}}>
                  <div style={{fontSize:9,color:"#2a2a40",letterSpacing:2,marginBottom:10}}>BY CAP SIZE</div>
                  {["Nano","Micro","Small","Mid","Large"].map(cap=>{
                    const d=accuracy.byCap[cap];
                    if(!d) return(<div key={cap} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #0a0a14",opacity:0.3}}><div style={{display:"flex",gap:6,alignItems:"center"}}><span style={{width:7,height:7,background:CAP_COLORS[cap],borderRadius:"50%",display:"inline-block"}}/><span style={{fontSize:9,color:"#3a3a50"}}>{cap}</span></div><span style={{fontSize:9,color:"#2a2a40"}}>No data</span></div>);
                    const c=d.rate>=60?"#00e676":d.rate>=45?"#ffd600":"#ff6d00";
                    return(<div key={cap} style={{padding:"6px 0",borderBottom:"1px solid #0a0a14"}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><div style={{display:"flex",gap:5,alignItems:"center"}}><span style={{width:7,height:7,background:CAP_COLORS[cap],borderRadius:"50%",display:"inline-block"}}/><span style={{fontSize:10,color:"#c0c0e0"}}>{cap}</span><span style={{fontSize:7,color:"#3a3a50"}}>{d.wins}W/{d.total-d.wins}L</span></div><span style={{fontSize:11,color:c,fontWeight:700,fontFamily:"monospace"}}>{d.rate.toFixed(0)}%</span></div>
                      <div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${d.rate}%`,height:"100%",background:c,borderRadius:2}}/></div>
                    </div>);
                  })}
                </div>
                <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:14}}>
                  <div style={{fontSize:9,color:"#2a2a40",letterSpacing:2,marginBottom:10}}>BY SECTOR</div>
                  {Object.entries(accuracy.bySector).sort((a,b)=>b[1].rate-a[1].rate).map(([sec,d])=>{
                    const c=d.rate>=60?"#00e676":d.rate>=45?"#ffd600":"#ff6d00";
                    return(<div key={sec} style={{padding:"5px 0",borderBottom:"1px solid #0a0a14"}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><span style={{fontSize:9,color:"#8a8aaa"}}>{sec} <span style={{color:"#3a3a50",fontSize:7}}>({d.wins}W/{d.total-d.wins}L)</span></span><span style={{fontSize:10,color:c,fontWeight:700,fontFamily:"monospace"}}>{d.rate.toFixed(0)}%</span></div>
                      <div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${d.rate}%`,height:"100%",background:c,borderRadius:2}}/></div>
                    </div>);
                  })}
                </div>
              </div>
              <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:14}}>
                <div style={{fontSize:9,color:"#2a2a40",letterSpacing:2,marginBottom:10}}>BY TIMEFRAME</div>
                {TF_KEYS.map(k=>{
                  const items=[...trades.filter(t=>t.status!=="open"&&t.timeframe===k),...watchItems.filter(w=>w.status==="expired"&&w.timeframe===k)];
                  if(!items.length) return(<div key={k} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #0a0a14",opacity:0.3}}><span style={{fontSize:9,color:"#3a3a50"}}>{TF_PROFILES[k].icon} {TF_PROFILES[k].short}</span><span style={{fontSize:9,color:"#2a2a40"}}>No data</span></div>);
                  const wins=items.filter(t=>(t.finalPnLPct||t.actualChg||0)>0).length;
                  const rate=(wins/items.length)*100,c=rate>=60?"#00e676":rate>=45?"#ffd600":"#ff6d00",p=TF_PROFILES[k];
                  return(<div key={k} style={{padding:"5px 0",borderBottom:"1px solid #0a0a14"}}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><span style={{fontSize:9,color:p.color}}>{p.icon} {p.short} <span style={{color:"#3a3a50",fontSize:7}}>({wins}W/{items.length-wins}L)</span></span><span style={{fontSize:10,color:c,fontWeight:700,fontFamily:"monospace"}}>{rate.toFixed(0)}%</span></div>
                    <div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${rate}%`,height:"100%",background:c,borderRadius:2}}/></div>
                  </div>);
                })}
              </div>
            </>
          )}
        </div>
      )}

      <div style={{borderTop:"1px solid #0e0e18",padding:"3px 14px",display:"flex",alignItems:"center",gap:10,flexShrink:0,background:"#03030a"}}>
        <span style={{fontSize:7,color:liveCount>0?"#00e676":"#3a3a50",animation:liveCount>0?"pulse 2s infinite":"none"}}>{liveCount>0?"‚óè LIVE":"‚óè SIM"}</span>
        <span style={{fontSize:7,color:"#2a2a40"}}>{liveCount} live ¬∑ {techCount} real tech ¬∑ {assets.length} assets ¬∑ auto-saves</span>
        {lastUpdated&&<span style={{fontSize:7,color:"#1a1a28",marginLeft:"auto"}}>Updated {lastUpdated}</span>}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ ROOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function Root(){
  const[user,setUser]=useState(null);
  const[checking,setChecking]=useState(true);
  useEffect(()=>{
    const token=localStorage.getItem("mb_token");
    if(!token){setChecking(false);return;}
    api("/api/auth/me").then(u=>{setUser(u);setChecking(false);}).catch(()=>{localStorage.removeItem("mb_token");setChecking(false);});
  },[]);
  if(checking) return(<div style={{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center"}}><div style={{width:32,height:32,border:"3px solid #1a1a2e",borderTop:"3px solid #00b0ff",borderRadius:"50%",animation:"spin 1s linear infinite"}}/></div>);
  if(!user) return(<WelcomePage onAuth={u=>setUser(u)}/>);
  return(<MainApp user={user} onLogout={()=>setUser(null)}/>);
}
ReactDOM.createRoot(document.getElementById("root")).render(<Root/>);
</script>
</body>
</html>
