<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Market Brain v7</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Barlow+Condensed:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#03030a;color:#dde0ff;font-family:'DM Mono','Courier New',monospace;height:100vh;overflow:hidden;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:#0a0a14;}::-webkit-scrollbar-thumb{background:#1a1a2e;border-radius:2px;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px #00b0ff22}50%{box-shadow:0 0 40px #00b0ff44}}
.fade{animation:fadeIn 0.25s ease;}
input{outline:none;font-family:inherit;}
button{font-family:inherit;cursor:pointer;}
.hero-btn{transition:all 0.2s;}
.hero-btn:hover{transform:translateY(-2px);}
.tooltip-wrap{position:relative;}
.tooltip-box{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#0e0e1e;border:1px solid #00b0ff44;border-radius:7px;padding:8px 10px;width:210px;z-index:999;pointer-events:none;}
.tooltip-wrap:hover .tooltip-box{display:block;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef,useMemo}=React;

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API="";
const api=async(path,opts={})=>{
  const token=localStorage.getItem("mb_token");
  const headers={"Content-Type":"application/json",...(token?{Authorization:`Bearer ${token}`}:{})};
  const res=await fetch(API+path,{headers,...opts});
  const j=await res.json();
  if(!res.ok) throw new Error(j.detail||"Request failed");
  return j;
};
async function fetchLivePrices(tickers){
  try{
    const chunks=[];for(let i=0;i<tickers.length;i+=40)chunks.push(tickers.slice(i,i+40));
    const results={};
    for(const chunk of chunks){const j=await api(`/api/prices?symbols=${chunk.join(",")}`);Object.assign(results,j.data||{});}
    return Object.keys(results).length>0?results:null;
  }catch(e){return null;}
}
async function fetchFxRates(){
  try{
    const pairs="GBPUSD=X,GBPEUR=X,GBPJPY=X,GBPCAD=X,GBPAUD=X,GBPCHF=X,GBPINR=X,GBPSGD=X,GBPHKD=X";
    const j=await api(`/api/prices?symbols=${pairs}`);
    if(!j.data) return null;
    const rates={GBP:1.0};
    const map={"GBPUSD=X":"USD","GBPEUR=X":"EUR","GBPJPY=X":"JPY","GBPCAD=X":"CAD","GBPAUD=X":"AUD","GBPCHF=X":"CHF","GBPINR=X":"INR","GBPSGD=X":"SGD","GBPHKD=X":"HKD"};
    Object.entries(map).forEach(([sym,code])=>{const d=j.data[sym];if(d?.price)rates[code]=parseFloat(d.price);});
    return rates;
  }catch(e){return null;}
}

// â”€â”€ CURRENCIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CURRENCIES=[
  {code:"GBP",symbol:"Â£",flag:"ðŸ‡¬ðŸ‡§",name:"British Pound",fb:1.00},
  {code:"USD",symbol:"$",flag:"ðŸ‡ºðŸ‡¸",name:"US Dollar",fb:1.27},
  {code:"EUR",symbol:"â‚¬",flag:"ðŸ‡ªðŸ‡º",name:"Euro",fb:1.17},
  {code:"JPY",symbol:"Â¥",flag:"ðŸ‡¯ðŸ‡µ",name:"Japanese Yen",fb:192.5},
  {code:"CAD",symbol:"C$",flag:"ðŸ‡¨ðŸ‡¦",name:"Canadian Dollar",fb:1.72},
  {code:"AUD",symbol:"A$",flag:"ðŸ‡¦ðŸ‡º",name:"Australian Dollar",fb:1.95},
  {code:"CHF",symbol:"Fr",flag:"ðŸ‡¨ðŸ‡­",name:"Swiss Franc",fb:1.13},
  {code:"INR",symbol:"â‚¹",flag:"ðŸ‡®ðŸ‡³",name:"Indian Rupee",fb:105.8},
  {code:"SGD",symbol:"S$",flag:"ðŸ‡¸ðŸ‡¬",name:"Singapore Dollar",fb:1.71},
  {code:"HKD",symbol:"HK$",flag:"ðŸ‡­ðŸ‡°",name:"Hong Kong Dollar",fb:9.93},
];

// â”€â”€ ASSET KNOWLEDGE BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ASSET_KNOWLEDGE={
  "NVDA":{desc:"The world's dominant AI chip maker. GPUs power virtually every major AI model and data centre build-out globally.",drivers:["AI/ML compute demand","Data centre capex cycles","Gaming GPU refresh cycle","China export restrictions"],risks:["Valuation stretch at AI peak","AMD and custom silicon competition","Export control escalation","Cyclical chip downturn"],watch:"Quarterly data centre revenue growth and guidance; China revenue share; new GPU architecture timelines."},
  "AMD":{desc:"Intel's main x86 competitor and a credible challenger to NVIDIA in AI GPUs with the MI300 series.",drivers:["EPYC server CPU market share gains","MI300 GPU ramp for AI","PC market recovery","Gaming console chip royalties"],risks:["NVIDIA's entrenched CUDA ecosystem","Intel's comeback attempts","Execution risk on roadmap","Gross margin pressure"],watch:"Data centre GPU revenue each quarter; EPYC server socket wins vs Intel."},
  "INTC":{desc:"The former king of semiconductors now fighting a comeback with its foundry ambitions and 18A process node.",drivers:["Gaudi AI accelerator sales","18A foundry customer wins","Government chip subsidies (CHIPS Act)","PC demand recovery"],risks:["Years of market share losses","Foundry is losing money","TSMC dominance","Execution history"],watch:"18A yield data, foundry external customer announcements, Gaudi revenue ramp."},
  "MSFT":{desc:"Microsoft â€” the enterprise software giant supercharged by its OpenAI partnership and Azure AI cloud services.",drivers:["Azure cloud growth","Copilot AI monetisation","Office 365 pricing power","Gaming via Xbox/Activision"],risks:["Antitrust scrutiny","AI cost of revenue","Macro enterprise spending cuts","Competition from Google Cloud"],watch:"Azure revenue growth rate quarterly; Copilot seat adoption numbers."},
  "GOOGL":{desc:"Alphabet â€” Google's parent. Dominant in search advertising with growing AI and cloud arms via Gemini and Google Cloud.",drivers:["Search ad market share","Google Cloud growth","Gemini AI integration","YouTube monetisation"],risks:["AI disruption of search revenue","Antitrust breakup risk","Cloud margins","Competition from OpenAI/Perplexity"],watch:"Search revenue per query trends; Google Cloud growth vs AWS/Azure; Gemini integration traction."},
  "META":{desc:"Meta Platforms â€” Instagram, Facebook, WhatsApp and the Reality Labs AR/VR bet. Ad revenue machine.",drivers:["Instagram Reels ad growth","AI-driven ad targeting","WhatsApp monetisation","Ray-Ban smart glasses adoption"],risks:["Regulatory fines (EU/US)","Reality Labs cash burn","Teen usage decline","Ad market cyclicality"],watch:"Daily active users across family of apps; ad revenue per user; Reality Labs losses."},
  "AAPL":{desc:"Apple â€” the world's most valuable company. iPhone drives ~50% of revenue; Services is the fast-growing high-margin layer.",drivers:["iPhone upgrade cycle","Services revenue (App Store, iCloud, Apple Pay)","India manufacturing diversification","Vision Pro adoption"],risks:["China revenue exposure (~18%)","EU App Store regulation","Slowing smartphone market","Services antitrust rulings"],watch:"iPhone China sellthrough; Services gross margin; India sales growth."},
  "SOUN":{desc:"SoundHound AI â€” a pure-play voice AI company powering in-car assistants, drive-throughs and enterprise voice interfaces.",drivers:["Automotive voice AI contracts","Restaurant/hospitality AI rollout","NVIDIA partnership"],risks:["Burning cash â€” not yet profitable","Tiny revenue base","Large player competition (Google, Amazon)","Revenue concentration risk"],watch:"Revenue growth rate; cash burn rate; new contract announcements."},
  "BBAI":{desc:"BigBear.ai â€” provides AI analytics for US defence and intelligence customers. Government contract dependent.",drivers:["US defence AI spending growth","Contract renewals and expansions","AI-driven intelligence analytics"],risks:["Highly concentrated government revenue","Small cap â€” limited liquidity","Profitability timeline uncertain","Contract cancellation risk"],watch:"Contract wins and renewals; revenue visibility; cash position."},
  "CRWD":{desc:"CrowdStrike â€” the gold standard cloud-native endpoint security platform. Falcon platform has very high switching costs.",drivers:["Endpoint security market expansion","Platform consolidation (replacing point solutions)","Government contracts","AI-native threat detection"],risks:["Premium valuation","Large enterprise sales cycles","2024 outage trust damage","Competition from Microsoft Defender"],watch:"Annual Recurring Revenue (ARR) growth; net revenue retention; module adoption per customer."},
  "PANW":{desc:"Palo Alto Networks â€” a cybersecurity platform giant pursuing 'platformisation' to replace multiple point tools.",drivers:["Platform consolidation wave","Zero Trust architecture adoption","Government cybersecurity mandates","AI-powered SOC tools"],risks:["Platformisation discounting hurts near-term revenue","Integration complexity","Valuation"],watch:"Remaining performance obligations (RPO) growth; platformisation customer count."},
  "IONQ":{desc:"IonQ â€” a leading trapped-ion quantum computing company. Hardware and cloud-based quantum services.",drivers:["Quantum computing commercialisation","Government/defence contracts","Cloud partnerships (AWS, Azure, Google)","Algorithmic qubit improvements"],risks:["Years from commercial viability at scale","No clear revenue path","Competitor progress (IBM, Google)","Heavy capital requirements"],watch:"Algorithmic qubit benchmarks; revenue from cloud services; government contract pipeline."},
  "QUBT":{desc:"Quantum Computing Inc â€” a very small quantum optimisation software company. Extremely speculative.",drivers:["Quantum software licensing","Government grants","Hype cycle momentum"],risks:["Minimal revenue","Highly dilutive capital raises","Speculative, binary outcome","No moat yet established"],watch:"Revenue milestones; dilution events; partnership announcements."},
  "MRNA":{desc:"Moderna â€” mRNA vaccine pioneer. Post-COVID, repositioning its platform for flu, RSV, cancer vaccines and rare diseases.",drivers:["RSV and flu mRNA vaccine approvals","mRNA cancer vaccine pipeline (with Merck)","Next-gen COVID boosters","Rare disease pipeline"],risks:["COVID revenue cliff","High R&D spend","Competition from Pfizer's mRNA portfolio","Binary clinical trial outcomes"],watch:"RSV vaccine sales; cancer vaccine Phase 3 data; cash runway."},
  "PFE":{desc:"Pfizer â€” a pharma giant managing its post-COVID transition. Deep pipeline but needs blockbusters to replace lost vaccine revenue.",drivers:["Oncology pipeline (ADCs, cancer drugs)","Rare disease acquisitions","COVID antiviral Paxlovid","Seagen acquisition synergies"],risks:["COVID revenue normalisation","Patent cliffs on key drugs","Integration of large acquisitions","Weight loss drug disruption of its portfolio"],watch:"Oncology drug sales growth; pipeline read-outs; cost cutting programme progress."},
  "JNJ":{desc:"Johnson & Johnson â€” a defensive healthcare conglomerate covering pharmaceuticals and medical devices after spinning off Kenvue.",drivers:["MedTech device sales growth","Innovative medicine pipeline","Oncology drug launches","Dividend track record"],risks:["Talc litigation liability","Patent cliffs","Macro sensitivity of MedTech volumes","Generic competition"],watch:"MedTech segment organic growth; oncology drug Darzalex/Tremfya sales; litigation settlement updates."},
  "RXRX":{desc:"Recursion Pharmaceuticals â€” AI-powered drug discovery combining biology maps and machine learning to find novel medicines.",drivers:["AI drug discovery platform licensing","Tech pharma partnerships (Roche, Bayer)","Pipeline asset value","NVIDIA partnership"],risks:["No approved drugs yet","Cash burn is significant","Long drug development timelines","Execution risk"],watch:"Partnership deal economics; pipeline progression into Phase 2/3; cash runway."},
  "NTLA":{desc:"Intellia Therapeutics â€” in vivo CRISPR gene editing company targeting rare genetic diseases with durable single-treatment cures.",drivers:["CRISPR gene editing clinical data","TTR amyloidosis lead drug approval path","Partnerships (Regeneron)","First in-vivo CRISPR approvals globally"],risks:["Binary clinical trial risk","Gene editing off-target effects","Competitive from CRISPR Therapeutics","Long regulatory timeline"],watch:"NTLA-2001 (TTR) Phase 3 data; Regeneron collaboration milestones."},
  "ISRG":{desc:"Intuitive Surgical â€” the undisputed leader in robotic surgery via its da Vinci systems. Razor/blade revenue model with razor-thin competition.",drivers:["Surgical robot installed base expansion","Procedure volume growth","Next-gen Ion and da Vinci 5 ramp","International expansion"],risks:["Premium pricing pressure from hospitals","Emergent BioSolutions / Medtronic competition","Regulatory clearance timing","Macro hospital capex cuts"],watch:"da Vinci procedure volumes growth; da Vinci 5 adoption; system placements per quarter."},
  "XOM":{desc:"ExxonMobil â€” the largest US integrated oil major. Disciplined capital allocation and strong Permian Basin position.",drivers:["Oil price (WTI/Brent)","Permian Basin production growth","Pioneer acquisition integration","LNG export capacity"],risks:["Oil price collapse","Energy transition long-term pressure","Regulatory and carbon liability","Refining margin compression"],watch:"Permian production volumes; oil price correlation; dividend coverage ratio."},
  "BP":{desc:"BP plc â€” a UK oil major restructuring its energy transition strategy after partially walking back renewables commitments.",drivers:["Oil and gas production volumes","Gas/LNG trading margins","Renewables portfolio (selective)","Share buyback programme"],risks:["Transition uncertainty","Activist investor pressure","Relative underperformance vs US peers","Refining margins"],watch:"Strategy updates; production guidance; oil price sensitivity; buyback pace."},
  "CVX":{desc:"Chevron â€” a US oil major with significant Permian and international LNG exposure. Conservative balance sheet.",drivers:["Permian Basin output growth","LNG long-term contracts","Kazakhstan TCO project ramp","Buyback programme"],risks:["Hess acquisition regulatory risks","Oil price weakness","Permian growth plateauing","Carbon transition"],watch:"Hess deal close; Permian production guidance; FCF yield vs dividend."},
  "PLUG":{desc:"Plug Power â€” a hydrogen fuel cell company targeting material handling, green hydrogen production and transport.",drivers:["Green hydrogen electrolyser sales","US IRA hydrogen tax credits","Material handling fuel cell fleet wins","European green hydrogen demand"],risks:["Cash burn â€” multiple dilutive raises","Hydrogen cost not yet competitive","Delivery failures in past","DOE loan guarantee delays"],watch:"Electrolyser revenue; cash position and financing; IRA credit monetisation timeline."},
  "FSLR":{desc:"First Solar â€” the only large US-based solar panel manufacturer. Thin-film CdTe technology has a domestic manufacturing advantage.",drivers:["IRA domestic content tax credits","Utility-scale solar demand","Anti-dumping tariffs protecting US market","Technology roadmap (Series 7)"],risks:["Chinese panel price competition","Project financing tightening","Supply chain bottlenecks","Policy reversal risk"],watch:"Module shipment guidance; ASP per watt; IRA credit realisation; bookings backlog."},
  "NEE":{desc:"NextEra Energy â€” the world's largest producer of wind and solar energy. Part utility, part clean energy developer.",drivers:["Renewable energy capacity additions","Power Purchase Agreement pricing","Rate base growth (Florida utility)","AI data centre power demand"],risks:["Rising interest rate pressure on project finance","Renewable permitting delays","Extreme weather events","Regulated utility earnings caps"],watch:"Renewable energy additions per year; FPL rate case outcomes; development backlog."},
  "GLD":{desc:"SPDR Gold ETF â€” the largest gold-backed ETF, tracking spot gold prices. A macro safe-haven and inflation hedge.",drivers:["Central bank gold buying","Inflation expectations","USD weakness","Geopolitical uncertainty"],risks:["Rising real yields (opportunity cost)","Crypto as alternative store of value","Strong dollar environment","Low direct yield"],watch:"Fed rate trajectory; real yields (TIPS); central bank reserve diversification; DXY."},
  "SLV":{desc:"iShares Silver ETF â€” tracks spot silver. Silver has both monetary (safe haven) and industrial (solar, EVs, electronics) demand.",drivers:["Solar panel silver demand","EV battery connectors","Safe-haven buying","Gold/silver ratio mean reversion"],risks:["Industrial demand slowdown","Gold correlation drag","Higher volatility than gold","Mining supply increases"],watch:"Gold/silver ratio; solar installation volumes; manufacturing PMI data."},
  "GFI":{desc:"Gold Fields â€” a South African gold miner with operations in Australia, Ghana, Peru and South Africa.",drivers:["Gold price","Production volume growth","Mine cost control (AISC)","Salares Norte ramp (Chile)"],risks:["Mining cost inflation","Country risk (South Africa, Ghana)","FX exposure (ZAR, AUD)","Strike risk"],watch:"All-In Sustaining Costs (AISC) per ounce; quarterly production; gold price correlation."},
  "FCX":{desc:"Freeport-McMoRan â€” the world's largest publicly-traded copper producer with mines in Americas and Indonesia.",drivers:["Copper price (energy transition demand)","Grasberg mine Indonesia production","EV and renewable energy copper intensity","China infrastructure spending"],risks:["Copper price cyclicality","Indonesia political/tax risk","Labour disputes","Water and environmental costs"],watch:"Copper production volumes; AISC per pound; Grasberg underground ramp; copper LME price."},
  "NUE":{desc:"Nucor Steel â€” the largest and most profitable US steelmaker. Mini-mill model with low cost structure and strong margins.",drivers:["US infrastructure spending","Non-residential construction demand","Steel price","IRA domestic content requirements"],risks:["Steel price cyclicality","Chinese steel overcapacity","Tariff policy changes","Construction slowdown"],watch:"Steel price; capacity utilisation; earnings per diluted share vs guidance."},
  "LAC":{desc:"Lithium Americas â€” a development-stage lithium miner with the Thacker Pass project in Nevada, a large sedimentary lithium deposit.",drivers:["EV battery demand for lithium","US domestic critical mineral policy (IRA/DOE)","GM partnership and funding","Thacker Pass Phase 1 production"],risks:["Not yet in production â€” binary development risk","Permitting and environmental litigation","Lithium price collapse (2023-24)","Construction cost overruns"],watch:"Thacker Pass construction milestones; DOE loan drawdowns; lithium carbonate spot price."},
  "ALB":{desc:"Albemarle â€” the world's largest lithium producer with mines in Chile (Atacama), Australia and US operations.",drivers:["EV battery demand","Lithium price recovery","Spodumene and brine cost advantages","Long-term supply contracts"],risks:["Lithium price oversupply","Chilean water rights risk","Contract renegotiation","High capex programmes"],watch:"Lithium realised price per metric tonne; volume sold; cost of production per tonne."},
  "UEC":{desc:"Uranium Energy Corp â€” a US-based uranium exploration and development company with ISR (in-situ recovery) projects in Wyoming and Texas.",drivers:["Uranium price recovery","Nuclear renaissance globally","US domestic uranium preference","AI data centre power needs driving nuclear"],risks:["Uranium price volatility","Project development timeline","Regulatory approval risk","Small cap liquidity"],watch:"Uranium spot price (U3O8); production commencement at Burke Hollow; contract book."},
  "NNE":{desc:"Nano Nuclear Energy â€” an early-stage developer of micro nuclear reactors (microreactors) for remote and defence applications. Highly speculative.",drivers:["Small modular reactor (SMR) interest","US DoD remote power needs","Nuclear energy renaissance narrative","AI power demand"],risks:["No operational reactors â€” concept stage","Years from any revenue","Massive capital requirement","Regulatory and public acceptance"],watch:"NRC regulatory filings; DoD contract awards; capital raise terms."},
  "BHP":{desc:"BHP Group â€” the world's largest mining company by market cap. Diversified across iron ore, copper, coal and potash.",drivers:["Iron ore price (China steel demand)","Copper demand (energy transition)","Potash (Jansen project)","BHP operational cost discipline"],risks:["China property sector slowdown","Iron ore price collapse","ESG scrutiny","Currency (AUD/BRL)"],watch:"Iron ore and copper price; China PMI and steel production data; Jansen potash timeline."},
  "RIO":{desc:"Rio Tinto â€” a mining giant focused on iron ore (Pilbara), aluminium, copper and lithium via its Rincon project.",drivers:["Iron ore demand from China","Copper and aluminium prices","Simandou iron ore project ramp","Lithium via Rincon"],risks:["China construction slowdown","Iron ore oversupply","ESG and indigenous land controversy","AUD/USD exposure"],watch:"Pilbara iron ore shipments; China steel production; Simandou project milestones."},
  "VALE":{desc:"Vale SA â€” the world's largest iron ore producer and a major nickel miner. Brazilian listed, USD-priced commodities.",drivers:["Chinese iron ore and steel demand","Nickel demand for EV batteries","Vale cost of production vs peers","Brazil political stability"],risks:["Iron ore price risk","Samarco dam liability","BRL/USD currency risk","Brazilian regulatory environment"],watch:"Iron ore price; C1 cash cost per tonne; quarterly production volumes; Samarco settlement."},
  "BTC-USD":{desc:"Bitcoin â€” the original cryptocurrency. A decentralised store of value and speculative asset with a fixed 21M coin supply.",drivers:["Spot ETF inflows (BlackRock, Fidelity)","Halving cycle (supply reduction)","Institutional adoption","Macro risk-on sentiment"],risks:["Regulatory crackdown (SEC, global)","Exchange hacks or failures","Extreme volatility","Energy consumption criticism"],watch:"ETF inflows/outflows daily; halving cycle timing; Fed rate trajectory; on-chain whale movements."},
  "ETH-USD":{desc:"Ethereum â€” the programmable blockchain powering DeFi, NFTs, stablecoins and smart contracts. Proof-of-Stake since the Merge.",drivers:["DeFi and stablecoin TVL growth","Layer 2 scaling (Arbitrum, Optimism)","ETH ETF demand","Dencun upgrade (blob transactions)"],risks:["Competition from Solana and L2s","Regulatory uncertainty","Gas fee competitiveness","Validator centralisation concerns"],watch:"ETH ETF flows; L2 transaction volumes; stablecoin total value locked; staking yield."},
  "SOL-USD":{desc:"Solana â€” a high-throughput Layer 1 blockchain known for fast and cheap transactions. Home of memecoins and consumer crypto apps.",drivers:["High transaction throughput","Meme coin trading volumes","DePIN and consumer app growth","FTX estate selling overhang clearing"],risks:["Network outages history","FTX/Alameda overhang","Centralisation concerns","ETH ecosystem competition"],watch:"Daily active addresses; DEX trading volumes; memecoin activity; validator count."},
  "XRP-USD":{desc:"XRP â€” Ripple's digital payment token used for cross-border settlements. SEC lawsuit largely resolved in Ripple's favour.",drivers:["SEC lawsuit resolution","Bank and payment provider partnerships","Ripple ODL (On-Demand Liquidity) adoption","XRP ETF speculation"],risks:["Regulatory uncertainty globally","Centralisation criticism (Ripple holds large XRP)","Competition from SWIFT upgrades","Retail speculation driven"],watch:"Ripple ODL transaction volume; XRP ETF application progress; central bank digital currency competition."},
  "DOGE-USD":{desc:"Dogecoin â€” the original memecoin. Value is primarily driven by social media sentiment, celebrity endorsements and speculative momentum.",drivers:["Elon Musk mentions and DOGE-related branding","Retail speculative inflows","Payment acceptance (Tesla, others)","Crypto bull market sentiment"],risks:["No fundamental utility beyond speculation","Unlimited supply inflation","Sentiment-driven â€” reverses fast","Elon influence waning"],watch:"Social media sentiment; Musk Twitter/X activity; crypto market momentum; exchange inflows."},
  "COIN":{desc:"Coinbase â€” the largest US crypto exchange. Revenue is highly correlated to crypto trading volumes and market sentiment.",drivers:["Crypto trading volume (bull market)","USDC stablecoin revenue","Institutional custody growth","Regulatory clarity (US)"],risks:["Trading revenue collapses in bear markets","SEC regulatory risk","Competition from Binance internationally","BTC ETF reducing exchange reliance"],watch:"Trading volume monthly; USDC market cap; subscription/services revenue growth; SEC interactions."},
  "MSTR":{desc:"MicroStrategy â€” a business intelligence company that transformed itself into a leveraged Bitcoin holding vehicle. Essentially a BTC proxy.",drivers:["Bitcoin price appreciation","Leverage amplifies BTC upside","BTC ETF narrative","Michael Saylor brand and advocacy"],risks:["Leveraged BTC exposure amplifies downside","Convertible note repayment risk if BTC falls","Dilution via equity raises","Regulatory risk"],watch:"Bitcoin price; MicroStrategy's BTC per share metric; convertible note terms; dilution events."},
  "EURUSD=X":{desc:"EUR/USD â€” the world's most traded forex pair. Driven by ECB vs Fed rate differential and Eurozone vs US economic momentum.",drivers:["Fed vs ECB interest rate differential","Eurozone economic growth","US dollar strength/weakness","Geopolitical risk (Ukraine, EU energy)"],risks:["ECB rate cuts ahead of Fed","Eurozone recession","Energy price shocks","Political instability (France, Italy)"],watch:"Fed and ECB meeting outcomes; inflation differentials; Eurozone PMI vs US PMI."},
  "GBPUSD=X":{desc:"GBP/USD (Cable) â€” the British pound vs US dollar. Sensitive to UK economic data, Bank of England policy and post-Brexit trade dynamics.",drivers:["BoE vs Fed rate differential","UK inflation data","UK employment and growth data","Post-Brexit trade agreement developments"],risks:["UK stagflation risk","BoE cutting rates ahead of Fed","Political uncertainty","Trade deficit"],watch:"BoE rate decisions; UK CPI and employment; US NFP and Fed decisions."},
  "USDJPY=X":{desc:"USD/JPY â€” the key carry trade pair. Japan's ultra-low rates have kept yen weak. BOJ policy shifts cause dramatic reversals.",drivers:["BOJ yield curve control policy","US-Japan rate differential","Risk-on sentiment (carry trade)","Japanese inflation data"],risks:["BOJ sudden policy shift (yen spike)","Carry trade unwind events","US recession reducing dollar","Japanese intervention"],watch:"BOJ meeting decisions; Japan CPI; US Treasury yields; risk sentiment in global markets."},
  "USDCAD=X":{desc:"USD/CAD â€” the 'Loonie'. Highly correlated to oil prices since Canada is a major oil exporter. Also sensitive to US-Canada trade.",drivers:["WTI crude oil price","Bank of Canada vs Fed rate policy","US-Canada trade relationship","Canadian employment data"],risks:["Oil price decline","BoC cutting aggressively","USMCA trade tensions","Housing market correction in Canada"],watch:"WTI oil price; BoC rate decisions; Canadian jobs data; trade policy announcements."},
  "RKLB":{desc:"Rocket Lab USA â€” a small launch provider and spacecraft manufacturer. Electron rocket dominates the small satellite market.",drivers:["Neutron medium-lift rocket development","US government launch contracts","Satellite component manufacturing revenue","Space economy growth"],risks:["Neutron development risk and timeline","SpaceX Falcon 9 dominance in medium lift","Launch failures","Cash burn"],watch:"Electron launch cadence; Neutron milestones; backlog growth; Space Systems revenue."},
  "ASTS":{desc:"AST SpaceMobile â€” building a broadband satellite constellation to deliver 4G/5G direct-to-smartphone coverage globally.",drivers:["BlueBird satellite constellation commercial launch","Telecom partner agreements (AT&T, Vodafone)","US government/DoD interest","Global mobile broadband coverage TAM"],risks:["Execution risk â€” most satellites not yet launched","Capital intensity is enormous","Spectrum and regulatory risk","SpaceX Starlink competition"],watch:"BlueBird satellite deployments; MNO partner commercial agreements; revenue from services."},
  "LMT":{desc:"Lockheed Martin â€” the world's largest defence contractor. F-35 fighter jet programme is the backbone of revenue.",drivers:["US defence budget growth","F-35 international orders","Missile and hypersonic systems","Ukraine/NATO rearmament spending"],risks:["F-35 programme cost overruns","Government contract renegotiation","Supply chain for advanced systems","Political will to cut defence spending"],watch:"F-35 delivery rate; missile/hypersonic contract wins; international order backlog."},
  "AMZN":{desc:"Amazon â€” the world's largest e-commerce company and cloud computing leader via AWS. AWS generates most operating profit.",drivers:["AWS cloud growth and AI services","Advertising revenue growth","Prime ecosystem retention","Logistics efficiency gains"],risks:["AWS growth slowdown","Antitrust/regulatory risk","Macro consumer spending weakness","Capex intensity for AI infrastructure"],watch:"AWS revenue growth rate; operating margin expansion; advertising segment growth; AI service revenue."},
  "TSLA":{desc:"Tesla â€” the dominant EV maker and clean energy company. Also developing Autopilot/FSD, Optimus robot and energy storage.",drivers:["EV volume growth globally","FSD revenue recognition","Energy storage (Powerwall/Megapack) growth","Optimus robot long-term optionality","Lower-cost EV models"],risks:["Elon Musk distraction / brand damage","EV price war and margin compression","Chinese competition (BYD)","FSD regulatory approval"],watch:"Vehicle deliveries per quarter; gross margin per vehicle; FSD attach rate; energy storage MWh deployed."},
  "NFLX":{desc:"Netflix â€” the world's largest streaming service with 270M+ subscribers. Advertising tier and crackdown on password sharing are growth levers.",drivers:["Paid subscriber growth","Ad-supported tier revenue","Password sharing crackdown conversion","Content hit slate (originals)"],risks:["Streaming market saturation","Content cost inflation","Competition (Disney+, HBO Max)","Macro impact on discretionary spending"],watch:"Paid net subscriber additions; average revenue per user; advertising revenue ramp; content slate strength."},
  "GME":{desc:"GameStop â€” a brick-and-mortar video game retailer that became the ultimate meme stock in 2021. Fundamentals are weak.",drivers:["Short squeeze potential (retail Reddit activity)","Ryan Cohen leadership optionality","Cash pile from equity raises","Any pivot announcement"],risks:["Structural decline of physical game retail","No clear profitable business model","Meme stock â€” sentiment driven, not fundamentals","Dilution risk"],watch:"Short interest percentage; Reddit/WallStreetBets sentiment; cash balance; any business model pivot news."},
  "NKE":{desc:"Nike â€” the world's largest athletic footwear and apparel brand. Iconic brand with a global distribution network.",drivers:["Direct-to-consumer (Nike.com, SNKRS) growth","Emerging market expansion (China, India)","Innovation pipeline (new shoe tech)","Sports endorsement deals"],risks:["China geopolitical risk (~15% revenue)","Brand heat cycles (is Nike cool right now?)","Competition from Hoka, On Running, New Balance","Inventory management"],watch:"Greater China revenue; DTC digital penetration; gross margin; inventory levels."},
  "JPM":{desc:"JPMorgan Chase â€” the most profitable US bank. Diversified across investment banking, consumer banking, asset management and markets.",drivers:["Net interest income from high rates","Investment banking fee recovery","Asset management growth","Credit quality stability"],risks:["Rate cut cycle reducing NII","Credit losses in consumer and commercial","Regulatory capital requirements","Market downturn hitting IB fees"],watch:"Net interest income guidance; CET1 capital ratio; investment banking fee revenue; credit card charge-off rate."},
  "GS":{desc:"Goldman Sachs â€” the premier investment bank. Revenue is heavily tied to capital markets activity, M&A and asset management.",drivers:["M&A and IPO cycle recovery","Fixed income trading","Asset and wealth management AUM growth","Rate environment for net interest income"],risks:["Dealmaking slowdown","Marcus consumer banking retreat","Regulatory capital charges","Talent retention cost"],watch:"Investment banking revenue; trading volumes; asset management fee income; cost/income ratio."},
  "V":{desc:"Visa â€” the world's largest payments network. A capital-light tollbooth on global consumer spending. Not a lender â€” no credit risk.",drivers:["Global consumer spending growth","Cross-border travel recovery","Value-added services growth","Tap-to-pay and tokenisation adoption"],risks:["Regulation (interchange fees, Durbin)","Real-time payments disintermediation","Central bank digital currencies","Antitrust risk"],watch:"Payment volume growth; cross-border volume growth; value-added services revenue; US vs international split."},
  "SOFI":{desc:"SoFi Technologies â€” a digital-first neobank offering student loans, mortgages, personal loans, banking, investing and insurance.",drivers:["Member growth and cross-sell","Financial services segment (bank)","Student loan refinancing recovery","Tech Platform (Galileo/Technisys) revenue"],risks:["Credit quality in rising rate/recession environment","Student loan policy uncertainty","Neobank competition (Chime, etc.)","Profitability timeline"],watch:"Adjusted EBITDA; member growth; financial services segment revenue; non-performing loan ratio."},
  "UPST":{desc:"Upstart Holdings â€” an AI-powered lending marketplace that sources personal and auto loans, using non-traditional credit scoring.",drivers:["AI credit model outperformance vs FICO","Bank and credit union partner growth","Auto loan market expansion","Rate cycle turning positive for loan volumes"],risks:["Loan default rates in recession","Funding partner concentration","Interest rate sensitivity (loan volume collapses when rates high)","Competition from traditional lenders adopting AI"],watch:"Loan origination volumes; conversion rate; funding partner count; default rates on cohorts."},
  "ADM":{desc:"Archer-Daniels-Midland â€” a global grain processor, trader and originator. One of the 'ABCD' companies controlling global food supply chains.",drivers:["Grain trading margins","Ethanol and biofuel demand","South American harvest size","Food ingredient pricing power"],risks:["Accounting investigation overhang (2024)","Commodity price volatility","FX exposure (BRL heavy)","Competition from Bunge, Cargill, Louis Dreyfus"],watch:"Operating profit by segment; grain volumes; accounting investigation resolution; BRL/USD."},
  "DE":{desc:"John Deere â€” the world's dominant agricultural and construction equipment maker. Precision agriculture is its technology moat.",drivers:["US and Brazil farm incomes (crop prices)","Precision agriculture tech adoption","Construction equipment demand","International market expansion"],risks:["Farm income cycle tied to corn/soy prices","High dealer inventory","Macro construction slowdown","Right-to-repair legislative risk"],watch:"Equipment order backlog; crop prices (corn, soy); production guidance; Precision Ag technology revenue."},
};

// â”€â”€ ASSETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ASSETS=[
  {ticker:"NVDA",name:"NVIDIA",sector:"Technology",sub:"Semiconductors",cap:"Large",priceRange:[100,200],vol:"Low"},
  {ticker:"AMD",name:"AMD",sector:"Technology",sub:"Semiconductors",cap:"Large",priceRange:[80,180],vol:"Med"},
  {ticker:"INTC",name:"Intel",sector:"Technology",sub:"Semiconductors",cap:"Large",priceRange:[18,45],vol:"Med"},
  {ticker:"MSFT",name:"Microsoft",sector:"Technology",sub:"Software",cap:"Large",priceRange:[300,500],vol:"Low"},
  {ticker:"GOOGL",name:"Alphabet",sector:"Technology",sub:"Software",cap:"Large",priceRange:[140,200],vol:"Low"},
  {ticker:"META",name:"Meta Platforms",sector:"Technology",sub:"Social Media",cap:"Large",priceRange:[300,600],vol:"Med"},
  {ticker:"AAPL",name:"Apple",sector:"Technology",sub:"Hardware",cap:"Large",priceRange:[150,230],vol:"Low"},
  {ticker:"SOUN",name:"SoundHound AI",sector:"Technology",sub:"AI / ML",cap:"Micro",priceRange:[3,18],vol:"VHigh"},
  {ticker:"BBAI",name:"BigBear.ai",sector:"Technology",sub:"AI / ML",cap:"Micro",priceRange:[1,8],vol:"VHigh"},
  {ticker:"CRWD",name:"CrowdStrike",sector:"Technology",sub:"Cybersecurity",cap:"Large",priceRange:[200,380],vol:"Med"},
  {ticker:"PANW",name:"Palo Alto Networks",sector:"Technology",sub:"Cybersecurity",cap:"Large",priceRange:[150,400],vol:"Med"},
  {ticker:"IONQ",name:"IonQ",sector:"Technology",sub:"Quantum",cap:"Small",priceRange:[6,40],vol:"High"},
  {ticker:"QUBT",name:"Quantum Computing",sector:"Technology",sub:"Quantum",cap:"Nano",priceRange:[0.5,8],vol:"Extreme"},
  {ticker:"MRNA",name:"Moderna",sector:"Healthcare",sub:"Pharma",cap:"Mid",priceRange:[35,130],vol:"High"},
  {ticker:"PFE",name:"Pfizer",sector:"Healthcare",sub:"Pharma",cap:"Large",priceRange:[20,50],vol:"Low"},
  {ticker:"JNJ",name:"Johnson & Johnson",sector:"Healthcare",sub:"Pharma",cap:"Large",priceRange:[140,175],vol:"Low"},
  {ticker:"RXRX",name:"Recursion Pharma",sector:"Healthcare",sub:"Biotech",cap:"Small",priceRange:[3,20],vol:"High"},
  {ticker:"NTLA",name:"Intellia",sector:"Healthcare",sub:"CRISPR",cap:"Small",priceRange:[10,55],vol:"High"},
  {ticker:"ISRG",name:"Intuitive Surgical",sector:"Healthcare",sub:"MedTech",cap:"Large",priceRange:[300,450],vol:"Low"},
  {ticker:"XOM",name:"ExxonMobil",sector:"Energy",sub:"Oil & Gas",cap:"Large",priceRange:[95,130],vol:"Low"},
  {ticker:"BP",name:"BP plc",sector:"Energy",sub:"Oil & Gas",cap:"Large",priceRange:[25,45],vol:"Low"},
  {ticker:"CVX",name:"Chevron",sector:"Energy",sub:"Oil & Gas",cap:"Large",priceRange:[130,175],vol:"Low"},
  {ticker:"PLUG",name:"Plug Power",sector:"Energy",sub:"Hydrogen",cap:"Small",priceRange:[1,15],vol:"VHigh"},
  {ticker:"FSLR",name:"First Solar",sector:"Energy",sub:"Solar",cap:"Mid",priceRange:[100,250],vol:"Med"},
  {ticker:"NEE",name:"NextEra Energy",sector:"Energy",sub:"Renewables",cap:"Large",priceRange:[50,85],vol:"Low"},
  {ticker:"GLD",name:"SPDR Gold ETF",sector:"Metals",sub:"Gold",cap:"Large",priceRange:[170,230],vol:"Low"},
  {ticker:"SLV",name:"iShares Silver ETF",sector:"Metals",sub:"Silver",cap:"Mid",priceRange:[20,35],vol:"Med"},
  {ticker:"GFI",name:"Gold Fields",sector:"Metals",sub:"Gold Miners",cap:"Mid",priceRange:[10,20],vol:"Med"},
  {ticker:"FCX",name:"Freeport-McMoRan",sector:"Metals",sub:"Copper",cap:"Large",priceRange:[35,60],vol:"Med"},
  {ticker:"NUE",name:"Nucor Steel",sector:"Metals",sub:"Steel",cap:"Large",priceRange:[120,180],vol:"Med"},
  {ticker:"LAC",name:"Lithium Americas",sector:"Minerals",sub:"Lithium",cap:"Small",priceRange:[2,20],vol:"VHigh"},
  {ticker:"ALB",name:"Albemarle",sector:"Minerals",sub:"Lithium",cap:"Mid",priceRange:[40,150],vol:"High"},
  {ticker:"UEC",name:"Uranium Energy",sector:"Minerals",sub:"Uranium",cap:"Small",priceRange:[4,12],vol:"High"},
  {ticker:"NNE",name:"Nano Nuclear Energy",sector:"Minerals",sub:"Nuclear",cap:"Micro",priceRange:[5,45],vol:"Extreme"},
  {ticker:"BHP",name:"BHP Group",sector:"Minerals",sub:"Diversified Mining",cap:"Large",priceRange:[40,70],vol:"Low"},
  {ticker:"RIO",name:"Rio Tinto",sector:"Minerals",sub:"Diversified Mining",cap:"Large",priceRange:[55,80],vol:"Low"},
  {ticker:"VALE",name:"Vale SA",sector:"Minerals",sub:"Iron Ore",cap:"Large",priceRange:[10,20],vol:"Med"},
  {ticker:"BTC-USD",name:"Bitcoin",sector:"Crypto",sub:"Layer 1",cap:"Large",priceRange:[25000,100000],vol:"Extreme"},
  {ticker:"ETH-USD",name:"Ethereum",sector:"Crypto",sub:"Layer 1",cap:"Large",priceRange:[1500,5000],vol:"Extreme"},
  {ticker:"SOL-USD",name:"Solana",sector:"Crypto",sub:"Layer 1",cap:"Mid",priceRange:[20,250],vol:"Extreme"},
  {ticker:"XRP-USD",name:"XRP",sector:"Crypto",sub:"Payments",cap:"Large",priceRange:[0.3,3],vol:"Extreme"},
  {ticker:"DOGE-USD",name:"Dogecoin",sector:"Crypto",sub:"Meme",cap:"Mid",priceRange:[0.05,0.5],vol:"Extreme"},
  {ticker:"COIN",name:"Coinbase",sector:"Crypto",sub:"Exchange",cap:"Mid",priceRange:[100,330],vol:"VHigh"},
  {ticker:"MSTR",name:"MicroStrategy",sector:"Crypto",sub:"BTC Treasury",cap:"Mid",priceRange:[100,600],vol:"Extreme"},
  {ticker:"EURUSD=X",name:"EUR/USD",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[1.05,1.15],vol:"Low"},
  {ticker:"GBPUSD=X",name:"GBP/USD",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[1.22,1.32],vol:"Low"},
  {ticker:"USDJPY=X",name:"USD/JPY",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[130,155],vol:"Low"},
  {ticker:"USDCAD=X",name:"USD/CAD",sector:"Forex",sub:"Major Pair",cap:"Large",priceRange:[1.30,1.40],vol:"Low"},
  {ticker:"RKLB",name:"Rocket Lab USA",sector:"Space",sub:"Launch",cap:"Small",priceRange:[4,26],vol:"High"},
  {ticker:"ASTS",name:"AST SpaceMobile",sector:"Space",sub:"Satellite",cap:"Small",priceRange:[5,40],vol:"VHigh"},
  {ticker:"LMT",name:"Lockheed Martin",sector:"Space",sub:"Defence",cap:"Large",priceRange:[400,550],vol:"Low"},
  {ticker:"AMZN",name:"Amazon",sector:"Consumer",sub:"E-Commerce",cap:"Large",priceRange:[120,220],vol:"Med"},
  {ticker:"TSLA",name:"Tesla",sector:"Consumer",sub:"EV",cap:"Large",priceRange:[150,400],vol:"High"},
  {ticker:"NFLX",name:"Netflix",sector:"Consumer",sub:"Streaming",cap:"Large",priceRange:[400,800],vol:"Med"},
  {ticker:"GME",name:"GameStop",sector:"Consumer",sub:"Gaming",cap:"Small",priceRange:[8,30],vol:"Extreme"},
  {ticker:"NKE",name:"Nike",sector:"Consumer",sub:"Apparel",cap:"Large",priceRange:[70,120],vol:"Low"},
  {ticker:"JPM",name:"JPMorgan Chase",sector:"Finance",sub:"Banking",cap:"Large",priceRange:[150,230],vol:"Low"},
  {ticker:"GS",name:"Goldman Sachs",sector:"Finance",sub:"Banking",cap:"Large",priceRange:[350,550],vol:"Med"},
  {ticker:"V",name:"Visa",sector:"Finance",sub:"Payments",cap:"Large",priceRange:[220,310],vol:"Low"},
  {ticker:"SOFI",name:"SoFi Technologies",sector:"Finance",sub:"Fintech",cap:"Small",priceRange:[5,22],vol:"High"},
  {ticker:"UPST",name:"Upstart Holdings",sector:"Finance",sub:"Fintech",cap:"Small",priceRange:[10,80],vol:"VHigh"},
  {ticker:"ADM",name:"Archer-Daniels",sector:"Agriculture",sub:"Grain",cap:"Large",priceRange:[45,80],vol:"Low"},
  {ticker:"DE",name:"John Deere",sector:"Agriculture",sub:"Machinery",cap:"Large",priceRange:[350,500],vol:"Low"},
];

const CAP_TIERS={Nano:0,Micro:1,Small:2,Mid:3,Large:4};
const CAP_COLORS={Nano:"#ea80fc",Micro:"#ff6d00",Small:"#ffd600",Mid:"#00e676",Large:"#00b0ff"};
const RISK_CFG={CRITICAL:{label:"CRITICAL",color:"#ff1744",bg:"#160004"},HIGH:{label:"HIGH",color:"#ff6d00",bg:"#160900"},MODERATE:{label:"MODERATE",color:"#ffd600",bg:"#141000"},POSITIVE:{label:"OPPORTUNITY",color:"#00e676",bg:"#00160a"},STRONG:{label:"STRONG",color:"#00b0ff",bg:"#00091a"}};
const TF_PROFILES={"âš¡ Intraday":{short:"0-24h",color:"#ff6d00",icon:"âš¡",simDays:0.5},"ðŸ“ˆ Short Swing":{short:"2-5d",color:"#ffd600",icon:"ðŸ“ˆ",simDays:3.5},"ðŸŒŠ Medium Swing":{short:"1-4wk",color:"#00d4ff",icon:"ðŸŒŠ",simDays:17.5},"ðŸ”ï¸ Position":{short:"1-6mo",color:"#00e676",icon:"ðŸ”ï¸",simDays:105},"ðŸŒ³ Long Term":{short:"6mo+",color:"#aed581",icon:"ðŸŒ³",simDays:548}};
const TF_KEYS=Object.keys(TF_PROFILES);
const WATCH_DURATIONS=[{label:"24 hours",ms:86400000,tf:"âš¡ Intraday"},{label:"3 days",ms:259200000,tf:"ðŸ“ˆ Short Swing"},{label:"5 days",ms:432000000,tf:"ðŸ“ˆ Short Swing"},{label:"1 week",ms:604800000,tf:"ðŸŒŠ Medium Swing"},{label:"2 weeks",ms:1209600000,tf:"ðŸŒŠ Medium Swing"},{label:"1 month",ms:2592000000,tf:"ðŸ”ï¸ Position"},{label:"3 months",ms:7776000000,tf:"ðŸ”ï¸ Position"},{label:"6 months",ms:15552000000,tf:"ðŸŒ³ Long Term"}];
const SECTORS=["All",...new Set(ASSETS.map(a=>a.sector))];
const CAPS=["All","Nano","Micro","Small","Mid","Large"];

// â”€â”€ SIGNAL ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sr(seed,min,max){const x=Math.sin(seed+1)*10000;return min+(x-Math.floor(x))*(max-min);}
function generateSignals(asset,key){
  const s=asset.ticker.split("").reduce((a,c)=>a+c.charCodeAt(0),0)+key;
  const r=(min,max,o=0)=>sr(s+o,min,max);
  const capTier=CAP_TIERS[asset.cap]??2;
  const volMod={Low:0.6,Med:0.8,High:1.0,VHigh:1.2,Extreme:1.5}[asset.vol]||1;
  const rsi=r(18,82,1),macd=r(-1,1,2),volume=r(0.4,4.0,3),sentiment=r(-1,1,4);
  const shortInt=r(0,35,5),earningsBeat=r(-25,40,6),priceVsMA50=r(-30,40,7),priceVsMA200=r(-40,50,8);
  const insiderBuy=r(0,1,9),catalystNews=r(-1,1,10),sectorFlow=r(-1,1,11);
  const daysToEarnings=r(0,90,13),debtRatio=r(0,3,14),revGrowth=r(-20,120,15);
  let score=0;
  score+=rsi<30?22:rsi>72?-18:(50-rsi)*0.3;
  score+=macd*18;score+=(volume-1)*10;score+=sentiment*22;
  score+=shortInt>25?-18:shortInt<5?12:0;
  score+=earningsBeat*0.5;score+=priceVsMA50<-20?14:priceVsMA50>30?-10:0;
  score+=insiderBuy>0.7?18:0;score+=catalystNews*18;score+=sectorFlow*12;
  score+=revGrowth>50?18:revGrowth<-10?-12:0;score+=debtRatio>2?-14:0;
  if(asset.sector==="Technology")score+=sectorFlow>0.3?15:0;
  if(asset.sub==="Uranium"||asset.sub==="Nuclear")score+=18;
  if(asset.sector==="Space")score+=12;
  if(asset.sector==="Crypto")score+=r(0,1,34)>0.5?18:-14;
  if(asset.sector==="Metals")score+=r(0,1,35)>0.4?10:0;
  if(asset.sector==="Forex")score=score*0.4;
  score=Math.max(-100,Math.min(100,score));
  const risk=score<-55?"CRITICAL":score<-15?"HIGH":score<18?"MODERATE":score<55?"POSITIVE":"STRONG";
  const price=sr(s+42,asset.priceRange[0],asset.priceRange[1]);
  const stopPct=capTier<=1?0.15:capTier===2?0.10:asset.sector==="Forex"?0.02:0.07;
  const maxUpside=capTier===0?400:capTier===1?200:capTier===2?100:capTier===3?50:asset.sector==="Crypto"?200:30;
  const upsidePct=score>0?(score/100)*maxUpside:0;
  const rrRatio=stopPct>0?((upsidePct/100)/stopPct).toFixed(1):"0";
  const entryQ=rsi<35&&priceVsMA50<-10?"IDEAL":rsi<50&&volume>1.2?"GOOD":rsi>68?"POOR":"FAIR";
  const tfScores={};
  tfScores["âš¡ Intraday"]=Math.max(5,Math.min(95,(Math.max(0,(volume-1.5)*35)+(shortInt>20&&volume>2?25:0)+(rsi>28&&rsi<52?12:0)+(catalystNews>0.5?20:0)+(macd>0.3?8:0)-(rsi>70?15:0))*volMod));
  tfScores["ðŸ“ˆ Short Swing"]=Math.max(5,Math.min(95,(macd>0?22:0)+(rsi<45&&rsi>25?20:0)+(volume>1.3?15:0)+(earningsBeat>10?18:0)+(priceVsMA50<-10?12:0)+(catalystNews>0?10:0)-(debtRatio>2?10:0)));
  tfScores["ðŸŒŠ Medium Swing"]=Math.max(5,Math.min(95,(sectorFlow>0.2?22:0)+(revGrowth>20?20:0)+(macd>0?14:0)+(volume>1.1?10:0)+(priceVsMA200<-15?15:0)+(insiderBuy>0.5?12:0)+(daysToEarnings<30?14:0)-(debtRatio>2?12:0)));
  tfScores["ðŸ”ï¸ Position"]=Math.max(5,Math.min(95,(revGrowth>30?28:revGrowth>10?16:0)+(insiderBuy>0.65?22:0)+(debtRatio<1?18:debtRatio<2?8:0)+(sectorFlow>0.3?15:0)+(capTier>=2?10:0)));
  tfScores["ðŸŒ³ Long Term"]=Math.max(5,Math.min(95,(revGrowth>20?25:0)+(debtRatio<1.5?20:0)+(capTier>=3?22:capTier===2?12:0)+(insiderBuy>0.5?15:0)+(sectorFlow>0?10:0)));
  const bestTF=Object.entries(tfScores).sort((a,b)=>b[1]-a[1])[0][0];
  return{score:Math.round(score),risk,price:parseFloat(price.toFixed(4)),upsidePct:parseFloat(upsidePct.toFixed(1)),stopPct:parseFloat((stopPct*100).toFixed(1)),rrRatio,entryQ,tfScores,bestTF,livePrice:false,changePct:0,metrics:{rsi,macd,volume,sentiment,shortInt,revGrowth,debtRatio,daysToEarnings,earningsBeat,priceVsMA50,insiderBuy,catalystNews,sectorFlow}};
}
function mergeLiveData(sig,liveData,asset){
  const live=liveData?.[asset.ticker];
  if(!live?.price) return sig;
  const realPrice=live.currency==="GBX"?live.price/100:live.price;
  const changeSign=live.change_pct>0?1:live.change_pct<0?-1:0;
  return{...sig,price:parseFloat(realPrice.toFixed(4)),livePrice:true,marketState:live.market_state||"CLOSED",currency:live.currency||"USD",changePct:live.change_pct||0,metrics:{...sig.metrics,rsi:Math.max(10,Math.min(90,sig.metrics.rsi+(changeSign*8)))}};
}

// â”€â”€ SPARKLINE CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateSparklineData(asset,sig,days=30){
  const seed=asset.ticker.split("").reduce((a,c)=>a+c.charCodeAt(0),0);
  const volF={Low:0.008,Med:0.015,High:0.025,VHigh:0.04,Extreme:0.065}[asset.vol]||0.015;
  const bias=(sig.score/100)*0.002;
  const pts=[];
  let price=sig.price;
  // Walk backwards then forward so current price is anchored to live/sim price
  const rawPts=[];
  let tmp=price;
  for(let i=days;i>=0;i--){
    const r=sr(seed+i*31+7,-1,1);
    tmp=tmp/(1+bias+r*volF);
    rawPts.unshift(tmp);
  }
  rawPts.push(price);
  return rawPts;
}

function Sparkline({asset,sig,height=50,width="100%"}){
  const ref=useRef(null);
  const data=useMemo(()=>generateSparklineData(asset,sig,30),[asset.ticker,sig.score]);
  useEffect(()=>{
    const el=ref.current;if(!el)return;
    const W=el.clientWidth||200,H=height;
    const min=Math.min(...data),max=Math.max(...data),range=max-min||1;
    const pts=data.map((v,i)=>{
      const x=(i/(data.length-1))*W;
      const y=H-((v-min)/range)*(H-4)-2;
      return`${x},${y}`;
    }).join(" ");
    const last=data[data.length-1];
    const first=data[0];
    const up=last>=first;
    const color=up?"#00e676":"#ff1744";
    el.innerHTML=`<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
      <defs><linearGradient id="sg${asset.ticker.replace(/[^a-z0-9]/gi,'')}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient></defs>
      <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/>
    </svg>`;
  },[data,height]);
  return <div ref={ref} style={{width,height,overflow:"hidden"}}/>;
}

// â”€â”€ TF TOOLTIP TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTfTooltip(dur,sig){
  const m=sig.metrics;
  const sc=sig.tfScores[dur.tf];
  const parts=[];
  if(dur.tf==="âš¡ Intraday"){
    if(m.volume>2)parts.push(`Volume ${m.volume.toFixed(1)}x avg â€” elevated intraday activity`);
    if(m.rsi>28&&m.rsi<52)parts.push(`RSI ${m.rsi.toFixed(0)} â€” neutral range, room to move`);
    if(m.catalystNews>0.5)parts.push("Positive catalyst detected â€” short-burst potential");
    if(m.shortInt>20&&m.volume>2)parts.push("High short interest + volume â†’ squeeze risk");
    if(m.rsi>70)parts.push(`RSI overbought (${m.rsi.toFixed(0)}) â€” intraday fade risk`);
    if(!parts.length)parts.push(`Score ${sc.toFixed(0)}% â€” moderate intraday setup`);
  } else if(dur.tf==="ðŸ“ˆ Short Swing"){
    if(m.macd>0)parts.push("MACD positive â€” upward short-term momentum");
    if(m.rsi<45&&m.rsi>25)parts.push(`RSI ${m.rsi.toFixed(0)} â€” oversold, bounce potential over 2-5 days`);
    if(m.earningsBeat>10)parts.push(`Earnings beat of +${m.earningsBeat.toFixed(0)}% supports short swing`);
    if(m.priceVsMA50<-10)parts.push(`Price ${Math.abs(m.priceVsMA50).toFixed(0)}% below 50-day MA â€” mean reversion setup`);
    if(!parts.length)parts.push(`Score ${sc.toFixed(0)}% â€” mixed short swing signals`);
  } else if(dur.tf==="ðŸŒŠ Medium Swing"){
    if(m.sectorFlow>0.2)parts.push("Positive sector rotation flow â€” medium trend support");
    if(m.revGrowth>20)parts.push(`Revenue growth ${m.revGrowth.toFixed(0)}% â€” fundamental tailwind`);
    if(m.daysToEarnings<30)parts.push(`Earnings in ~${Math.round(m.daysToEarnings)}d â€” event catalyst within window`);
    if(m.insiderBuy>0.5)parts.push("Insider buying signal detected â€” confidence from management");
    if(!parts.length)parts.push(`Score ${sc.toFixed(0)}% â€” moderate medium-term setup`);
  } else if(dur.tf==="ðŸ”ï¸ Position"){
    if(m.revGrowth>30)parts.push(`Revenue growth ${m.revGrowth.toFixed(0)}% â€” strong multi-month tailwind`);
    if(m.insiderBuy>0.65)parts.push("Strong insider buying â€” management bullish on 1-6mo outlook");
    if(m.debtRatio<1)parts.push(`Low debt ratio (${m.debtRatio.toFixed(1)}x) â€” financial stability for holds`);
    if(m.sectorFlow>0.3)parts.push("Sector rotation favours this asset over next few months");
    if(!parts.length)parts.push(`Score ${sc.toFixed(0)}% â€” moderate position trade setup`);
  } else {
    if(m.revGrowth>20)parts.push(`Revenue growth ${m.revGrowth.toFixed(0)}% â€” compelling long-term thesis`);
    if(m.debtRatio<1.5)parts.push("Conservative debt â€” durable long-term hold candidate");
    if(m.insiderBuy>0.5)parts.push("Insider accumulation â€” aligned with long-term holders");
    if(!parts.length)parts.push(`Score ${sc.toFixed(0)}% â€” moderate long-term setup`);
  }
  return parts.slice(0,3).join(" Â· ");
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtPct=(n,d=1)=>n===undefined?"â€”":`${n>0?"+":""}${parseFloat(n).toFixed(d)}%`;
const pnlColor=v=>v>0?"#00e676":v<0?"#ff1744":"#888";
const uid=()=>Math.random().toString(36).slice(2,9);
const fmtMs=ms=>{if(ms<=0)return"expired";const h=Math.floor(ms/3600000),d=Math.floor(ms/86400000),w=Math.floor(d/7),mo=Math.floor(d/30);if(mo>=1)return`${mo}mo`;if(w>=1)return`${w}wk`;if(d>=1)return`${d}d`;return`${h}h`;};
const Tag=({children,color="#888",small})=>(<span style={{fontSize:small?6:8,color,border:`1px solid ${color}44`,borderRadius:3,padding:small?"0 3px":"1px 5px",letterSpacing:1,whiteSpace:"nowrap"}}>{children}</span>);
const Pill=({label,active,color="#00b0ff",onClick})=>(<button onClick={onClick} style={{background:active?"#12121e":"transparent",border:`1px solid ${active?color:"#1a1a2e"}`,borderRadius:20,padding:"3px 10px",color:active?color:"#2a2a45",fontSize:9,whiteSpace:"nowrap"}}>{label}</button>);
const Stat=({label,value,color="#c0c0e0",sub})=>(<div style={{background:"#0a0a16",borderRadius:6,padding:"8px 10px",textAlign:"center"}}><div style={{fontSize:7,color:"#2a2a40",letterSpacing:2,marginBottom:2}}>{label}</div><div style={{fontSize:13,fontWeight:700,color,fontFamily:"monospace"}}>{value}</div>{sub&&<div style={{fontSize:7,color:"#3a3a50",marginTop:1}}>{sub}</div>}</div>);
const Modal=({onClose,children,maxWidth=460})=>(<div style={{position:"fixed",inset:0,background:"#000000dd",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:12}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{background:"#06060f",borderRadius:12,maxWidth,width:"100%",maxHeight:"92vh",overflowY:"auto"}}>{children}</div></div>);

// â”€â”€ WELCOME / AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function WelcomePage({onAuth}){
  const[mode,setMode]=useState("home");
  const[form,setForm]=useState({name:"",email:"",password:""});
  const[error,setError]=useState("");
  const[loading,setLoading]=useState(false);
  const set=k=>e=>setForm(p=>({...p,[k]:e.target.value}));
  const submit=async()=>{
    setError("");setLoading(true);
    try{
      if(mode==="signup"){
        if(!form.name.trim())throw new Error("Name is required");
        if(!form.email.includes("@"))throw new Error("Valid email required");
        if(form.password.length<6)throw new Error("Password must be 6+ characters");
        const j=await api("/api/auth/register",{method:"POST",body:JSON.stringify({name:form.name,email:form.email,password:form.password})});
        localStorage.setItem("mb_token",j.token);onAuth(j.user);
      }else{
        const j=await api("/api/auth/login",{method:"POST",body:JSON.stringify({email:form.email,password:form.password})});
        localStorage.setItem("mb_token",j.token);onAuth(j.user);
      }
    }catch(e){setError(e.message);}
    setLoading(false);
  };
  if(mode==="home") return(
    <div style={{minHeight:"100vh",background:"#03030a",display:"flex",flexDirection:"column",overflow:"auto"}}>
      <div style={{padding:"16px 24px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #0c0c18"}}>
        <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:900,letterSpacing:4,color:"#dde0ff"}}>MARKET <span style={{color:"#00b0ff"}}>BRAIN</span></div>
        <div style={{display:"flex",gap:8}}>
          <button onClick={()=>setMode("login")} style={{background:"transparent",border:"1px solid #1a1a2e",borderRadius:6,padding:"7px 16px",color:"#8a8aaa",fontSize:10,letterSpacing:1}}>LOG IN</button>
          <button onClick={()=>setMode("signup")} className="hero-btn" style={{background:"#00b0ff22",border:"1px solid #00b0ff",borderRadius:6,padding:"7px 16px",color:"#00b0ff",fontSize:10,letterSpacing:1}}>SIGN UP FREE</button>
        </div>
      </div>
      <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 24px",textAlign:"center"}}>
        <div style={{fontSize:11,color:"#00b0ff",letterSpacing:4,marginBottom:16,fontFamily:"monospace"}}>â— LIVE YAHOO FINANCE Â· NO API KEY NEEDED</div>
        <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:64,fontWeight:900,lineHeight:1,marginBottom:16,letterSpacing:2}}>
          <span style={{color:"#dde0ff"}}>TRADE SMARTER.</span><br/>
          <span style={{background:"linear-gradient(90deg,#00b0ff,#00e676)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>WITHOUT THE RISK.</span>
        </div>
        <div style={{fontSize:13,color:"#5a5a7a",maxWidth:480,lineHeight:1.8,marginBottom:40}}>Real-time signal analysis across 60+ assets. Virtual trading, timed watchlist predictions, accuracy tracking.</div>
        <div style={{display:"flex",gap:12,flexWrap:"wrap",justifyContent:"center",marginBottom:60}}>
          <button onClick={()=>setMode("signup")} className="hero-btn" style={{background:"linear-gradient(135deg,#00b0ff,#0080cc)",border:"none",borderRadius:8,padding:"14px 32px",color:"#fff",fontSize:12,letterSpacing:2,fontWeight:700,boxShadow:"0 0 40px #00b0ff44"}}>GET STARTED FREE â†’</button>
          <button onClick={()=>setMode("login")} className="hero-btn" style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:8,padding:"14px 32px",color:"#8a8aaa",fontSize:12,letterSpacing:2}}>I HAVE AN ACCOUNT</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:12,maxWidth:860,width:"100%"}}>
          {[{icon:"ðŸ“Š",title:"60+ Assets",desc:"Stocks, crypto, forex, metals and more with live prices"},{icon:"ðŸŽ¯",title:"Signal Engine",desc:"Timeframe alignment scores for every trading horizon"},{icon:"ðŸ’¼",title:"Virtual Portfolio",desc:"Practice trades, track P&L, close positions"},{icon:"â˜…",title:"Timed Watchlist",desc:"Time predictions and score the engine's accuracy"},{icon:"ðŸ“ˆ",title:"Price Charts",desc:"30-day sparkline history for every asset"},{icon:"ðŸ”´",title:"Live Prices",desc:"Real-time prices with FX conversion to your currency"}].map(f=>(<div key={f.title} style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:"16px",textAlign:"left"}}><div style={{fontSize:24,marginBottom:8}}>{f.icon}</div><div style={{fontSize:12,fontWeight:700,color:"#dde0ff",marginBottom:4}}>{f.title}</div><div style={{fontSize:10,color:"#4a4a6a",lineHeight:1.7}}>{f.desc}</div></div>))}
        </div>
      </div>
      <div style={{padding:"16px",textAlign:"center",fontSize:8,color:"#1a1a28",borderTop:"1px solid #0c0c18"}}>Market Brain Â· Virtual simulation only Â· Not financial advice</div>
    </div>
  );
  const isSignup=mode==="signup";
  return(
    <div style={{minHeight:"100vh",background:"#03030a",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:20}}>
      <div style={{width:"100%",maxWidth:400,animation:"fadeIn 0.3s ease"}}>
        <div style={{textAlign:"center",marginBottom:32}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:28,fontWeight:900,letterSpacing:4,color:"#dde0ff",marginBottom:4}}>MARKET <span style={{color:"#00b0ff"}}>BRAIN</span></div>
          <div style={{fontSize:11,color:"#4a4a6a"}}>{isSignup?"Create your free account":"Welcome back"}</div>
        </div>
        <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:12,padding:28,animation:"glow 3s infinite"}}>
          {isSignup&&<div style={{marginBottom:14}}><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:5}}>YOUR NAME</div><input value={form.name} onChange={set("name")} placeholder="John Smith" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:6,padding:"10px 12px",color:"#c0c0e0",fontSize:13}}/></div>}
          <div style={{marginBottom:14}}><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:5}}>EMAIL</div><input value={form.email} onChange={set("email")} placeholder="you@example.com" type="email" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:6,padding:"10px 12px",color:"#c0c0e0",fontSize:13}}/></div>
          <div style={{marginBottom:20}}><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:5}}>PASSWORD</div><input value={form.password} onChange={set("password")} placeholder={isSignup?"At least 6 characters":"Your password"} type="password" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:6,padding:"10px 12px",color:"#c0c0e0",fontSize:13}} onKeyDown={e=>e.key==="Enter"&&submit()}/></div>
          {error&&<div style={{background:"#ff174420",border:"1px solid #ff174444",borderRadius:6,padding:"8px 12px",fontSize:10,color:"#ff6a6a",marginBottom:14}}>{error}</div>}
          <button onClick={submit} disabled={loading} style={{width:"100%",background:loading?"#1a1a2e":"linear-gradient(135deg,#00b0ff,#0080cc)",border:"none",borderRadius:8,padding:"12px",color:loading?"#3a3a50":"#fff",fontSize:11,letterSpacing:2,fontWeight:700}}>{loading?"LOADING...":(isSignup?"CREATE ACCOUNT":"LOG IN")}</button>
          <div style={{textAlign:"center",marginTop:16,fontSize:9,color:"#4a4a6a"}}>{isSignup?"Already have an account? ":"Don't have an account? "}<span onClick={()=>{setMode(isSignup?"login":"signup");setError("");}} style={{color:"#00b0ff",cursor:"pointer"}}>{isSignup?"Log in":"Sign up free"}</span></div>
        </div>
        <button onClick={()=>setMode("home")} style={{display:"block",margin:"16px auto 0",background:"none",border:"none",color:"#3a3a55",fontSize:9}}>â† Back to home</button>
      </div>
    </div>
  );
}

// â”€â”€ TRADE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TradeModal({asset,sig,balance,fmtMoney,toLocal,onPlace,onClose}){
  const R=RISK_CFG[sig.risk];
  const[shares,setShares]=useState("");
  const[tf,setTf]=useState(sig.bestTF);
  const[stopPct,setStopPct]=useState(sig.stopPct);
  const[targetPct,setTargetPct]=useState(sig.upsidePct);
  const priceLocal=toLocal(sig.price);
  const sym=fmtMoney(sig.price).replace(/[\d.,]/g,"").trim()||"$";
  const sharesN=parseFloat(shares)||0;
  const totalCost=sharesN*priceLocal;
  const rr=parseFloat(stopPct)>0?(parseFloat(targetPct)/parseFloat(stopPct)).toFixed(1):"â€”";
  const rrOk=parseFloat(rr)>=2;
  const pctBal=balance>0?(totalCost/balance)*100:0;
  const risk2=balance*0.02;
  const suggested=parseFloat(stopPct)>0&&priceLocal>0?Math.floor(risk2/(priceLocal*parseFloat(stopPct)/100)):0;
  const canPlace=sharesN>0&&totalCost<=balance;
  return(
    <Modal onClose={onClose} maxWidth={480}>
      <div style={{background:"#0a0a16",borderBottom:`1px solid ${R.color}44`,padding:"14px 16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2}}>VIRTUAL TRADE</div><div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:700,color:"#dde0ff"}}>{asset.ticker} Â· {asset.name}</div></div>
        <div style={{textAlign:"right"}}><div style={{fontSize:16,fontWeight:700,fontFamily:"monospace",color:"#dde0ff"}}>{fmtMoney(sig.price)}</div><Tag color={R.color}>{R.label}</Tag></div>
      </div>
      <div style={{padding:"14px 16px"}}>
        <div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:6}}>TIMEFRAME</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5,marginBottom:14}}>
          {TF_KEYS.map(k=>{const p=TF_PROFILES[k],sc=sig.tfScores[k];const pc=sc>=72?"#00e676":sc>=52?"#00d4ff":sc>=35?"#ffd600":"#ff6d00";const isA=tf===k;return(<div key={k} onClick={()=>setTf(k)} style={{background:isA?p.color+"22":"#0a0a16",border:`1px solid ${isA?p.color:"#1a1a2e"}`,borderRadius:6,padding:"8px",cursor:"pointer",display:"flex",justifyContent:"space-between"}}><span style={{fontSize:9,color:isA?p.color:"#5a5a7a",fontWeight:700}}>{p.icon} {p.short}</span><span style={{fontSize:9,color:pc,fontWeight:700}}>{sc.toFixed(0)}%</span></div>);})}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
          {[["STOP LOSS %",stopPct,setStopPct],["TARGET %",targetPct,setTargetPct]].map(([l,v,fn])=>(<div key={l}><div style={{fontSize:8,color:"#2a2a40",marginBottom:4}}>{l}</div><input value={v} onChange={e=>fn(e.target.value)} style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:5,padding:"6px 8px",color:"#c0c0e0",fontSize:12}}/></div>))}
        </div>
        <div style={{marginBottom:10}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:8,color:"#2a2a40"}}>QUANTITY</span><button onClick={()=>setShares(suggested.toString())} style={{fontSize:8,color:"#00b0ff",background:"none",border:"none"}}>Use 2% rule ({suggested})</button></div>
          <input value={shares} onChange={e=>setShares(e.target.value)} placeholder="Enter quantity" style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:5,padding:"7px 10px",color:"#c0c0e0",fontSize:13}}/>
        </div>
        <div style={{background:"#0a0a16",borderRadius:7,padding:10,marginBottom:12}}>
          {[["Balance",`${sym}${balance.toFixed(2)}`,"#c0c0e0"],["Total Cost",sharesN>0?`${sym}${totalCost.toFixed(2)}`:"â€”",pctBal>30?"#ff6d00":"#c0c0e0"],["% of Account",sharesN>0?`${pctBal.toFixed(1)}%`:"â€”",pctBal>30?"#ff6d00":"#c0c0e0"],["R/R",`${rr}:1`,rrOk?"#00e676":"#ffd600"],["Max Loss",sharesN>0?`-${sym}${(totalCost*parseFloat(stopPct)/100).toFixed(2)}`:"â€”","#ff1744"],["Max Gain",sharesN>0?`+${sym}${(totalCost*parseFloat(targetPct)/100).toFixed(2)}`:"â€”","#00e676"]].map(([l,v,c])=>(<div key={l} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid #0e0e18",fontSize:10}}><span style={{color:"#4a4a6a"}}>{l}</span><span style={{color:c,fontWeight:700,fontFamily:"monospace"}}>{v}</span></div>))}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <button onClick={onClose} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:6,padding:"10px",color:"#4a4a6a",fontSize:9}}>CANCEL</button>
          <button onClick={()=>{if(!canPlace)return;onPlace({id:uid(),ticker:asset.ticker,name:asset.name,sector:asset.sector,cap:asset.cap,timeframe:tf,tfScore:sig.tfScores[tf],entryPrice:priceLocal,shares:sharesN,totalCost:parseFloat(totalCost.toFixed(2)),stopPct:parseFloat(stopPct),targetPct:parseFloat(targetPct),signalScore:sig.score,signalRisk:sig.risk,rr:parseFloat(rr),entryQ:sig.entryQ,openedAt:Date.now(),status:"open"});onClose();}} disabled={!canPlace} style={{background:canPlace?R.color+"22":"#1a1a2e",border:`1px solid ${canPlace?R.color:"#2a2a40"}`,borderRadius:6,padding:"10px",color:canPlace?R.color:"#3a3a50",fontSize:9,letterSpacing:1}}>PLACE TRADE</button>
        </div>
        <div style={{fontSize:7,color:"#1a1a28",textAlign:"center",marginTop:8}}>Virtual simulation only. Not financial advice.</div>
      </div>
    </Modal>
  );
}

// â”€â”€ WATCH MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function WatchModal({asset,sig,fmtMoney,toLocal,balance,onAdd,onPlace,onClose}){
  const[dur,setDur]=useState(WATCH_DURATIONS[0]);
  const[showTrade,setShowTrade]=useState(false);
  const tfP=TF_PROFILES[dur.tf],tfScore=sig.tfScores[dur.tf];
  const s=asset.ticker.split("").reduce((a,c)=>a+c.charCodeAt(0),0);
  const bullBias=(sig.score/100)*0.6+(tfScore/100-0.5)*0.4;
  const volF={Low:0.003,Med:0.006,High:0.012,VHigh:0.018,Extreme:0.025}[asset.vol]||0.01;
  let predPrice=sig.price;
  for(let i=0;i<Math.max(1,Math.round(TF_PROFILES[dur.tf].simDays));i++){const rand=sr(s+i*17+99,-1,1);predPrice=predPrice*(1+bullBias*volF*0.5+rand*volF);}
  const predChg=((predPrice-sig.price)/sig.price)*100;
  const predColor=predChg>0?"#00e676":"#ff1744";
  if(showTrade) return <TradeModal asset={asset} sig={sig} balance={balance} fmtMoney={fmtMoney} toLocal={toLocal} onPlace={(td)=>{onPlace(td);onClose();}} onClose={()=>setShowTrade(false)}/>;
  return(
    <Modal onClose={onClose} maxWidth={440}>
      <div style={{background:"#0a0a16",borderBottom:"1px solid #ffd60033",padding:"14px 16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div><div style={{fontSize:8,color:"#2a2a40",letterSpacing:2}}>ADD TO WATCHLIST</div><div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:700,color:"#dde0ff"}}>{asset.ticker} Â· {asset.name}</div></div>
        <div style={{fontFamily:"monospace",fontSize:15,fontWeight:700,color:"#dde0ff"}}>{fmtMoney(sig.price)}</div>
      </div>
      <div style={{padding:"14px 16px"}}>
        <div style={{fontSize:8,color:"#2a2a40",letterSpacing:2,marginBottom:8}}>WATCH DURATION <span style={{color:"#1a1a3a",fontStyle:"italic"}}>â€” hover for signal insight</span></div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5,marginBottom:14}}>
          {WATCH_DURATIONS.map(d=>{
            const isA=dur.label===d.label;
            const p=TF_PROFILES[d.tf];
            const sc=sig.tfScores[d.tf];
            const pc=sc>=72?"#00e676":sc>=52?"#00d4ff":sc>=35?"#ffd600":"#ff6d00";
            const tip=getTfTooltip(d,sig);
            return(
              <div key={d.label} className="tooltip-wrap" onClick={()=>setDur(d)} style={{background:isA?p.color+"22":"#0a0a16",border:`1px solid ${isA?p.color:"#1a1a2e"}`,borderRadius:6,padding:"9px 10px",cursor:"pointer",position:"relative"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
                  <span style={{fontSize:10,color:isA?p.color:"#6a6a8a",fontWeight:700}}>{d.label}</span>
                  <span style={{fontSize:10,color:pc,fontWeight:700,fontFamily:"monospace"}}>{sc.toFixed(0)}%</span>
                </div>
                <div style={{fontSize:7,color:isA?p.color+"aa":"#2a2a40"}}>{p.icon} {p.short}</div>
                <div className="tooltip-box">
                  <div style={{fontSize:7,color:"#00b0ff",letterSpacing:1,marginBottom:4}}>WHY THIS SCORE</div>
                  <div style={{fontSize:9,color:"#8a8acc",lineHeight:1.7}}>{tip}</div>
                </div>
              </div>
            );
          })}
        </div>
        <div style={{background:predColor+"10",border:`1px solid ${predColor}33`,borderRadius:8,padding:14,marginBottom:14}}>
          <div style={{fontSize:8,color:predColor,letterSpacing:2,marginBottom:8}}>ENGINE PROJECTION Â· {dur.label.toUpperCase()}</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,textAlign:"center"}}>
            <div><div style={{fontSize:7,color:"#2a2a40",marginBottom:2}}>NOW</div><div style={{fontSize:12,fontWeight:700,fontFamily:"monospace",color:"#c0c0e0"}}>{fmtMoney(sig.price)}</div></div>
            <div><div style={{fontSize:7,color:"#2a2a40",marginBottom:2}}>PROJECTED</div><div style={{fontSize:12,fontWeight:700,fontFamily:"monospace",color:predColor}}>{fmtMoney(predPrice)}</div></div>
            <div><div style={{fontSize:7,color:"#2a2a40",marginBottom:2}}>MOVE</div><div style={{fontSize:12,fontWeight:700,fontFamily:"monospace",color:predColor}}>{fmtPct(predChg)}</div></div>
          </div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:7}}>
          <button onClick={onClose} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:6,padding:"10px",color:"#4a4a6a",fontSize:9}}>CANCEL</button>
          <button onClick={()=>{onAdd({id:uid(),ticker:asset.ticker,name:asset.name,sector:asset.sector,cap:asset.cap,duration:dur.label,timeframe:dur.tf,tfScore,addedAt:Date.now(),expiresAt:Date.now()+dur.ms,entryPrice:sig.price,predictedPrice:parseFloat(predPrice.toFixed(4)),predictedChg:parseFloat(predChg.toFixed(2)),signalScore:sig.score,signalRisk:sig.risk,status:"watching"});onClose();}} style={{background:"#ffd60022",border:"1px solid #ffd600",borderRadius:6,padding:"10px",color:"#ffd600",fontSize:9,letterSpacing:1}}>â˜… WATCH</button>
          <button onClick={()=>setShowTrade(true)} disabled={balance<toLocal(sig.price)} style={{background:balance>=toLocal(sig.price)?"#00e67622":"#1a1a2e",border:`1px solid ${balance>=toLocal(sig.price)?"#00e676":"#2a2a40"}`,borderRadius:6,padding:"10px",color:balance>=toLocal(sig.price)?"#00e676":"#3a3a50",fontSize:9,letterSpacing:1}}>ðŸ“ˆ TRADE</button>
        </div>
      </div>
    </Modal>
  );
}

// â”€â”€ ACCURACY ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcAccuracy(trades,watchItems){
  const closed=[...trades.filter(t=>t.status!=="open"),...watchItems.filter(w=>w.status==="expired")];
  if(!closed.length) return null;
  const score=item=>item.finalPnLPct!==undefined?item.finalPnLPct:(item.actualChg||0);
  const wins=closed.filter(t=>score(t)>0).length;
  const byCap={};CAPS.filter(c=>c!=="All").forEach(cap=>{const items=closed.filter(t=>t.cap===cap);if(items.length){const w=items.filter(t=>score(t)>0).length;byCap[cap]={wins:w,total:items.length,rate:(w/items.length)*100};}});
  const bySector={};[...new Set(closed.map(t=>t.sector))].forEach(sec=>{const items=closed.filter(t=>t.sector===sec);if(items.length){const w=items.filter(t=>score(t)>0).length;bySector[sec]={wins:w,total:items.length,rate:(w/items.length)*100};}});
  return{overall:(wins/closed.length)*100,wins,total:closed.length,losses:closed.length-wins,avgReturn:closed.reduce((a,t)=>a+score(t),0)/closed.length,byCap,bySector};
}

// â”€â”€ ASSET KNOWLEDGE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function KnowledgePanel({asset}){
  const k=ASSET_KNOWLEDGE[asset.ticker];
  if(!k)return null;
  return(
    <div style={{background:"#060610",border:"1px solid #1a1a2e",borderRadius:7,padding:12,fontSize:9}}>
      <div style={{fontSize:7,color:"#00b0ff",letterSpacing:2,marginBottom:6}}>ASSET INTELLIGENCE</div>
      <p style={{color:"#8a8acc",lineHeight:1.7,marginBottom:8}}>{k.desc}</p>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
        <div>
          <div style={{fontSize:7,color:"#00e676",letterSpacing:1,marginBottom:4}}>KEY DRIVERS</div>
          {k.drivers.map((d,i)=>(<div key={i} style={{color:"#5a8a6a",marginBottom:2,fontSize:8}}>â†‘ {d}</div>))}
        </div>
        <div>
          <div style={{fontSize:7,color:"#ff6d00",letterSpacing:1,marginBottom:4}}>KEY RISKS</div>
          {k.risks.map((r,i)=>(<div key={i} style={{color:"#8a5a4a",marginBottom:2,fontSize:8}}>â†“ {r}</div>))}
        </div>
      </div>
      <div style={{borderTop:"1px solid #1a1a2e",paddingTop:7}}>
        <div style={{fontSize:7,color:"#ffd600",letterSpacing:1,marginBottom:3}}>WHAT TO WATCH</div>
        <div style={{color:"#7a7a9a",lineHeight:1.6,fontSize:8}}>{k.watch}</div>
      </div>
    </div>
  );
}

// â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MainApp({user,onLogout}){
  const[view,setView]=useState("market");
  const[allSigs,setAllSigs]=useState({});
  const[loading,setLoading]=useState(true);
  const[liveCount,setLiveCount]=useState(0);
  const[fxRates,setFxRates]=useState(null);
  const[lastUpdated,setLastUpdated]=useState(null);
  const[selected,setSelected]=useState(null);
  const[activeSector,setActiveSector]=useState("All");
  const[activeCap,setActiveCap]=useState("All");
  const[sortMode,setSortMode]=useState("bestTF");
  const[searchQ,setSearchQ]=useState("");
  const[activeCurrency,setActiveCurrency]=useState(CURRENCIES[0]);
  const[showCurrModal,setShowCurrModal]=useState(false);
  const[showTradeModal,setShowTradeModal]=useState(false);
  const[showWatchModal,setShowWatchModal]=useState(false);
  const[trades,setTrades]=useState([]);
  const[balance,setBalance]=useState(1000);
  const[startBalance,setStartBalance]=useState(1000);
  const[budgetInput,setBudgetInput]=useState("1000");
  const[showBudget,setShowBudget]=useState(false);
  const[watchItems,setWatchItems]=useState([]);
  const[tick,setTick]=useState(0);
  const[saving,setSaving]=useState(false);
  useEffect(()=>{const t=setInterval(()=>setTick(s=>s+1),10000);return()=>clearInterval(t);},[]);

  useEffect(()=>{
    api("/api/portfolio").then(p=>{
      if(p.trades)setTrades(p.trades);
      if(p.watchItems)setWatchItems(p.watchItems);
      if(p.balance!==undefined)setBalance(p.balance);
      if(p.startBalance!==undefined)setStartBalance(p.startBalance);
    }).catch(()=>{});
  },[]);

  const savePortfolio=useCallback(async(t,w,b,sb)=>{
    setSaving(true);
    try{await api("/api/portfolio",{method:"POST",body:JSON.stringify({trades:t,watchItems:w,balance:b,startBalance:sb})});}
    catch(e){}
    setSaving(false);
  },[]);

  useEffect(()=>{
    const timer=setTimeout(()=>savePortfolio(trades,watchItems,balance,startBalance),2000);
    return()=>clearTimeout(timer);
  },[trades,watchItems,balance]);

  const toLocal=useCallback((usd)=>{
    let rate;
    if(fxRates?.USD&&fxRates[activeCurrency.code]!==undefined){rate=fxRates[activeCurrency.code]/fxRates.USD;}
    else{rate=activeCurrency.fb/1.27;}
    return parseFloat((usd*rate).toFixed(4));
  },[fxRates,activeCurrency]);
  const fmtMoney=useCallback((usd)=>{const v=toLocal(usd);return`${activeCurrency.symbol}${v.toFixed(v>1000?2:v>1?2:4)}`;},[toLocal,activeCurrency]);

  const doRefresh=useCallback(async()=>{
    const key=Date.now();const sigs={};
    ASSETS.forEach(a=>{sigs[a.ticker]=generateSignals(a,key);});
    try{
      const[liveData,liveFx]=await Promise.all([fetchLivePrices(ASSETS.map(a=>a.ticker)),fetchFxRates()]);
      if(liveFx)setFxRates(liveFx);
      if(liveData){let cnt=0;ASSETS.forEach(a=>{if(sigs[a.ticker]){const m=mergeLiveData(sigs[a.ticker],liveData,a);sigs[a.ticker]=m;if(m.livePrice)cnt++;}});setLiveCount(cnt);}
    }catch(e){}
    setAllSigs(sigs);setLastUpdated(new Date().toLocaleTimeString("en-GB"));setLoading(false);
  },[]);
  useEffect(()=>{doRefresh();},[]);
  useEffect(()=>{const t=setInterval(doRefresh,30000);return()=>clearInterval(t);},[]);

  useEffect(()=>{
    setWatchItems(prev=>prev.map(w=>{
      if(w.status==="watching"&&Date.now()>=w.expiresAt){
        const actualPrice=allSigs[w.ticker]?.price||w.entryPrice;
        const actualChg=((actualPrice-w.entryPrice)/w.entryPrice)*100;
        return{...w,status:"expired",actualPrice,actualChg:parseFloat(actualChg.toFixed(2)),dirCorrect:(w.predictedChg>0&&actualChg>0)||(w.predictedChg<0&&actualChg<0),accuracy:Math.max(0,100-Math.abs(actualChg-w.predictedChg)*3)};
      }
      return w;
    }));
  },[tick,allSigs]);

  const portfolioStats=useMemo(()=>{
    let invested=0,currentVal=0;
    trades.filter(t=>t.status==="open").forEach(t=>{const cp=allSigs[t.ticker]?toLocal(allSigs[t.ticker].price):t.entryPrice;invested+=t.totalCost;currentVal+=cp*t.shares;});
    return{invested,currentVal,unrealised:currentVal-invested,openCount:trades.filter(t=>t.status==="open").length};
  },[trades,allSigs,toLocal]);

  const accuracy=useMemo(()=>calcAccuracy(trades,watchItems),[trades,watchItems]);

  const placeTrade=useCallback((td)=>{setTrades(p=>[...p,td]);setBalance(p=>parseFloat((p-td.totalCost).toFixed(2)));},[]);
  const closeTrade=useCallback((id)=>{
    setTrades(p=>p.map(t=>{
      if(t.id!==id)return t;
      const cp=allSigs[t.ticker]?toLocal(allSigs[t.ticker].price):t.entryPrice;
      const proceeds=cp*t.shares,pnl=proceeds-t.totalCost,pnlPct=(pnl/t.totalCost)*100;
      setBalance(prev=>parseFloat((prev+proceeds).toFixed(2)));
      return{...t,status:"closed",finalPrice:cp,finalPnL:parseFloat(pnl.toFixed(2)),finalPnLPct:parseFloat(pnlPct.toFixed(2)),closedAt:Date.now()};
    }));
  },[allSigs,toLocal]);

  const filtered=useMemo(()=>ASSETS.filter(a=>{
    if(!allSigs[a.ticker])return false;
    if(activeSector!=="All"&&a.sector!==activeSector)return false;
    if(activeCap!=="All"&&a.cap!==activeCap)return false;
    if(searchQ&&!a.ticker.toLowerCase().includes(searchQ.toLowerCase())&&!a.name.toLowerCase().includes(searchQ.toLowerCase()))return false;
    return true;
  }).sort((a,b)=>{
    const sa=allSigs[a.ticker],sb=allSigs[b.ticker];
    if(sortMode==="bestTF")return sb.tfScores[sb.bestTF]-sa.tfScores[sa.bestTF];
    if(sortMode==="score")return sb.score-sa.score;
    if(sortMode==="rr")return parseFloat(sb.rrRatio)-parseFloat(sa.rrRatio);
    if(sortMode==="price_asc")return sa.price-sb.price;
    if(sortMode==="change")return(sb.changePct||0)-(sa.changePct||0);
    return 0;
  }),[allSigs,activeSector,activeCap,searchQ,sortMode]);

  if(loading) return(<div style={{height:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}}><div style={{width:40,height:40,border:"3px solid #1a1a2e",borderTop:"3px solid #00b0ff",borderRadius:"50%",animation:"spin 1s linear infinite"}}/><div style={{fontSize:11,color:"#3a3a55",letterSpacing:2}}>LOADING MARKET DATA...</div></div>);

  const sym=activeCurrency.symbol;
  const totalPnL=balance-startBalance+portfolioStats.unrealised;
  const openTrades=trades.filter(t=>t.status==="open");
  const closedTrades=trades.filter(t=>t.status!=="open");
  const watchingCount=watchItems.filter(w=>w.status==="watching").length;

  return(
    <div style={{height:"100vh",display:"flex",flexDirection:"column",overflow:"hidden"}}>
      {/* MODALS */}
      {showCurrModal&&(<Modal onClose={()=>setShowCurrModal(false)} maxWidth={340}>
        <div style={{background:"#0a0a16",borderBottom:"1px solid #00b0ff33",padding:"14px 16px",borderRadius:"12px 12px 0 0",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:17,fontWeight:700,color:"#dde0ff"}}>Select Currency</div>
          <button onClick={()=>setShowCurrModal(false)} style={{background:"none",border:"none",color:"#444",fontSize:16}}>Ã—</button>
        </div>
        <div style={{padding:8,maxHeight:380,overflowY:"auto"}}>
          {CURRENCIES.map(c=>{const isA=c.code===activeCurrency.code;return(<div key={c.code} onClick={()=>{setActiveCurrency(c);setShowCurrModal(false);}} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 12px",borderRadius:7,cursor:"pointer",background:isA?"#00b0ff18":"transparent",border:`1px solid ${isA?"#00b0ff44":"transparent"}`,marginBottom:3}}><span style={{fontSize:20}}>{c.flag}</span><div style={{flex:1}}><div style={{fontSize:12,fontWeight:700,color:isA?"#00b0ff":"#dde0ff",fontFamily:"monospace"}}>{c.code} <span style={{color:"#4a4a6a",fontSize:10,fontFamily:"inherit"}}>{c.name}</span></div></div><span style={{fontSize:14,fontWeight:700,color:isA?"#00b0ff":"#6a6a8a",fontFamily:"monospace"}}>{c.symbol}</span>{isA&&<span style={{color:"#00b0ff"}}>âœ“</span>}</div>);})}
        </div>
      </Modal>)}
      {showBudget&&(<Modal onClose={()=>setShowBudget(false)} maxWidth={320}>
        <div style={{padding:20}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:17,fontWeight:700,color:"#dde0ff",marginBottom:6}}>SET VIRTUAL BUDGET</div>
          <div style={{fontSize:9,color:"#3a3a55",marginBottom:12}}>Resets all trades and watchlist.</div>
          <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:10}}>{["500","1000","5000","10000","25000","50000"].map(v=>(<button key={v} onClick={()=>setBudgetInput(v)} style={{background:budgetInput===v?"#00b0ff22":"#0a0a16",border:`1px solid ${budgetInput===v?"#00b0ff":"#1a1a2e"}`,borderRadius:5,padding:"4px 10px",color:budgetInput===v?"#00b0ff":"#5a5a7a",fontSize:9}}>{sym}{v}</button>))}</div>
          <input value={budgetInput} onChange={e=>setBudgetInput(e.target.value)} style={{width:"100%",background:"#0e0e1c",border:"1px solid #1a1a2e",borderRadius:5,padding:"7px",color:"#c0c0e0",fontSize:13,marginBottom:12}}/>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <button onClick={()=>setShowBudget(false)} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:6,padding:"8px",color:"#4a4a6a",fontSize:9}}>CANCEL</button>
            <button onClick={()=>{const v=parseFloat(budgetInput)||1000;setBalance(v);setStartBalance(v);setTrades([]);setWatchItems([]);setShowBudget(false);}} style={{background:"#00b0ff22",border:"1px solid #00b0ff",borderRadius:6,padding:"8px",color:"#00b0ff",fontSize:9}}>CONFIRM</button>
          </div>
        </div>
      </Modal>)}
      {showTradeModal&&selected&&allSigs[selected.ticker]&&(<TradeModal asset={selected} sig={allSigs[selected.ticker]} balance={balance} fmtMoney={fmtMoney} toLocal={toLocal} onPlace={placeTrade} onClose={()=>setShowTradeModal(false)}/>)}
      {showWatchModal&&selected&&allSigs[selected.ticker]&&(<WatchModal asset={selected} sig={allSigs[selected.ticker]} fmtMoney={fmtMoney} toLocal={toLocal} balance={balance} onAdd={w=>setWatchItems(p=>[...p,w])} onPlace={placeTrade} onClose={()=>setShowWatchModal(false)}/>)}

      {/* HEADER */}
      <div style={{borderBottom:"1px solid #0c0c18",padding:"7px 14px",display:"flex",alignItems:"center",gap:8,flexShrink:0,background:"#03030a",flexWrap:"wrap"}}>
        <div>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:18,fontWeight:900,letterSpacing:3,color:"#dde0ff"}}>MARKET <span style={{color:"#00b0ff"}}>BRAIN</span></div>
          <div style={{fontSize:7,color:"#2a2a40",letterSpacing:1}}>Hi, {user.name} {saving&&<span style={{color:"#3a3a55"}}>Â· saving...</span>}</div>
        </div>
        <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>
          {[{l:"CASH",v:fmtMoney(toLocal(balance)),c:"#00b0ff"},{l:"INVESTED",v:fmtMoney(toLocal(portfolioStats.invested)),c:"#ffd600"},{l:"UNREALISED",v:fmtPct(portfolioStats.invested>0?portfolioStats.unrealised/portfolioStats.invested*100:0),c:pnlColor(portfolioStats.unrealised)},{l:"TOTAL P&L",v:`${totalPnL>=0?"+":""}${fmtMoney(toLocal(totalPnL))}`,c:pnlColor(totalPnL)}].map(m=>(<div key={m.l} style={{background:"#0a0a16",border:"1px solid #12121e",borderRadius:4,padding:"3px 7px",textAlign:"center"}}><div style={{fontSize:6,color:"#2a2a40",letterSpacing:1}}>{m.l}</div><div style={{fontSize:10,color:m.c,fontWeight:700,fontFamily:"monospace"}}>{m.v}</div></div>))}
          {accuracy&&<div style={{background:"#0a0a16",border:`1px solid ${accuracy.overall>=60?"#00e676":"#ff6d00"}33`,borderRadius:4,padding:"3px 7px",textAlign:"center",cursor:"pointer"}} onClick={()=>setView("accuracy")}><div style={{fontSize:6,color:"#2a2a40",letterSpacing:1}}>ACCURACY</div><div style={{fontSize:10,color:accuracy.overall>=60?"#00e676":"#ff6d00",fontWeight:700,fontFamily:"monospace"}}>{accuracy.overall.toFixed(0)}%</div></div>}
        </div>
        <div style={{marginLeft:"auto",display:"flex",gap:5,alignItems:"center"}}>
          <div style={{fontSize:8,color:liveCount>0?"#00e676":"#3a3a50"}}>â— {liveCount} LIVE</div>
          <button onClick={()=>setShowCurrModal(true)} style={{background:"#0a0a16",border:"1px solid #00b0ff44",borderRadius:5,padding:"4px 9px",display:"flex",alignItems:"center",gap:4}}><span style={{fontSize:13}}>{activeCurrency.flag}</span><span style={{fontSize:9,color:"#00b0ff",fontWeight:700}}>{activeCurrency.code}</span></button>
          <button onClick={()=>setShowBudget(true)} style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:5,padding:"4px 8px",color:"#ffd600",fontSize:8}}>ðŸ’° {sym}{balance.toFixed(0)}</button>
          <button onClick={doRefresh} style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:5,padding:"4px 8px",color:"#5a5a8a",fontSize:11}}>â†»</button>
          <button onClick={async()=>{await api("/api/auth/logout",{method:"POST"});localStorage.removeItem("mb_token");onLogout();}} style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:5,padding:"4px 8px",color:"#5a5a7a",fontSize:8}}>LOG OUT</button>
        </div>
      </div>

      {/* NAV */}
      <div style={{borderBottom:"1px solid #0c0c18",padding:"0 14px",display:"flex",flexShrink:0,background:"#04040c"}}>
        {[["market","ðŸ“Š Market"],["portfolio",`ðŸ’¼ Portfolio${openTrades.length>0?" ("+openTrades.length+")":""}`],["watchlist",`â˜… Watch${watchingCount>0?" ("+watchingCount+")":""}`],["accuracy","ðŸŽ¯ Accuracy"]].map(([v,l])=>(<button key={v} onClick={()=>setView(v)} style={{background:"transparent",border:"none",borderBottom:`2px solid ${view===v?"#00b0ff":"transparent"}`,padding:"9px 14px",color:view===v?"#00b0ff":"#3a3a55",fontSize:9,letterSpacing:1,whiteSpace:"nowrap"}}>{l}</button>))}
      </div>

      {/* MARKET */}
      {view==="market"&&(
        <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{borderBottom:"1px solid #0c0c18",padding:"6px 12px",background:"#04040c",flexShrink:0}}>
            <div style={{display:"flex",gap:4,flexWrap:"wrap",alignItems:"center",marginBottom:4}}>
              <input value={searchQ} onChange={e=>setSearchQ(e.target.value)} placeholder="search..." style={{background:"#0a0a16",border:"1px solid #1a1a2e",borderRadius:4,padding:"3px 7px",color:"#8a8aaa",fontSize:9,width:90}}/>
              {CAPS.map(c=>(<Pill key={c} label={c} active={activeCap===c} color={CAP_COLORS[c]||"#00b0ff"} onClick={()=>setActiveCap(c)}/>))}
            </div>
            <div style={{display:"flex",gap:4,flexWrap:"wrap",alignItems:"center"}}>
              {SECTORS.map(s=>(<Pill key={s} label={s==="All"?"ALL":s.slice(0,7).toUpperCase()} active={activeSector===s} onClick={()=>setActiveSector(s)}/>))}
              <div style={{marginLeft:"auto",display:"flex",gap:3}}>
                {[["bestTF","Best"],["score","Score"],["rr","R/R"],["price_asc","Cheap"],["change","Movers"]].map(([v,l])=>(<Pill key={v} label={l} active={sortMode===v} onClick={()=>setSortMode(v)}/>))}
              </div>
            </div>
          </div>
          <div style={{flex:1,display:"grid",gridTemplateColumns:selected?"1fr 380px":"1fr",overflow:"hidden",minHeight:0}}>
            {/* GRID */}
            <div style={{overflowY:"auto",padding:10}}>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(162px,1fr))",gap:6}}>
                {filtered.map(a=>{
                  const sig=allSigs[a.ticker];if(!sig)return null;
                  const R=RISK_CFG[sig.risk],bP=TF_PROFILES[sig.bestTF],bS=sig.tfScores[sig.bestTF];
                  const pc=bS>=72?"#00e676":bS>=52?"#00d4ff":bS>=35?"#ffd600":"#ff6d00";
                  const isSel=selected?.ticker===a.ticker;
                  return(<div key={a.ticker} onClick={()=>setSelected(isSel?null:a)}
                    style={{background:isSel?R.bg:"#07070f",border:`1px solid ${isSel?R.color:"#12121e"}`,borderRadius:7,padding:"9px 10px",cursor:"pointer",position:"relative",overflow:"hidden"}}
                    onMouseEnter={e=>{if(!isSel)e.currentTarget.style.borderColor=R.color+"66";}}
                    onMouseLeave={e=>{if(!isSel)e.currentTarget.style.borderColor="#12121e";}}>
                    <div style={{position:"absolute",top:0,left:0,right:0,height:2,background:R.color}}/>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:2}}>
                      <span style={{fontSize:12,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{a.ticker}</span>
                      <div style={{display:"flex",gap:3,alignItems:"center"}}>{sig.livePrice&&<span style={{fontSize:6,color:"#00e676"}}>â—</span>}<Tag color={R.color} small>{R.label}</Tag></div>
                    </div>
                    <div style={{fontSize:8,color:"#2a2a3a",marginBottom:4}}>{a.name}</div>
                    <Sparkline asset={a} sig={sig} height={28}/>
                    <div style={{background:bP.color+"18",border:`1px solid ${bP.color}33`,borderRadius:4,padding:"3px 6px",marginTop:4,marginBottom:4,display:"flex",justifyContent:"space-between"}}>
                      <span style={{fontSize:8,color:bP.color}}>{bP.icon} {bP.short}</span>
                      <span style={{fontSize:9,color:pc,fontWeight:700,fontFamily:"monospace"}}>{bS.toFixed(0)}%</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <span style={{fontSize:10,color:"#b0b0cc",fontFamily:"monospace"}}>{fmtMoney(sig.price)}</span>
                      {sig.changePct!==0&&<span style={{fontSize:8,color:pnlColor(sig.changePct),fontFamily:"monospace"}}>{fmtPct(sig.changePct)}</span>}
                    </div>
                  </div>);
                })}
              </div>
            </div>
            {/* DETAIL PANEL */}
            {selected&&allSigs[selected.ticker]&&(()=>{
              const sig=allSigs[selected.ticker],R=RISK_CFG[sig.risk];
              const inWatch=watchItems.some(w=>w.ticker===selected.ticker&&w.status==="watching");
              return(<div style={{borderLeft:"1px solid #0c0c18",overflowY:"auto",padding:14,background:"#04040c",display:"flex",flexDirection:"column",gap:10}}>
                {/* Header */}
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div>
                    <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:700,color:"#dde0ff"}}>{selected.ticker}</div>
                    <div style={{fontSize:9,color:"#3a3a55"}}>{selected.name} Â· {selected.sub}</div>
                    <div style={{display:"flex",gap:4,marginTop:3,flexWrap:"wrap"}}><Tag color={CAP_COLORS[selected.cap]}>{selected.cap} Cap</Tag><Tag color="#5a5a8a">{selected.sector}</Tag></div>
                  </div>
                  <div style={{textAlign:"right"}}>
                    <div style={{fontSize:17,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{fmtMoney(sig.price)}</div>
                    {sig.changePct!==0&&<div style={{fontSize:10,color:pnlColor(sig.changePct),fontFamily:"monospace"}}>{fmtPct(sig.changePct)}</div>}
                    <div style={{marginTop:3,display:"flex",gap:3,justifyContent:"flex-end"}}>{sig.livePrice?<Tag color="#00e676">â— LIVE</Tag>:<Tag color="#3a3a55">SIM</Tag>}<Tag color={R.color}>{R.label}</Tag></div>
                  </div>
                </div>
                {/* Sparkline detail */}
                <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:7,padding:"8px 10px"}}>
                  <div style={{fontSize:7,color:"#2a2a40",letterSpacing:2,marginBottom:4}}>30-DAY PRICE HISTORY {sig.livePrice?"(live-anchored)":"(simulated)"}</div>
                  <Sparkline asset={selected} sig={sig} height={60}/>
                </div>
                {/* TF Alignment */}
                <div style={{background:"#0a0a16",borderRadius:6,padding:10}}>
                  <div style={{fontSize:7,color:"#2a2a40",letterSpacing:2,marginBottom:8}}>TIMEFRAME ALIGNMENT</div>
                  {TF_KEYS.map(k=>{const p=TF_PROFILES[k],sc=sig.tfScores[k];const pc=sc>=72?"#00e676":sc>=52?"#00d4ff":sc>=35?"#ffd600":"#ff6d00";return(<div key={k} style={{marginBottom:5}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><div style={{display:"flex",gap:4,alignItems:"center"}}><span style={{fontSize:9}}>{p.icon}</span><span style={{fontSize:8,color:sig.bestTF===k?p.color:"#5a5a7a",fontWeight:sig.bestTF===k?"700":"normal"}}>{p.short}</span>{sig.bestTF===k&&<Tag color={p.color} small>BEST</Tag>}</div><span style={{fontSize:9,color:pc,fontWeight:700,fontFamily:"monospace"}}>{sc.toFixed(0)}%</span></div><div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${sc}%`,height:"100%",background:`linear-gradient(90deg,${pc}66,${pc})`,borderRadius:2}}/></div></div>);})}
                </div>
                {/* Stats */}
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:5}}>
                  <Stat label="R/R" value={`${sig.rrRatio}:1`} color={parseFloat(sig.rrRatio)>=2?"#00e676":"#ffd600"}/>
                  <Stat label="UPSIDE" value={`+${sig.upsidePct}%`} color="#00e676"/>
                  <Stat label="STOP" value={`-${sig.stopPct}%`} color="#ff1744"/>
                  <Stat label="ENTRY Q" value={sig.entryQ} color={sig.entryQ==="IDEAL"?"#00e676":sig.entryQ==="GOOD"?"#00b0ff":sig.entryQ==="FAIR"?"#ffd600":"#ff6d00"}/>
                  <Stat label="RSI" value={sig.metrics.rsi.toFixed(0)} color={sig.metrics.rsi<30?"#00e676":sig.metrics.rsi>70?"#ff1744":"#c0c0e0"}/>
                  <Stat label="VOL x" value={sig.metrics.volume.toFixed(1)+"x"} color={sig.metrics.volume>1.5?"#00d4ff":"#c0c0e0"}/>
                </div>
                {/* Knowledge panel */}
                <KnowledgePanel asset={selected}/>
                {/* Actions */}
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:7}}>
                  <button onClick={()=>setShowWatchModal(true)} style={{background:inWatch?"#ffd60011":"#ffd60022",border:`1px solid ${inWatch?"#ffd60066":"#ffd600"}`,borderRadius:6,padding:"9px",color:"#ffd600",fontSize:9,letterSpacing:1}}>{inWatch?"â˜… WATCHING":"â˜… WATCH"}</button>
                  <button onClick={()=>setShowTradeModal(true)} disabled={balance<toLocal(sig.price)} style={{background:balance>=toLocal(sig.price)?R.color+"22":"#1a1a2e",border:`1px solid ${balance>=toLocal(sig.price)?R.color:"#2a2a40"}`,borderRadius:6,padding:"9px",color:balance>=toLocal(sig.price)?R.color:"#3a3a50",fontSize:9,letterSpacing:1}}>ðŸ“ˆ TRADE</button>
                </div>
                <div style={{fontSize:7,color:"#1a1a28",textAlign:"center"}}>Virtual simulation only. Not financial advice.</div>
              </div>);
            })()}
          </div>
        </div>
      )}

      {/* PORTFOLIO */}
      {view==="portfolio"&&(
        <div style={{flex:1,overflowY:"auto",padding:12}}>
          <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:16}}>
            <Stat label="CASH" value={fmtMoney(toLocal(balance))} color="#00b0ff"/>
            <Stat label="INVESTED" value={fmtMoney(toLocal(portfolioStats.invested))} color="#ffd600"/>
            <Stat label="UNREALISED" value={fmtPct(portfolioStats.invested>0?portfolioStats.unrealised/portfolioStats.invested*100:0)} color={pnlColor(portfolioStats.unrealised)} sub={`${portfolioStats.unrealised>=0?"+":""}${fmtMoney(toLocal(portfolioStats.unrealised))}`}/>
            <Stat label="TOTAL P&L" value={`${totalPnL>=0?"+":""}${fmtMoney(toLocal(totalPnL))}`} color={pnlColor(totalPnL)}/>
          </div>
          <div style={{fontSize:9,color:"#00e676",letterSpacing:2,marginBottom:8}}>OPEN POSITIONS ({openTrades.length})</div>
          {openTrades.length===0&&<div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:7,padding:16,textAlign:"center",color:"#3a3a55",fontSize:10,marginBottom:16}}>No open positions.</div>}
          {openTrades.map(t=>{
            const cp=allSigs[t.ticker]?toLocal(allSigs[t.ticker].price):t.entryPrice;
            const pnl=(cp-t.entryPrice)*t.shares,pnlPct=((cp-t.entryPrice)/t.entryPrice)*100;
            const tfP=TF_PROFILES[t.timeframe],R=RISK_CFG[t.signalRisk];
            return(<div key={t.id} style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:12,marginBottom:7,borderLeft:`3px solid ${tfP.color}`}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                <div><div style={{display:"flex",gap:5,alignItems:"center",marginBottom:2,flexWrap:"wrap"}}><span style={{fontSize:13,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{t.ticker}</span><Tag color={tfP.color}>{tfP.icon} {tfP.short}</Tag><Tag color={R.color}>{R.label}</Tag><span style={{fontSize:8,color:"#3a3a55"}}>{t.shares} units</span></div><div style={{fontSize:8,color:"#3a3a50"}}>{t.name}</div></div>
                <button onClick={()=>closeTrade(t.id)} style={{background:"#ff174422",border:"1px solid #ff174466",borderRadius:5,padding:"5px 8px",color:"#ff1744",fontSize:8}}>CLOSE</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:5,marginBottom:6}}>
                <Stat label="ENTRY" value={`${sym}${t.entryPrice.toFixed(2)}`}/>
                <Stat label="NOW" value={`${sym}${cp.toFixed(2)}`} color={pnlColor(pnlPct)}/>
                <Stat label="P&L%" value={fmtPct(pnlPct)} color={pnlColor(pnlPct)}/>
                <Stat label="STOP" value={`-${t.stopPct}%`} color="#ff174477"/>
                <Stat label="TARGET" value={`+${t.targetPct}%`} color="#00e67677"/>
              </div>
              <div style={{display:"flex",justifyContent:"space-between"}}><div style={{fontSize:9,color:"#3a3a55"}}>Cost: {sym}{t.totalCost.toFixed(2)} Â· Signal: <span style={{color:tfP.color}}>{t.tfScore}%</span></div><div style={{fontSize:12,fontWeight:700,color:pnlColor(pnl),fontFamily:"monospace"}}>{pnl>=0?"+":"-"}{sym}{Math.abs(pnl).toFixed(2)}</div></div>
            </div>);
          })}
          {closedTrades.length>0&&(<>
            <div style={{fontSize:9,color:"#5a5a7a",letterSpacing:2,marginBottom:8,marginTop:16}}>CLOSED ({closedTrades.length})</div>
            {closedTrades.map(t=>{const tfP=TF_PROFILES[t.timeframe];return(<div key={t.id} style={{background:"#06060e",border:`1px solid ${t.finalPnLPct>0?"#00e67622":"#ff174422"}`,borderRadius:6,padding:"9px 12px",marginBottom:5,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div><div style={{display:"flex",gap:5,alignItems:"center",marginBottom:2}}><span style={{fontSize:11,fontWeight:700,color:t.finalPnLPct>0?"#00e676":"#ff1744",fontFamily:"monospace"}}>{t.ticker}</span><Tag color={tfP.color}>{tfP.icon}</Tag><Tag color={CAP_COLORS[t.cap]||"#888"} small>{t.cap}</Tag></div><div style={{fontSize:8,color:"#4a4a6a"}}>{sym}{t.entryPrice.toFixed(2)} â†’ {sym}{t.finalPrice?.toFixed(2)}</div></div>
              <div style={{textAlign:"right"}}><div style={{fontSize:13,fontWeight:700,color:pnlColor(t.finalPnL),fontFamily:"monospace"}}>{t.finalPnL>=0?"+":"-"}{sym}{Math.abs(t.finalPnL).toFixed(2)}</div><div style={{fontSize:9,color:pnlColor(t.finalPnLPct),fontFamily:"monospace"}}>{fmtPct(t.finalPnLPct)}</div></div>
            </div>);})}
          </>)}
        </div>
      )}

      {/* WATCHLIST */}
      {view==="watchlist"&&(
        <div style={{flex:1,overflowY:"auto",padding:12}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <div style={{fontSize:9,color:"#ffd600",letterSpacing:2}}>TIMED WATCHLIST ({watchItems.length})</div>
            {watchItems.length>0&&<button onClick={()=>setWatchItems(p=>p.filter(w=>w.status==="watching"))} style={{background:"transparent",border:"1px solid #2a2a40",borderRadius:5,padding:"3px 8px",color:"#4a4a6a",fontSize:8}}>CLEAR EXPIRED</button>}
          </div>
          {watchItems.length===0&&<div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:7,padding:24,textAlign:"center",color:"#3a3a55",fontSize:10}}>No items watched. Go to Market and click Watch on any asset.</div>}
          {watchItems.map(w=>{
            const tfP=TF_PROFILES[w.timeframe],now=Date.now(),pct=Math.min(100,((now-w.addedAt)/(w.expiresAt-w.addedAt))*100),expired=w.status==="expired";
            return(<div key={w.id} style={{background:"#07070f",border:`1px solid ${expired?(w.dirCorrect?"#00e67644":"#ff174444"):"#1a1a2e"}`,borderRadius:8,padding:12,marginBottom:8,position:"relative",overflow:"hidden"}}>
              {!expired&&<div style={{position:"absolute",top:0,left:0,height:2,width:`${pct}%`,background:tfP.color}}/>}
              {expired&&<div style={{position:"absolute",top:0,left:0,right:0,height:2,background:w.dirCorrect?"#00e676":"#ff1744"}}/>}
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                <div><div style={{display:"flex",gap:5,alignItems:"center",marginBottom:2}}><span style={{fontSize:13,fontWeight:700,color:"#dde0ff",fontFamily:"monospace"}}>{w.ticker}</span><Tag color={tfP.color}>{tfP.icon} {w.duration}</Tag>{expired&&<Tag color={w.dirCorrect?"#00e676":"#ff1744"}>{w.dirCorrect?"âœ“ CORRECT":"âœ— MISS"}</Tag>}{!expired&&<Tag color={tfP.color}>WATCHING</Tag>}</div><div style={{fontSize:8,color:"#3a3a50"}}>{w.name} Â· {w.sector} Â· {w.cap} Cap</div></div>
                <button onClick={()=>setWatchItems(p=>p.filter(x=>x.id!==w.id))} style={{background:"none",border:"none",color:"#333",fontSize:12}}>Ã—</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:8}}>
                <Stat label="ENTRY" value={fmtMoney(w.entryPrice)}/>
                <Stat label="PREDICTED" value={fmtMoney(w.predictedPrice)} color={w.predictedChg>0?"#00e676":"#ff1744"}/>
                <Stat label="PRED MOVE" value={fmtPct(w.predictedChg)} color={w.predictedChg>0?"#00e676":"#ff1744"}/>
                {expired?<Stat label="ACTUAL" value={fmtPct(w.actualChg)} color={pnlColor(w.actualChg)}/>:<Stat label="REMAINING" value={fmtMs(w.expiresAt-now)} color={tfP.color}/>}
              </div>
              {expired&&<div style={{background:w.dirCorrect?"#00e67610":"#ff174410",border:`1px solid ${w.dirCorrect?"#00e67644":"#ff174444"}`,borderRadius:6,padding:10}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div><div style={{fontSize:8,color:w.dirCorrect?"#00e676":"#ff1744",letterSpacing:2,marginBottom:2}}>PREDICTION RESULT</div><div style={{fontSize:10,color:"#c0c0e0"}}>{w.dirCorrect?"Direction correct âœ“":"Direction missed âœ—"} Â· Accuracy: <strong style={{color:w.dirCorrect?"#00e676":"#ff6d00"}}>{w.accuracy?.toFixed(0)}%</strong></div></div><div style={{textAlign:"right"}}><div style={{fontSize:7,color:"#2a2a40"}}>SIGNAL</div><div style={{fontSize:14,fontWeight:700,color:tfP.color,fontFamily:"monospace"}}>{w.tfScore}%</div></div></div></div>}
              {!expired&&<div><div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}><span style={{fontSize:7,color:"#3a3a50"}}>Progress</span><span style={{fontSize:7,color:tfP.color}}>{pct.toFixed(0)}% Â· {fmtMs(w.expiresAt-now)} left</span></div><div style={{height:4,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${pct}%`,height:"100%",background:tfP.color,borderRadius:2}}/></div></div>}
            </div>);
          })}
        </div>
      )}

      {/* ACCURACY */}
      {view==="accuracy"&&(
        <div style={{flex:1,overflowY:"auto",padding:12}}>
          <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:16,fontWeight:700,color:"#dde0ff",letterSpacing:2,marginBottom:12}}>PREDICTION ACCURACY REPORT</div>
          {!accuracy?(<div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:24,textAlign:"center"}}><div style={{fontSize:28,marginBottom:8}}>ðŸ“Š</div><div style={{fontSize:11,color:"#4a4a6a",lineHeight:1.8}}>No results yet. Place trades or set watchlist timers to build data.</div></div>):(
            <>
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:14}}>
                <Stat label="OVERALL WIN RATE" value={`${accuracy.overall.toFixed(0)}%`} color={accuracy.overall>=60?"#00e676":accuracy.overall>=45?"#ffd600":"#ff6d00"} sub={`${accuracy.wins}W / ${accuracy.losses}L`}/>
                <Stat label="TOTAL RESULTS" value={accuracy.total} color="#c0c0e0"/>
                <Stat label="AVG RETURN" value={fmtPct(accuracy.avgReturn)} color={pnlColor(accuracy.avgReturn)}/>
                <Stat label="GRADE" value={accuracy.overall>=70?"A":accuracy.overall>=60?"B":accuracy.overall>=50?"C":"D"} color={accuracy.overall>=60?"#00e676":"#ff6d00"}/>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:14}}>
                  <div style={{fontSize:9,color:"#2a2a40",letterSpacing:2,marginBottom:10}}>BY CAP SIZE</div>
                  {["Nano","Micro","Small","Mid","Large"].map(cap=>{
                    const d=accuracy.byCap[cap];
                    if(!d)return(<div key={cap} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #0a0a14",opacity:0.3}}><div style={{display:"flex",gap:6,alignItems:"center"}}><span style={{width:7,height:7,background:CAP_COLORS[cap],borderRadius:"50%",display:"inline-block"}}/><span style={{fontSize:9,color:"#3a3a50"}}>{cap}</span></div><span style={{fontSize:9,color:"#2a2a40"}}>No data</span></div>);
                    const c=d.rate>=60?"#00e676":d.rate>=45?"#ffd600":"#ff6d00";
                    return(<div key={cap} style={{padding:"6px 0",borderBottom:"1px solid #0a0a14"}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><div style={{display:"flex",gap:5,alignItems:"center"}}><span style={{width:7,height:7,background:CAP_COLORS[cap],borderRadius:"50%",display:"inline-block"}}/><span style={{fontSize:10,color:"#c0c0e0"}}>{cap}</span><span style={{fontSize:7,color:"#3a3a50"}}>{d.wins}W/{d.total-d.wins}L</span></div><span style={{fontSize:11,color:c,fontWeight:700,fontFamily:"monospace"}}>{d.rate.toFixed(0)}%</span></div>
                      <div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${d.rate}%`,height:"100%",background:c,borderRadius:2}}/></div>
                    </div>);
                  })}
                </div>
                <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:14}}>
                  <div style={{fontSize:9,color:"#2a2a40",letterSpacing:2,marginBottom:10}}>BY SECTOR</div>
                  {Object.entries(accuracy.bySector).sort((a,b)=>b[1].rate-a[1].rate).map(([sec,d])=>{
                    const c=d.rate>=60?"#00e676":d.rate>=45?"#ffd600":"#ff6d00";
                    return(<div key={sec} style={{padding:"5px 0",borderBottom:"1px solid #0a0a14"}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><span style={{fontSize:9,color:"#8a8aaa"}}>{sec} <span style={{color:"#3a3a50",fontSize:7}}>({d.wins}W/{d.total-d.wins}L)</span></span><span style={{fontSize:10,color:c,fontWeight:700,fontFamily:"monospace"}}>{d.rate.toFixed(0)}%</span></div>
                      <div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${d.rate}%`,height:"100%",background:c,borderRadius:2}}/></div>
                    </div>);
                  })}
                </div>
              </div>
              <div style={{background:"#07070f",border:"1px solid #1a1a2e",borderRadius:8,padding:14}}>
                <div style={{fontSize:9,color:"#2a2a40",letterSpacing:2,marginBottom:10}}>BY TIMEFRAME</div>
                {TF_KEYS.map(k=>{
                  const items=[...trades.filter(t=>t.status!=="open"&&t.timeframe===k),...watchItems.filter(w=>w.status==="expired"&&w.timeframe===k)];
                  if(!items.length)return(<div key={k} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #0a0a14",opacity:0.3}}><span style={{fontSize:9,color:"#3a3a50"}}>{TF_PROFILES[k].icon} {TF_PROFILES[k].short}</span><span style={{fontSize:9,color:"#2a2a40"}}>No data</span></div>);
                  const wins=items.filter(t=>(t.finalPnLPct||t.actualChg||0)>0).length;
                  const rate=(wins/items.length)*100,c=rate>=60?"#00e676":rate>=45?"#ffd600":"#ff6d00",p=TF_PROFILES[k];
                  return(<div key={k} style={{padding:"5px 0",borderBottom:"1px solid #0a0a14"}}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}><span style={{fontSize:9,color:p.color}}>{p.icon} {p.short} <span style={{color:"#3a3a50",fontSize:7}}>({wins}W/{items.length-wins}L)</span></span><span style={{fontSize:10,color:c,fontWeight:700,fontFamily:"monospace"}}>{rate.toFixed(0)}%</span></div>
                    <div style={{height:3,background:"#0e0e18",borderRadius:2,overflow:"hidden"}}><div style={{width:`${rate}%`,height:"100%",background:c,borderRadius:2}}/></div>
                  </div>);
                })}
              </div>
            </>
          )}
        </div>
      )}

      <div style={{borderTop:"1px solid #0e0e18",padding:"3px 14px",display:"flex",alignItems:"center",gap:10,flexShrink:0,background:"#03030a"}}>
        <span style={{fontSize:7,color:liveCount>0?"#00e676":"#3a3a50",animation:liveCount>0?"pulse 2s infinite":"none"}}>{liveCount>0?"â— LIVE":"â— SIM"}</span>
        <span style={{fontSize:7,color:"#2a2a40"}}>{liveCount} live Â· {ASSETS.length-liveCount} sim Â· auto-saves</span>
        {lastUpdated&&<span style={{fontSize:7,color:"#1a1a28",marginLeft:"auto"}}>Updated {lastUpdated}</span>}
      </div>
    </div>
  );
}

// â”€â”€ ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Root(){
  const[user,setUser]=useState(null);
  const[checking,setChecking]=useState(true);
  useEffect(()=>{
    const token=localStorage.getItem("mb_token");
    if(!token){setChecking(false);return;}
    // Token is valid for 1 year with sliding expiry â€” keep user logged in
    api("/api/auth/me").then(u=>{setUser(u);setChecking(false);}).catch(()=>{
      // Only clear token if server explicitly rejects it (401)
      localStorage.removeItem("mb_token");setChecking(false);
    });
  },[]);
  if(checking)return(<div style={{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center"}}><div style={{width:32,height:32,border:"3px solid #1a1a2e",borderTop:"3px solid #00b0ff",borderRadius:"50%",animation:"spin 1s linear infinite"}}/></div>);
  if(!user)return(<WelcomePage onAuth={u=>setUser(u)}/>);
  return(<MainApp user={user} onLogout={()=>setUser(null)}/>);
}

ReactDOM.createRoot(document.getElementById("root")).render(<Root/>);
</script>
</body>
</html>
